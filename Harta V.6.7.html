<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hartă șantier – fronturi + validări + grafice</title>
  <style>
    :root { --bg:#f3f6ff; --card:#ffffff; --ink:#0f172a; --muted:#6b7280; --accent:#2563eb; --accent-2:#7c3aed; --accent-3:#10b981; --danger:#ef4444; --line:#e5e7eb; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;background:linear-gradient(180deg,var(--bg) 0%, #ffffff 60%);color:var(--ink)}
    body.landing-mode{background:linear-gradient(180deg,rgba(37,99,235,0.18),rgba(255,255,255,0.92));color:var(--ink)}
    #landingView{display:flex;flex-direction:column;min-height:100vh;width:100%}
    body:not(.landing-mode) #landingView{display:none}
    body.landing-mode #appShell{display:none}
    body:not(.landing-mode) #appShell{display:block}
    .landingHeader{padding:16px clamp(24px,4vw,40px) 24px;color:#fff;background:radial-gradient(circle at top left,rgba(37,99,235,.82),rgba(15,23,42,.95));display:flex;flex-direction:column;gap:12px;align-items:center;text-align:center;width:100%}
    .landingHeaderTop{width:100%;max-width:960px;margin:0 auto;display:flex;align-items:center;justify-content:flex-end;gap:12px;flex-wrap:wrap}
    .landingHeaderText{display:flex;flex-direction:column;gap:8px;max-width:520px;align-items:center;text-align:center;margin:0 auto}
    .landingHeader h1{margin:0;font-size:28px;font-weight:700}
    .landingHeader p{margin:0;color:rgba(255,255,255,.82);font-size:15px;max-width:620px}
    .landingHeaderMeta{font-size:14px;color:rgba(255,255,255,.9);text-align:right;line-height:1.4;min-width:180px;margin-left:auto}
    .landingMain{flex:1;padding:48px clamp(24px,4vw,64px) 72px;width:100%;display:flex;flex-direction:column;gap:32px;margin:0 auto;max-width:none}
    .landingFooter{padding:16px 32px;text-align:center;color:var(--muted);font-size:13px}
    @media (max-width:640px){
      .landingHeader{padding:20px clamp(16px,6vw,32px);}
      .landingHeaderTop{flex-direction:column;align-items:center;gap:12px;text-align:center}
      .landingHeaderMeta{text-align:center;margin-left:0}
    }
    .app{width:100%;max-width:none;margin:0;padding:16px 24px 72px;min-height:100vh}
    .grid{display:grid;grid-template-columns:minmax(0,1.8fr) minmax(0,1fr);gap:24px;align-items:stretch;min-height:calc(100vh - 96px)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 6px 20px rgba(37,99,235,.08);display:flex;flex-direction:column;min-height:0}
    .card h2{margin:0;padding:12px 14px;font-size:16px;border-bottom:1px solid var(--line);display:flex;gap:12px;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .subtitle{font-size:12px;color:var(--muted);font-weight:500}
    .card .content{flex:1;display:flex;flex-direction:column;padding:12px 14px;min-height:0;overflow:hidden}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
    button{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer;transition:transform .06s ease, box-shadow .2s ease, background .2s ease}
    button:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(0,0,0,.06)}
    button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    button.primary:hover{box-shadow:0 8px 20px rgba(37,99,235,.25)}
    button.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
    button.ghost{background:transparent}
    button.ghost:hover{background:rgba(37,99,235,.08)}
    button:disabled{opacity:.6;cursor:not-allowed}
    input[type="date"], .roleInput{padding:8px 10px;border:1px solid var(--line);border-radius:10px}

    .alert{display:none;margin-bottom:10px;padding:10px 12px;border:1px solid #fecaca;background:#fef2f2;color:#991b1b;border-radius:10px;font-size:13px}
    .alert.show{display:flex;gap:8px;align-items:center}

    /* ZONE GRID */
    .zonesWrap{display:grid;grid-template-columns:1fr 1fr;gap:28px;padding:8px}
    .zoneBox{border:2px solid #111;border-radius:8px;min-height:110px;background:linear-gradient(180deg,#f8fbff, #f8fafc);position:relative;display:flex;flex-direction:column}
    .zoneBox.active{outline:3px solid var(--accent);}
    .zoneHeader{font-weight:600;font-size:14px;padding:8px 10px;background:linear-gradient(90deg, rgba(37,99,235,.08), rgba(37,99,235,0)); border-bottom:1px solid var(--line)}
    .zoneList{flex:1;padding:6px 10px 12px 10px;display:flex;flex-direction:column;gap:8px}

    .personRow{display:flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 8px}
    .personRow.inactive{opacity:.55}
    .personRow.dup{border-color:#ef4444;box-shadow:0 0 0 2px #fee2e2 inset}
    .personRow.selected{border-color:var(--accent);box-shadow:0 0 0 2px rgba(37,99,235,.25)}
    .bullet{width:11px;height:11px;border-radius:999px;border:2px solid #111;background:#fff;display:inline-block}
    .role{font-size:11px;color:#111;padding:2px 6px;border-radius:999px;border:1px solid var(--line);background:linear-gradient(180deg,#fff, #f7f8ff)}
    .status{font-size:10px;color:#111;padding:1px 6px;border-radius:999px;border:1px dashed var(--line);background:#fff}
    .dragGhost{opacity:.6}

    /* RIGHT PANEL TABS */
    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--line);padding:0 14px;align-items:center}
    .tab{border:none;background:transparent;padding:10px 12px;cursor:pointer;border-bottom:2px solid transparent}
    .tab.active{background:linear-gradient(180deg, rgba(37,99,235,.12), rgba(37,99,235,0)); border-bottom-color:var(--accent);color:#0f172a;font-weight:600}
    .tabPanel{display:none;flex-direction:column;min-height:0;overflow:auto}
    .tabPanel.active{display:flex}
    .leftCard .content{display:flex;flex-direction:column}
    #zonesWrap{flex:1;overflow:auto}
    .rightCard .content{display:flex;flex-direction:column}
    .settingsWrapper{position:relative}
    button.settingsBtn{display:flex;align-items:center;justify-content:center;font-size:16px}
    button.settingsBtn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .settingsMenu{display:none;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 12px 24px rgba(15,23,42,.08);padding:12px;flex-direction:column;gap:8px;margin-bottom:12px}
    .settingsMenu.open{display:flex}
    .settingsMenu label{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--ink);padding:6px 8px;border-radius:8px;cursor:pointer}
    .settingsMenu label:hover{background:rgba(37,99,235,.08)}
    .settingsMenu input[type="checkbox"]{width:auto;margin:0}
    .settingsSection{display:flex;flex-direction:column;gap:4px;padding:4px 0;border-top:1px solid var(--line)}
    .settingsSection:first-of-type{border-top:none;padding-top:0}
    .settingsTitle{font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.03em;padding:0 8px}
    button.settingsAction{border:none;background:rgba(37,99,235,.08);color:var(--accent);border-radius:8px;padding:6px 8px;font-size:12px;display:flex;align-items:center;gap:6px;justify-content:flex-start}
    button.settingsAction:hover{background:rgba(37,99,235,.12)}
    .settingsSubpanel{display:none;flex-direction:column;gap:4px;padding:8px 10px;background:#f8fafc;border-radius:10px}
    .settingsSubpanel.open{display:flex}
    .settingsTimings{gap:10px}
    .settingsTimings label{display:flex;flex-direction:column;gap:4px;font-size:12px;color:#1f2937}
    .settingsTimings label span{font-weight:600;color:#1e3a8a}
    .settingsTimings label input{width:110px}
    .settingsTimings small{color:var(--muted);font-size:11px}
    #roleManager{display:none;flex-direction:column;gap:6px;border:1px solid var(--line);border-radius:10px;padding:8px;background:#f8fafc}
    #roleManager.open{display:flex}
    #roleManager .subtitle{margin:0;font-size:12px;color:var(--muted)}
    #roleList{display:flex;flex-wrap:wrap;gap:8px}

    label{font-size:12px;color:var(--muted)}
    input,select{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff}
    .list{display:flex;flex-direction:column;gap:8px;max-height:260px;overflow:auto}
    .muted{color:var(--muted)}
    .stats ul{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px}
    .stats li{display:flex;justify-content:space-between;border:1px solid var(--line);border-radius:10px;padding:6px 10px;background:#fff}
    .footer{display:flex;gap:8px;justify-content:space-between;margin-top:10px;align-items:center}
    .footerNotes{display:flex;align-items:center;gap:4px;flex-wrap:wrap;justify-content:flex-end}
    input.personSearchInput{width:190px}
    input.personSearchInput.has-query{border-color:#f59e0b}
    input.personSearchInput.not-found{border-color:var(--danger);box-shadow:0 0 0 2px rgba(239,68,68,.2)}

    /* Pools */
    .unassignedWrap{margin-top:8px;border:1px dashed var(--line);border-radius:10px;background:#fcfcff}
    .unassignedHeader{display:flex;align-items:center;gap:8px;padding:8px 10px}
    .pool{padding:8px 10px;display:flex;flex-direction:column;gap:8px;max-height:200px;overflow:auto}
    .pool.empty{color:var(--muted);font-size:12px}
    .poolDroppable{min-height:40px}
    .personRow.search-hit{background:#fef3c7;border-color:#f59e0b;box-shadow:0 0 0 2px rgba(245,158,11,.45)}
    .zoneBox.search-hit{border-color:#f59e0b;box-shadow:0 0 0 3px rgba(245,158,11,.3)}
    .unassignedWrap.search-hit{border-color:#f59e0b;background:linear-gradient(180deg,#fff7ed,#ffffff)}
    .unassignedHeader button.search-hit{background:rgba(245,158,11,.16);border-color:rgba(245,158,11,.2);color:#92400e}

    /* Charts */
    .chartWrap{padding:12px 14px;flex:1;display:flex}
    svg.chart{width:100%;height:100%;min-height:260px;border:1px solid var(--line);border-radius:12px;background:#f8fafc;flex:1}

    /* FULL CHART MODE */
    .chart-mode .grid{grid-template-columns:1fr}
    .chart-mode .leftCard{display:none}
    .chart-mode .rightCard{grid-column:1 / -1}
    .chart-mode svg.chart{height:calc(100vh - 220px)}

    /* FULL TASKS MODE */
    .tasks-mode .grid{grid-template-columns:1fr}
    .tasks-mode .leftCard{display:none}
    .tasks-mode .rightCard{grid-column:1 / -1}
    .tasks-mode #tab-tasks{min-height:calc(100vh - 220px)}

    /* FULL REPORTS MODE */
    .reports-mode .grid{grid-template-columns:1fr}
    .reports-mode .leftCard{display:none}
    .reports-mode .rightCard{grid-column:1 / -1}
    .reports-mode #tab-reports{min-height:calc(100vh - 220px)}

    /* Dashboard */
    .dashboardAnimationRow{display:grid;grid-template-columns:minmax(0,2fr) minmax(0,1.2fr);gap:32px;align-items:stretch;width:100%}
    .dashboardCardsColumn{min-width:0;display:flex;width:100%}
    .dashboardDetailColumn{min-width:0;display:flex;width:100%;flex-direction:column;gap:16px;align-items:stretch}
    @media (max-width:1100px){
      .dashboardAnimationRow{grid-template-columns:1fr}
    }
    .dashboardCards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;width:100%}
    .dashboardCard{position:relative;background:#fff;border:1px solid rgba(37,99,235,.18);border-radius:12px;padding:12px 14px;box-shadow:0 12px 24px rgba(37,99,235,.08);display:flex;flex-direction:column;gap:6px;transition:box-shadow .35s ease, border-color .35s ease;cursor:pointer;transform:none}
    .dashboardCard.is-active{border-color:var(--accent);box-shadow:0 12px 24px rgba(37,99,235,.08)}
    .dashboardCard:focus-visible{outline:3px solid rgba(37,99,235,.45);outline-offset:3px}
    .dashboardCard--today{background:#ecfdf5;border-color:#bbf7d0;box-shadow:0 14px 30px rgba(16,185,129,.18)}
    .dashboardCard--today .dashboardCardTitle{color:#047857}
    .dashboardCardTitle{font-size:11px;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);font-weight:600}
    .dashboardCardValue{font-size:26px;font-weight:700;color:var(--ink)}
    .dashboardCardHint{font-size:12px;color:var(--muted)}
    .dashboardCardBreakdown{display:flex;flex-direction:column;gap:2px;margin-top:4px}
    .dashboardCardBreakdownRow{display:flex;align-items:center;justify-content:space-between;font-size:13px}
    .dashboardCardBreakdownRow .label{color:var(--muted);font-weight:600}
    .dashboardCardBreakdownRow .value{color:var(--ink);font-weight:700;font-variant-numeric:tabular-nums}
    .dashboardDetails{background:#fff;border:1px solid var(--line);border-radius:12px;padding:16px;box-shadow:0 12px 24px rgba(15,23,42,.08);display:flex;flex-direction:column;gap:12px;width:100%}
    .dashboardDetailsHeader{display:flex;align-items:center;justify-content:flex-start;gap:12px;flex-wrap:wrap}
    .dashboardDetailsTitle{margin:0;font-size:16px;color:#1e3a8a}
    .dashboardDetailsPlaceholder{font-size:13px;color:var(--muted)}
    .dashboardDetailsBody{display:flex;flex-direction:column;gap:8px}
    .dashboardDetailsSection{display:flex;flex-direction:column;gap:8px}
    .dashboardDetailsRow{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:8px 10px;border:1px solid var(--line);border-radius:12px;background:#f8fafc;font-size:13px}
    .dashboardDetailsRow .label{font-weight:600;color:#1f2937;flex:1;min-width:0}
    .dashboardDetailsRow .value{display:flex;flex-direction:column;align-items:flex-end;gap:4px;color:#0f172a;font-variant-numeric:tabular-nums;text-align:right}
    .dashboardDetailsRow .value .meta{font-size:12px;color:var(--muted)}
    .dashboardDetailsRow .value .meta div{line-height:1.3}
    .dashboardDetailsRow.stacked{flex-direction:column;align-items:flex-start}
    .dashboardDetailsRow.stacked .value{align-items:flex-start;text-align:left;width:100%}
    .dashboardDetailsEmpty{font-size:12px;color:var(--muted)}
    button.dashboardBackButton{display:inline-flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--accent);color:var(--accent);border-radius:999px;padding:8px 14px;font-size:12px;font-weight:600;box-shadow:0 6px 16px rgba(37,99,235,.12)}
    button.dashboardBackButton:hover{background:rgba(37,99,235,.08)}
    button.dashboardBackButton:focus-visible{outline:3px solid rgba(37,99,235,.35);outline-offset:3px}
    .dashboardActions{display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-start;position:relative;z-index:20;pointer-events:auto}
    .dashboardAction{border:1px solid transparent;border-radius:12px;padding:12px 20px;font-size:13px;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;pointer-events:auto;box-shadow:0 6px 16px rgba(15,23,42,.1);min-width:180px;transition:transform .2s ease, box-shadow .2s ease}
    .dashboardAction.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .dashboardAction.secondary{background:#fff;color:var(--accent);border-color:rgba(37,99,235,.35)}
    .dashboardAction:hover{box-shadow:0 10px 22px rgba(37,99,235,.2);transform:translateY(-2px)}
    .dashboardAction:focus-visible{outline:3px solid rgba(37,99,235,.6);outline-offset:3px}
    body.dashboard-animating .dashboardCard{pointer-events:none;transition:opacity .45s ease}
    body.dashboard-animating .dashboardCard:not(.dashboardCard--spotlight){opacity:.55}
    body.dashboard-animating .dashboardCard::after{content:"";position:absolute;inset:-10px;border-radius:18px;border:3px solid transparent;opacity:0}
    @keyframes dashboardCardPulse{0%,100%{box-shadow:0 12px 24px rgba(239,68,68,.18);}50%{box-shadow:0 22px 44px rgba(239,68,68,.28);}}
    @keyframes dashboardRingPulse{0%,100%{opacity:.45;border-color:rgba(239,68,68,.65);box-shadow:0 0 0 8px rgba(239,68,68,.1);}50%{opacity:1;border-color:#ef4444;box-shadow:0 0 0 18px rgba(239,68,68,.05);}}
    body.dashboard-animating .dashboardCard.dashboardCard--spotlight{animation:dashboardCardPulse 2.2s ease-in-out infinite;z-index:2}
    body.dashboard-animating .dashboardCard.dashboardCard--spotlight::after{animation:dashboardRingPulse 2.2s ease-in-out infinite}
    body.dashboard-animating .dashboardCards{min-height:200px}
    body.dashboard-animating .dashboardCardsColumn{align-items:stretch}
    .dashboardTicker{background:#fff;border:1px solid var(--line);border-radius:12px;padding:16px;box-shadow:0 12px 24px rgba(15,23,42,.08);display:flex;flex-direction:column;gap:12px;width:100%;min-height:160px}
    .dashboardTickerHeader{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .dashboardTickerTitle{margin:0;font-size:15px;color:#1f2937;font-weight:600}
    .dashboardTickerNow{font-size:13px;color:#1f2937;font-weight:600;opacity:0;transition:opacity .4s ease}
    .dashboardTickerNow.show{opacity:1}
    .dashboardTickerList{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px;max-height:220px;overflow:auto}
    .dashboardTickerItem{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#f8fafc;font-size:12px;color:#1f2937}
    .dashboardTickerEmpty{font-size:12px;color:var(--muted)}
    body.dashboard-tasks-only .dashboardAnimationRow{grid-template-columns:1fr}
    body.dashboard-tasks-only .dashboardCardsColumn,
    body.dashboard-tasks-only .dashboardDetails,
    body.dashboard-tasks-only .dashboardActions{display:none}
    body.dashboard-tasks-only .dashboardDetailColumn{justify-content:flex-start;width:100%}
    body.dashboard-tasks-only .dashboardTicker{min-height:calc(100vh - 200px);justify-content:flex-start;width:100%;flex:1}
    body.dashboard-tasks-only .dashboardTickerList{max-height:none;overflow:visible}
    body.dashboard-detail-full .dashboardAnimationRow{grid-template-columns:1fr}
    body.dashboard-detail-full .dashboardCardsColumn,
    body.dashboard-detail-full .dashboardTicker,
    body.dashboard-detail-full .dashboardActions{display:none}
    body.dashboard-detail-full .dashboardDetailColumn{width:100%;justify-content:flex-start}
    body.dashboard-detail-full .dashboardDetails{min-height:calc(100vh - 200px)}
    body.dashboard-detail-full .dashboardDetailsBody{max-height:none}
    body.dashboard-detail-full .rightCard .content{overflow:visible}

    /* Tasks */
    table.tasks{width:100%;border-collapse:collapse}
    table.tasks th,table.tasks td{border:1px solid var(--line);padding:6px 8px;font-size:12px}
    table.tasks th{text-align:left;background:var(--accent);color:#fff}
    table.tasks tbody tr:nth-child(even){background:#f8fafc}
    table.tasks td.taskName.done{text-decoration:line-through;color:var(--muted)}
    table.tasks td.taskDate{white-space:nowrap}
    table.tasks th:first-child, table.tasks td.taskIndex{text-align:center;font-weight:600}
    table.tasks tbody tr.dragging{opacity:.6}
    table.tasks tbody tr.drop-target{outline:2px dashed var(--accent)}
    #tasksTable tbody.drop-target-end{outline:2px dashed var(--accent);outline-offset:-4px}
    td.taskComment{cursor:pointer}
    td.taskComment.empty{color:var(--muted);font-style:italic}
    td.taskStatus{text-align:center}
    #taskStats ul{margin:6px 0 0 16px;padding:0;list-style:disc;color:var(--ink)}
    #taskStats ul li{margin:2px 0}
    .taskActions button{margin:0 2px}
    #tab-tasks{background:linear-gradient(180deg,#f0f4ff,#ffffff)}
    #tab-tasks .toolbar{background:var(--accent);padding:8px;border-radius:8px;margin-bottom:10px}
    #tab-tasks .toolbar button{background:#fff;color:var(--accent);border-color:#fff}
    #saveBtn{background:var(--accent-3);border-color:var(--accent-3)}
    #saveBtn:hover{box-shadow:0 8px 20px rgba(16,185,129,.25)}
    .taskSettingsMenu{display:none;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 12px 24px rgba(15,23,42,.12);padding:12px;margin-bottom:12px;flex-direction:column;gap:8px}
    .taskSettingsMenu.open{display:flex}
    .taskSettingsMenu label{display:flex;align-items:center;gap:8px;font-size:12px;color:#0f172a}
    .taskSettingsMenu input[type="checkbox"]{width:auto;margin:0}
    .taskSettingsTitle{font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.03em}
    .taskArchiveHeader{margin-top:16px;display:flex;align-items:center;gap:8px}
    .taskArchiveHeader button{background:#fff;color:var(--accent);border-color:var(--accent)}
    .archiveContainer{display:none;margin-top:8px}
    .archiveContainer.open{display:block}

    /* Reports */
    #tab-reports{background:linear-gradient(180deg,#eef2ff,#ffffff);padding-bottom:32px}
    .reportsLayout{display:grid;grid-template-columns:320px 1fr;gap:16px;align-items:flex-start;flex:1;min-height:0}
    .reportsControls{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px;box-shadow:0 8px 24px rgba(37,99,235,.08)}
    .reportsControls h3{margin:0;font-size:14px;color:#1e3a8a}
    .reportsControls label{font-size:12px;font-weight:600;color:#1f2937}
    .reportsControls select{width:100%;min-height:140px;border-radius:10px;border:1px solid var(--line);padding:6px;font-size:12px}
    .reportsControls small{color:var(--muted);font-size:11px}
    .reportsControls input[type="search"]{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:10px;font-size:12px}
    .reportsControls button{width:100%}
    .reportsControls .danger{margin-top:8px}
    .reportsTableWrap{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(37,99,235,.08);display:flex;flex-direction:column;gap:12px;color:#000;min-height:0;flex:1}
    .reportsActions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .reportsActions button.primary{background:var(--accent);border-color:var(--accent)}
    .reportsActions button.secondary{background:var(--accent-3);border-color:var(--accent-3);color:#fff}
    .reportsActions .spacer{flex:1 1 auto}
    .reportsActions input.reportNumberInput{width:140px;padding:6px 8px;border:1px solid var(--line);border-radius:8px;font-size:12px}
    .reportsActions input.reportCompanyInput{width:220px;padding:6px 8px;border:1px solid var(--line);border-radius:8px;font-size:12px}
    .reportsActions input.reportCompanyInput.invalid{border-color:var(--danger);box-shadow:0 0 0 2px rgba(239,68,68,.2)}
    .reportsActions button.saveReportBtn{background:var(--accent-3);border-color:var(--accent-3);color:#fff}
    .reportsActions button.saveReportBtn:hover{box-shadow:0 8px 20px rgba(16,185,129,.2)}
    .reportSequenceGroup{display:flex;flex-direction:column;gap:6px;padding:6px 8px;border:1px solid var(--line);border-radius:10px;background:#f8fafc;font-size:12px;max-width:240px}
    .reportSequenceControls{display:flex;gap:6px;align-items:center}
    .reportSequenceControls input{flex:1}
    .reportSequenceControls button{padding:6px 8px;font-size:11px}
    .reportSequenceGroup small{color:#1f2937}
    table.reportsTable{width:100%;border-collapse:collapse;font-size:12px}
    table.reportsTable th,table.reportsTable td{border:1px solid var(--line);padding:6px 8px;vertical-align:top;background:#fff;color:#000}
    table.reportsTable th{background:#dbeafe;color:#000;text-align:left}
    table.reportsTable td.reportsIndexCell{font-weight:600;text-align:center}
    table.reportsTable td input,table.reportsTable td textarea{width:100%;border:1px solid var(--line);border-radius:8px;padding:6px;font-size:12px;background:#f8fafc;color:#000}
    table.reportsTable td textarea{min-height:60px;resize:vertical}
    table.reportsTable tbody tr{transition:background .2s ease}
    table.reportsTable tbody tr:hover{background:#f8fafc}
    table.reportsTable td.reportsNameCell strong{display:block;font-size:13px;color:#000}
    .reportsMembers{display:flex;flex-direction:column;gap:4px}
    .reportsMember{display:flex;align-items:center;gap:8px;padding:4px 6px;border-radius:8px;background:#f8fafc;border:1px solid transparent}
    .reportsMember.duplicate{border-color:#f59e0b;background:#fff7ed}
    .reportsMember span.status{font-size:11px;color:#b91c1c}
    .reportsMissingPerson{color:#b91c1c;font-size:11px}
    .reportsMember button{border:none;background:transparent;color:#ef4444;cursor:pointer;padding:2px 4px;border-radius:6px;font-size:12px}
    .reportsMember button:hover{background:rgba(239,68,68,.1)}
    table.reportsTable td.numeric{text-align:right}
    table.reportsTable td.actionsCell{text-align:center}
    table.reportsTable td.actionsCell button{padding:4px 6px;font-size:11px}
    table.reportsTable tfoot td{background:#dcfce7;font-weight:600;color:#065f46}
    .reportsSelectionMessage{margin-top:8px;font-size:12px;color:#b91c1c;font-weight:600;display:none}
    .reportsAddPrompt{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;z-index:1300;padding:16px}
    .reportsAddPrompt.show{display:flex}
    .reportsAddPromptCard{background:#fff;border-radius:16px;box-shadow:0 18px 44px rgba(15,23,42,.25);padding:18px;max-width:380px;width:100%;display:flex;flex-direction:column;gap:12px}
    .reportsAddPromptCard h3{margin:0;font-size:16px;color:#1e3a8a}
    .reportsAddPromptButtons{display:flex;gap:8px;flex-wrap:wrap}
    .reportsAddPromptButtons button{flex:1}
    .reportsAddPromptButtons button.reportsAddPromptClose{flex:0}
    .reportsAddPromptTeamSection{display:none;flex-direction:column;gap:8px;padding:8px;border:1px solid var(--line);border-radius:12px;background:#f8fafc}
    .reportsAddPromptTeamSection.active{display:flex}
    .reportsAddPromptHint{font-size:12px;color:#6b7280}
    .reportsAddPromptError{color:#b91c1c;font-size:12px;min-height:16px}
    .reportsAddPromptClose{align-self:flex-end}
    .reportsAddPromptGroupList{display:flex;flex-wrap:wrap;gap:8px}
    .reportsAddPromptGroupList button{flex:1 1 110px;border-radius:10px;border:1px solid var(--accent);background:#eef2ff;color:#1e3a8a;padding:8px 10px;font-weight:600;cursor:pointer;transition:transform .15s ease, box-shadow .2s ease}
    .reportsAddPromptGroupList button:hover{transform:translateY(-1px);box-shadow:0 8px 16px rgba(37,99,235,.15)}
    .reportsAddPromptGroupList button:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
    .savedReportsSection{border-top:1px solid var(--line);padding-top:12px;display:flex;flex-direction:column;gap:10px}
    .savedReportsSection h3{margin:0;font-size:14px;color:#1e3a8a}
    .savedReportsList{display:flex;flex-direction:column;gap:8px}
    .savedReportsList.empty{color:var(--muted);font-size:12px}
    .savedReportCard{border:1px solid var(--line);border-radius:10px;padding:10px;background:#f8fafc;display:flex;flex-direction:column;gap:6px}
    .savedReportCard header{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .savedReportCard header strong{font-size:13px;color:#1f2937}
    .savedReportMeta{font-size:11px;color:var(--muted)}
    .savedReportActions{display:flex;gap:8px}
    .versionBadge{position:fixed;bottom:20px;right:20px;background:var(--accent-3);color:#fff;border:none;border-radius:999px;padding:10px 16px;font-weight:600;box-shadow:0 12px 24px rgba(16,185,129,.25);cursor:pointer;z-index:1500;display:flex;align-items:center;gap:8px;transition:transform .15s ease, box-shadow .25s ease}
    .versionBadge:hover{box-shadow:0 16px 32px rgba(16,185,129,.35);transform:translateY(-1px)}
    .versionBadge:focus-visible{outline:3px solid rgba(37,99,235,.4);outline-offset:2px}
    .versionOverlay{position:fixed;inset:0;background:rgba(15,23,42,.55);display:none;align-items:center;justify-content:center;z-index:1600;padding:20px}
    .versionOverlay.show{display:flex}
    .versionCard{background:#fff;border-radius:18px;border:1px solid var(--line);box-shadow:0 24px 60px rgba(15,23,42,.35);width:min(92vw,820px);max-height:90vh;display:flex;flex-direction:column;overflow:hidden}
    .versionCard header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--line)}
    .versionCard header h3{margin:0;font-size:16px;color:#1f2937}
    .versionCard header button{border:none;background:transparent;color:var(--muted);font-size:13px;cursor:pointer;padding:6px 10px;border-radius:8px}
    .versionCard header button:hover{background:rgba(37,99,235,.08);color:var(--accent)}
    .versionContent{padding:18px 20px;overflow:auto;display:flex;flex-direction:column;gap:16px}
    .versionEntry{border:1px solid var(--line);border-radius:12px;padding:12px 14px;background:#f8fafc;display:flex;flex-direction:column;gap:8px}
    .versionEntry h4{margin:0;font-size:14px;color:#1e3a8a}
    .versionEntry ul{margin:0;padding-left:20px;display:flex;flex-direction:column;gap:6px;font-size:13px;color:#111827}
    .versionEntry ul li{line-height:1.45}
    body.version-modal-open{overflow:hidden}
    @media (max-width:1100px){
      .reportsLayout{grid-template-columns:1fr;}
      .reportsControls{position:sticky;top:12px;z-index:10}
    }

    /* Auth & Footer */
    .authOverlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(15,23,42,.7),rgba(15,23,42,.85));display:none;align-items:center;justify-content:center;z-index:9999}
    .authCard{width:min(92vw,380px);background:#fff;border-radius:16px;border:1px solid var(--line);box-shadow:0 20px 60px rgba(0,0,0,.35);padding:18px}
    .authCard h3{margin:0 0 8px 0}
    .authCard .muted{display:block;margin-top:6px}
    .authCard input{width:100%;margin-top:8px}
    body.locked{overflow:hidden}
    footer#copyrightFooter{position:fixed;bottom:8px;left:0;right:0;text-align:center;font-size:12px;color:var(--muted)}
    body.landing-mode footer#copyrightFooter{display:none}
  </style>
</head>
<body class="landing-mode">
  <div id="landingView">
    <header class="landingHeader">
      <div class="landingHeaderTop">
        <div id="dashboardDate" class="landingHeaderMeta"></div>
      </div>
      <div class="landingHeaderText">
        <h1>Panou general șantier</h1>
        <p>Rezumat rapid al oamenilor, zonelor și taskurilor din aplicație</p>
      </div>
    </header>
    <main class="landingMain">
      <div class="dashboardAnimationRow">
        <div class="dashboardCardsColumn">
          <div id="dashboardCards" class="dashboardCards"></div>
        </div>
        <div class="dashboardDetailColumn">
          <div id="dashboardDetails" class="dashboardDetails">
            <div class="dashboardDetailsHeader">
              <button type="button" id="dashboardBackButton" class="dashboardBackButton" hidden aria-hidden="true">⟵ Înapoi la dashboard</button>
              <h3 id="dashboardDetailsTitle" class="dashboardDetailsTitle">Detalii statistici</h3>
            </div>
            <div id="dashboardDetailsPlaceholder" class="dashboardDetailsPlaceholder">Selectează o statistică pentru a vedea detalii.</div>
            <div id="dashboardDetailsBody" class="dashboardDetailsBody" hidden></div>
          </div>
          <div id="dashboardTicker" class="dashboardTicker">
            <div class="dashboardTickerHeader">
              <h3 class="dashboardTickerTitle">Taskuri active</h3>
              <div id="dashboardTickerNow" class="dashboardTickerNow"></div>
            </div>
            <ul id="dashboardTickerList" class="dashboardTickerList"></ul>
            <div id="dashboardTickerEmpty" class="dashboardTickerEmpty">Nu există taskuri active.</div>
          </div>
        </div>
      </div>
      <div id="dashboardActions" class="dashboardActions">
        <button type="button" class="dashboardAction primary" data-open-app data-target-tab="panel">Deschide aplicația completă</button>
        <button type="button" class="dashboardAction secondary" data-open-app data-target-tab="tasks">Sari la taskuri</button>
        <button type="button" class="dashboardAction secondary" data-open-app data-target-tab="reports">Sari la rapoarte</button>
      </div>
    </main>
    <footer class="landingFooter">© <span id="landingYear"></span> — Panou general șantier Ticlete Gabriel</footer>
  </div>

  <div id="appShell">
    <!-- Auth overlay -->
    <div id="authOverlay" class="authOverlay" aria-modal="true" role="dialog">
      <div class="authCard">
        <h3>Acces protejat</h3>
        <label class="subtitle">Introduceți parola</label>
        <input type="password" id="authPwd" placeholder="parolă" autocomplete="off" autocorrect="off" spellcheck="false" />
        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="authEnter" class="primary" style="flex:1">Intră</button>
          <button id="authCancel" class="ghost">Anulează</button>
        </div>
      </div>
    </div>

    <div class="app">
    <div class="grid">
      <!-- stânga -->
      <div class="card leftCard">
        <h2>
          <span>Harta șantier</span>
          <span class="subtitle">Data: <span id="dateLabel">—</span></span>
          <span class="subtitle">Directi+indirecti (A+I): <strong id="allPeopleCount">0</strong></span>
        </h2>
        <div class="content">
          <div class="alert" id="dupAlert">⚠️ Nume duplicat detectat în mai multe fronturi. Un nume poate exista într-un singur front la un moment dat.</div>

          <div class="toolbar">
            <button id="addZone" class="primary">+ Zonă</button>
            <button id="addPerson" class="primary" style="background:var(--accent-2);border-color:var(--accent-2)">+ Persoană</button>
            <button id="bulkAddPerson" class="primary">+ Persoane multiple</button>
            <button id="addRole" class="primary" style="background:var(--accent-3);border-color:var(--accent-3)">+ Rol</button>
            <input id="newRoleInput" class="roleInput" placeholder="Nume rol (ex: CTC)" style="display:none;width:160px" />
            <button id="saveRoleBtn" class="primary" style="display:none">Adaugă</button>
            <button id="cancelRoleBtn" style="display:none">Anulează</button>
            <button id="deleteSelected" class="danger" disabled>Șterge selecția</button>
            <span class="subtitle">— Trage o persoană între cutii pentru a o muta</span>
            <input type="search" id="personSearchInput" class="personSearchInput" placeholder="Caută persoană" title="Căutare rapidă după nume" />
            <span style="flex:1"></span>
            <label for="workDate" class="subtitle">Data curentă</label>
            <input type="date" id="workDate" />
          </div>

          <div id="unsavedBanner" class="alert" style="display:none">
            ⚠️ Ai modificări nesalvate. Exportă baza de date JSON pentru backup.
          </div>

          <div id="zonesWrap" class="zonesWrap"></div>

          <div class="footer">
            <div>
              <button id="exportBtn" class="primary">Exportă JSON</button>
              <button id="exportPdfBtn">Exportă PDF</button>
              <input type="file" id="importFile" accept="application/json" style="display:none" />
              <button id="importBtn" class="primary" style="background:var(--accent-3);border-color:var(--accent-3)">Importă JSON</button>
              <button id="databaseSettingsBtn" class="ghost" type="button" title="Setări bază de date">⚙️</button>
              <span class="subtitle" style="margin:0 6px">|</span>
              <button id="setPwdBtn" class="primary" style="background:var(--accent-2);border-color:var(--accent-2)">Parolă…</button>
            </div>
            <div class="footerNotes">
              <small class="muted">Datele sunt doar locale. Exportă pentru backup.</small>
              <small id="databaseFolderLabel" class="muted" style="margin-left:12px"></small>
            </div>
          </div>
        </div>
      </div>

      <!-- dreapta -->
      <div class="card rightCard">
        <div class="tabs">
          <button class="tab" id="dashboardTabBtn" type="button" data-tab="dashboard">Dashboard</button>
          <button class="tab active" data-tab="panel">Panou</button>
          <button class="tab" data-tab="chart">Grafic</button>
          <button class="tab" data-tab="tasks">Taskuri</button>
          <button class="tab" data-tab="reports">Rapoarte</button>
          <div class="settingsWrapper">
            <button id="settingsBtn" class="ghost settingsBtn" type="button" aria-haspopup="true" aria-expanded="false" title="Setări">⚙️</button>
          </div>
          <span style="flex:1"></span>
          <button id="saveBtn" class="primary" style="background:var(--accent-3);border-color:var(--accent-3)">Salvează</button>
        </div>
        <div class="content">
          <!-- Tab: Panel -->
          <div id="tab-panel" class="tabPanel active">
            <div id="settingsMenu" class="settingsMenu" role="region" aria-hidden="true">
              <div class="settingsSection">
                <button id="settingsDisplayToggle" type="button" class="settingsAction">⚙️ Setări afișare</button>
                <div id="settingsDisplayPanel" class="settingsSubpanel">
                  <label for="settingsAnonToggle"><input type="checkbox" id="settingsAnonToggle" /> Anonimizare</label>
                  <label for="settingsHideRolesToggle"><input type="checkbox" id="settingsHideRolesToggle" /> Ascundere roluri</label>
                </div>
              </div>
              <div class="settingsSection">
                <button id="settingsTimingToggle" type="button" class="settingsAction">⚙️ Setări timpi</button>
                <div id="settingsTimingPanel" class="settingsSubpanel settingsTimings">
                  <label for="settingsAnimationDelay"><span>Animare dashboard (minute)</span>
                    <input type="number" id="settingsAnimationDelay" min="1" step="1" />
                  </label>
                  <label for="settingsDashboardDelay"><span>Revenire la dashboard (minute)</span>
                    <input type="number" id="settingsDashboardDelay" min="1" step="1" />
                  </label>
                  <label for="settingsPasswordDelay"><span>Solicitare parolă (minute)</span>
                    <input type="number" id="settingsPasswordDelay" min="1" step="1" />
                  </label>
                  <small>Timpii se aplică pentru inactivitate și se păstrează local.</small>
                </div>
              </div>
              <div class="settingsSection">
                <button id="settingsPdfToggle" type="button" class="settingsAction">⚙️ Setări raport PDF</button>
                <div id="settingsPdfPanel" class="settingsSubpanel">
                  <label for="settingsPdfZonesToggle"><input type="checkbox" id="settingsPdfZonesToggle" checked /> Zone</label>
                  <label for="settingsPdfRolesToggle"><input type="checkbox" id="settingsPdfRolesToggle" checked /> Statistici pe roluri</label>
                  <label for="settingsPdfSummaryToggle"><input type="checkbox" id="settingsPdfSummaryToggle" checked /> Sumar</label>
                  <label for="settingsPdfInactiveToggle"><input type="checkbox" id="settingsPdfInactiveToggle" checked /> Oameni inactivi</label>
                </div>
              </div>
              <div class="settingsSection">
                <button id="settingsRoleManagerToggle" type="button" class="settingsAction">⚙️ Gestionare roluri</button>
                <div id="roleManager">
                  <div class="subtitle">Roluri</div>
                  <div id="roleList"></div>
                </div>
              </div>
            </div>
            <h2 id="editorHeader" style="border:none;padding:0 0 8px 0">Editor selecție</h2>
            <div id="noSelection" class="muted">Nimic selectat. Alege o zonă sau o persoană.</div>

            <form id="zoneForm" style="display:none;gap:8px">
              <label>Tip selecție</label>
              <div class="badge">Zonă</div>
              <label for="zoneName">Nume zonă</label>
              <input id="zoneName" />
              <div class="row">
                <div>
                  <label for="gridIndex">Poziție în grilă</label>
                  <input id="gridIndex" type="number" step="1" />
                </div>
                <div></div>
              </div>
              <div class="row">
                <div>
                  <label for="zoneStart">Început lucrare</label>
                  <input type="date" id="zoneStart" />
                </div>
                <div>
                  <label for="zoneEnd">Sfârșit lucrare</label>
                  <input type="date" id="zoneEnd" />
                </div>
              </div>
              <button type="button" id="applyZone" class="primary">Aplică</button>
            </form>

            <form id="personForm" style="display:none;gap:8px;margin-top:12px">
              <label>Tip selecție</label>
              <div class="badge">Persoană</div>
              <label for="personName">Nume</label>
              <input id="personName" />
              <label for="personRole">Rol</label>
              <select id="personRole"></select>
              <label for="personZone">Front de lucru</label>
              <select id="personZone"></select>
              <label for="personStatus">Status</label>
              <select id="personStatus">
                <option>Activ</option>
                <option>Inactiv CO</option>
                <option>Inactiv CM</option>
                <option>Demisie</option>
              </select>
              <div id="inactivePeriod" class="row" style="display:none">
                <div>
                  <label for="inactiveFrom">De la</label>
                  <input type="date" id="inactiveFrom" />
                </div>
                <div>
                  <label for="inactiveTo">Până la</label>
                  <input type="date" id="inactiveTo" />
                </div>
              </div>
              <div id="resignationRow" class="row" style="display:none">
                <div>
                  <label for="resignationDate">Data demisiei</label>
                  <input type="date" id="resignationDate" />
                </div>
                <div></div>
              </div>
              <button type="button" id="applyPerson" class="primary">Aplică</button>
            </form>

            <hr id="editorDivider" style="margin:16px 0;border:none;border-top:1px solid #eee" />
            <h3 style="margin:0 0 8px 0;font-size:14px">Statistici</h3>
            <div class="stats">
              <ul id="statsRoles"></ul>
              <div class="muted" style="margin-top:6px"><strong>Total Directi:</strong> <strong id="totalFaraTesa">0</strong></div>

              <!-- Pools -->
              <div class="unassignedWrap">
                <div class="unassignedHeader">
                  <button id="togglePoolActive" class="ghost">Afișare oameni nealocați (0)</button>
                  <small class="muted">(activi, trage din/în această zonă)</small>
                </div>
                <div id="poolActive" class="pool poolDroppable" style="display:none" title="Trage oameni aici pentru a-i marca nealocați (activi)"></div>
              </div>

              <div class="unassignedWrap" style="margin-top:10px">
                <div class="unassignedHeader">
                  <button id="togglePoolCO" class="ghost" style="color:#b45309">Afișare oameni CO (0)</button>
                  <small class="muted">persoane cu concediu odihnă</small>
                </div>
                <div id="poolCO" class="pool" style="display:none" title="Oamenii CO (nu pot fi trași în zone până nu devin Activ)"></div>
              </div>

              <div class="unassignedWrap" style="margin-top:10px">
                <div class="unassignedHeader">
                  <button id="togglePoolCM" class="ghost" style="color:#b91c1c">Afișare oameni CM (0)</button>
                  <small class="muted">persoane cu concediu medical</small>
                </div>
                <div id="poolCM" class="pool" style="display:none" title="Oamenii CM (nu pot fi trași în zone până nu devin Activ)"></div>
              </div>
              <div class="unassignedWrap" style="margin-top:10px">
                <div class="unassignedHeader">
                  <button id="togglePoolResigned" class="ghost" style="color:#374151">Afișare demisionați (0)</button>
                  <small class="muted">persoane eliminate din statistici</small>
                </div>
                <div id="poolResigned" class="pool" style="display:none" title="Persoanele demisionate nu sunt incluse în statistici"></div>
              </div>
            </div>
          </div>

          <!-- Tab: Chart -->
          <div id="tab-chart" class="tabPanel">
            <h2 style="border:none;padding:0 0 8px 0">Grafic fronturi</h2>
            <div class="subtitle" style="margin-bottom:8px">Barele arată intervalul (început–sfârșit). Etichetele din bară arată <strong>numărul de Directi (activi)</strong> (exclud TESA/Magazioner/Șef Echipa și persoanele inactive).</div>

            <div id="chartFilters" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:8px">
              <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="excludeTESA" checked disabled/> Numără doar Directi activi</label>
              <div style="display:flex;gap:6px;align-items:center">
                <span class="subtitle">Zone afișate:</span>
                <div id="zoneChips" style="display:flex;gap:6px;flex-wrap:wrap"></div>
                <button id="zonesSelectAll" class="ghost" type="button">Selectează toate</button>
              </div>
            </div>

          <div class="chartWrap">
            <svg id="ganttChart" class="chart" viewBox="0 0 560 260" aria-label="Gantt fronturi"></svg>
          </div>
        </div>
        <!-- Tab: Tasks -->
        <div id="tab-tasks" class="tabPanel">
          <h2 style="border:none;padding:0 0 8px 0">Taskuri</h2>
          <div class="toolbar">
            <button id="addTaskBtn" class="primary">+ Task</button>
            <button id="exportTasksPdfBtn" class="primary" style="background:var(--accent-3);border-color:var(--accent-3);color:#fff">Exportă PDF</button>
            <button id="taskSettingsBtn" class="ghost" type="button" aria-haspopup="true" aria-expanded="false">⚙️ Setări</button>
          </div>
          <div id="taskSettingsMenu" class="taskSettingsMenu" role="group" aria-hidden="true">
            <div class="taskSettingsTitle">Raport PDF</div>
            <label for="taskSettingsActiveToggle"><input type="checkbox" id="taskSettingsActiveToggle" checked /> Taskuri active</label>
            <label for="taskSettingsArchiveToggle"><input type="checkbox" id="taskSettingsArchiveToggle" /> Arhivă</label>
            <label for="taskSettingsStatsToggle"><input type="checkbox" id="taskSettingsStatsToggle" checked /> Statistici</label>
          </div>
          <table id="tasksTable" class="tasks">
            <thead>
              <tr><th style="width:40px">Nr.</th><th>Task</th><th>Comentarii</th><th>Creat</th><th>Închis</th><th>Status</th><th style="width:1%"></th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="taskArchiveHeader">
            <h3 style="margin:0;font-size:14px">Arhivă</h3>
            <button id="toggleArchiveBtn" class="ghost" type="button">Afișează</button>
          </div>
          <div id="archiveContainer" class="archiveContainer" aria-hidden="true">
            <table id="archiveTable" class="tasks">
              <thead>
                <tr><th>Task</th><th>Comentarii</th><th>Creat</th><th>Închis</th><th>Status</th><th style="width:1%"></th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="taskStats" style="margin-top:12px"></div>
        </div>

        <!-- Tab: Reports -->
        <div id="tab-reports" class="tabPanel">
          <h2 style="border:none;padding:0 0 8px 0">Rapoarte zilnice</h2>
          <div class="reportsLayout">
            <div class="reportsControls">
              <h3>Selecție persoane</h3>
              <input type="search" id="reportsSearchInput" placeholder="Caută persoană" />
              <small>Filtrează listele introducând numele persoanei. Poți selecta mai multe persoane cu Ctrl/Cmd + click înainte de „Adaugă”.</small>
              <label for="reportsActiveSelect">Activi</label>
              <select id="reportsActiveSelect" multiple size="8"></select>
              <button id="reportsAddActive" class="primary" type="button">Adaugă din activi</button>
              <label for="reportsInactiveSelect">Inactivi (CO/CM)</label>
              <select id="reportsInactiveSelect" multiple size="6"></select>
              <button id="reportsAddInactive" class="primary" type="button">Adaugă din inactivi</button>
              <div id="reportsSelectionMessage" class="reportsSelectionMessage" aria-live="polite"></div>
              <button id="reportsClear" class="danger" type="button">Golește raportul</button>
            </div>
            <div class="reportsTableWrap">
              <div class="reportsActions">
                <button id="reportsExportPdfBtn" class="primary" type="button">Exportă PDF</button>
                <button id="reportsExportExcelBtn" class="secondary" type="button">Exportă Excel</button>
                <input type="text" id="reportCompanyInput" class="reportCompanyInput" placeholder="Firmă raport" aria-label="Firmă raport" />
                <span class="spacer"></span>
                <div class="reportSequenceGroup" aria-live="polite">
                  <label for="reportStartInput" style="font-weight:600;color:#1f2937">Numerotare rapoarte</label>
                  <div class="reportSequenceControls">
                    <input type="number" id="reportStartInput" class="reportNumberInput" min="1" step="1" placeholder="Pornește de la" />
                    <button id="reportStartApplyBtn" type="button" class="ghost">Setează</button>
                  </div>
                  <small>Următor: <span id="reportNextNumberLabel">1</span></small>
                </div>
                <button id="reportsSaveSnapshotBtn" class="saveReportBtn" type="button">Salvează raport</button>
              </div>
              <table id="reportsTable" class="reportsTable">
                <thead>
                  <tr>
                    <th style="width:40px">Nr.</th>
                    <th style="min-width:120px">Data</th>
                    <th style="min-width:160px">Nume &amp; echipă</th>
                    <th style="min-width:160px">Descriere activitate</th>
                    <th style="min-width:90px">Ore lucrate</th>
                    <th style="min-width:80px">Cantitate</th>
                    <th style="min-width:60px">U.M.</th>
                    <th style="min-width:110px">Valoare (RON)</th>
                    <th style="min-width:110px">Valoare (EUR)</th>
                    <th style="min-width:110px">Total</th>
                    <th style="min-width:140px">Observații</th>
                    <th style="width:1%"></th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr class="reportsGrandTotalRow">
                    <td colspan="10" class="numeric"><span id="reportsGrandTotal">0</span></td>
                    <td colspan="2"></td>
                  </tr>
                </tfoot>
              </table>
              <div id="savedReportsSection" class="savedReportsSection">
                <h3>Rapoarte salvate</h3>
                <div id="savedReportsList" class="savedReportsList empty">
                  <div class="muted">Niciun raport salvat momentan.</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
  </div>

  <div id="reportsAddPrompt" class="reportsAddPrompt" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="reportsAddPromptCard">
      <h3>Unde dorești să adaugi persoanele selectate?</h3>
      <p style="margin:0;font-size:13px;color:#374151">Alege dacă adaugi la un criteriu existent sau creezi unul nou.</p>
      <div class="reportsAddPromptButtons">
        <button id="reportsAddPromptTeamBtn" type="button">Adaugă la echipă</button>
        <button id="reportsAddPromptNewBtn" type="button" class="primary">Adaugă nou</button>
      </div>
      <div id="reportsAddPromptTeam" class="reportsAddPromptTeamSection" aria-live="polite">
        <div id="reportsAddPromptHint" class="reportsAddPromptHint"></div>
        <div id="reportsAddPromptGroupList" class="reportsAddPromptGroupList"></div>
        <div class="reportsAddPromptButtons">
          <button id="reportsAddPromptTeamCancel" type="button">Înapoi</button>
        </div>
      </div>
      <div id="reportsAddPromptError" class="reportsAddPromptError" aria-live="assertive"></div>
      <div class="reportsAddPromptButtons" style="justify-content:flex-end">
        <button id="reportsAddPromptClose" type="button" class="ghost reportsAddPromptClose">Anulează</button>
      </div>
    </div>
  </div>

  </div>

  <button id="versionButton" class="versionBadge" type="button" aria-haspopup="dialog" aria-controls="versionModal"></button>
  <div id="versionModal" class="versionOverlay" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="versionModalTitle">
    <div class="versionCard" role="document">
      <header>
        <h3 id="versionModalTitle">Istoric versiuni</h3>
        <button type="button" id="versionClose" aria-label="Închide istoricul">Închide</button>
      </header>
      <div id="versionContent" class="versionContent" tabindex="0"></div>
    </div>
  </div>

  <script>
    // ======= Flag modificări (dirty) + banner =======
    let dirty = false;
    const unsavedBanner = document.getElementById('unsavedBanner');

    const STORAGE_KEY = 'hartaSantierData';
    const STORAGE_VERSION = 1;
    const LOCAL_SAVE_DEBOUNCE_MS = 400;
    let localSaveTimer = null;
    let restoringState = false;
    let restoredDateOverride = null;
    const markDirty = ()=>{
      dirty = true;
      if(unsavedBanner) unsavedBanner.style.display='block';
      scheduleLocalPersist();
    };

    function scheduleLocalPersist(){
      if(restoringState) return;
      if(localSaveTimer) clearTimeout(localSaveTimer);
      localSaveTimer = setTimeout(()=>{
        localSaveTimer = null;
        persistStateToLocalStorage();
      }, LOCAL_SAVE_DEBOUNCE_MS);
    }

    function persistStateToLocalStorage(){
      if(typeof localStorage === 'undefined') return;
      try {
        const snapshot = getStateSnapshot();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(snapshot));
      } catch(err){
        console.warn('Nu am putut salva starea în localStorage.', err);
      }
    }

    function ensurePositiveMs(value, fallback){
      const numeric = Number(value);
      if(!Number.isFinite(numeric) || numeric <= 0) return fallback;
      return numeric;
    }

    function getStateSnapshot(){
      const dateValue = (typeof workDate !== 'undefined' && workDate && workDate.value)
        ? workDate.value
        : todayStr();
      return {
        version: STORAGE_VERSION,
        date: dateValue,
        zones,
        people,
        roles,
        tasks,
        tasksArchive,
        reports: reportEntries.map(mapImportedReportEntry),
        savedReports: savedReports.map(serializeSavedReport),
        reportCompany: (reportCompany || '').trim(),
        reportSequence: Number.isFinite(reportSequence) ? reportSequence : 1,
        settings: {
          anonymize: typeof anonymize === 'boolean' ? anonymize : false,
          hideRoles: typeof hideRoles === 'boolean' ? hideRoles : false,
          pdfShowZones: typeof pdfShowZones === 'boolean' ? pdfShowZones : true,
          pdfShowRoleStats: typeof pdfShowRoleStats === 'boolean' ? pdfShowRoleStats : true,
          pdfShowSummary: typeof pdfShowSummary === 'boolean' ? pdfShowSummary : true,
          pdfShowInactive: typeof pdfShowInactive === 'boolean' ? pdfShowInactive : true,
          taskPdfShowActive: typeof taskPdfShowActive === 'boolean' ? taskPdfShowActive : true,
          taskPdfShowArchive: typeof taskPdfShowArchive === 'boolean' ? taskPdfShowArchive : false,
          taskPdfShowStats: typeof taskPdfShowStats === 'boolean' ? taskPdfShowStats : true,
          taskArchiveVisible: typeof taskArchiveVisible === 'boolean' ? taskArchiveVisible : false,
          databaseFolder: typeof databaseFolder === 'string' ? databaseFolder : '',
          inactivityAnimationDelay: ensurePositiveMs(inactivityAnimationDelay, DEFAULT_ANIMATION_DELAY),
          inactivityDashboardDelay: ensurePositiveMs(inactivityDashboardDelay, DEFAULT_DASHBOARD_DELAY),
          passwordInactivityDelay: ensurePositiveMs(passwordInactivityDelay, DEFAULT_PASSWORD_DELAY)
        }
      };
    }

    function normalizeZoneFromStorage(raw, fallbackIndex){
      const zone = raw && typeof raw === 'object' ? { ...raw } : {};
      zone.id = typeof zone.id === 'string' && zone.id.trim()
        ? zone.id
        : 'z'+Math.random().toString(36).slice(2,7);
      zone.name = typeof zone.name === 'string' ? zone.name : '';
      const idx = Number(zone.gridIndex);
      zone.gridIndex = Number.isFinite(idx)
        ? idx
        : (typeof fallbackIndex === 'number' ? fallbackIndex : 0);
      zone.startDate = typeof zone.startDate === 'string' ? zone.startDate : '';
      zone.endDate = typeof zone.endDate === 'string' ? zone.endDate : '';
      return zone;
    }

    function normalizePersonFromStorage(raw){
      const person = raw && typeof raw === 'object' ? { ...raw } : {};
      person.id = typeof person.id === 'string' && person.id.trim()
        ? person.id
        : 'p'+Math.random().toString(36).slice(2,7);
      person.name = typeof person.name === 'string' ? person.name : '';
      person.role = typeof person.role === 'string' ? person.role : '—';
      if(person.zoneId !== null && typeof person.zoneId !== 'string') person.zoneId = null;
      if(person.zoneId === undefined) person.zoneId = null;
      person.status = typeof person.status === 'string' ? person.status : 'Activ';
      person.inactiveFrom = typeof person.inactiveFrom === 'string' ? person.inactiveFrom : '';
      person.inactiveTo = typeof person.inactiveTo === 'string' ? person.inactiveTo : '';
      person.resignationDate = typeof person.resignationDate === 'string' ? person.resignationDate : '';
      if(person.status === 'Activ'){
        person.inactiveFrom = '';
        person.inactiveTo = '';
        person.resignationDate = '';
      } else if(person.status === 'Demisie'){
        person.inactiveFrom = '';
        person.inactiveTo = '';
        if(!person.resignationDate) person.resignationDate = '';
      } else {
        if(!person.inactiveTo){
          person.inactiveTo = person.inactiveFrom;
        }
        person.resignationDate = '';
      }
      return person;
    }

    function restoreFromLocalStorage(){
      if(typeof localStorage === 'undefined') return false;
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return false;
      try {
        const parsed = JSON.parse(raw);
        if(!parsed || typeof parsed !== 'object') return false;
        restoringState = true;
        if(localSaveTimer){
          clearTimeout(localSaveTimer);
          localSaveTimer = null;
        }
        if(Array.isArray(parsed.zones)){
          zones = parsed.zones.map((z, idx)=> normalizeZoneFromStorage(z, idx));
        }
        if(Array.isArray(parsed.people)){
          people = parsed.people.map(normalizePersonFromStorage);
        }
        if(Array.isArray(parsed.roles)){
          roles = normalizeRoles(parsed.roles);
        }
        if(Array.isArray(parsed.people) || Array.isArray(parsed.roles)){
          const derivedRoles = people.map(p=> typeof p?.role === 'string' ? p.role : '').filter(Boolean);
          roles = normalizeRoles([...(roles || []), ...derivedRoles]);
        }
        if(Array.isArray(parsed.tasks)){
          tasks = parsed.tasks.map(mapImportedTask);
        }
        if(Array.isArray(parsed.tasksArchive)){
          tasksArchive = parsed.tasksArchive.map(mapImportedTask);
        }
        if(Array.isArray(parsed.reports)){
          reportEntries = parsed.reports.map(mapImportedReportEntry);
          normalizeReportEntriesAfterLoad();
        }
        if(Array.isArray(parsed.savedReports)){
          savedReports = parsed.savedReports.map(mapImportedSavedReport);
        }
        if(parsed.reportSequence !== undefined){
          const seq = Number(parsed.reportSequence);
          if(Number.isFinite(seq) && seq > 0){
            reportSequence = seq;
          }
        }
        if(parsed.settings && typeof parsed.settings === 'object'){
          if(parsed.settings.anonymize !== undefined) anonymize = !!parsed.settings.anonymize;
          if(parsed.settings.hideRoles !== undefined) hideRoles = !!parsed.settings.hideRoles;
          if(parsed.settings.pdfShowZones !== undefined) pdfShowZones = !!parsed.settings.pdfShowZones;
          if(parsed.settings.pdfShowRoleStats !== undefined) pdfShowRoleStats = !!parsed.settings.pdfShowRoleStats;
          if(parsed.settings.pdfShowSummary !== undefined) pdfShowSummary = !!parsed.settings.pdfShowSummary;
          if(parsed.settings.pdfShowInactive !== undefined) pdfShowInactive = !!parsed.settings.pdfShowInactive;
          if(parsed.settings.taskPdfShowActive !== undefined) taskPdfShowActive = !!parsed.settings.taskPdfShowActive;
          if(parsed.settings.taskPdfShowArchive !== undefined) taskPdfShowArchive = !!parsed.settings.taskPdfShowArchive;
          if(parsed.settings.taskPdfShowStats !== undefined) taskPdfShowStats = !!parsed.settings.taskPdfShowStats;
          if(parsed.settings.taskArchiveVisible !== undefined) taskArchiveVisible = !!parsed.settings.taskArchiveVisible;
          if(parsed.settings.databaseFolder !== undefined) databaseFolder = sanitizeFolderName(parsed.settings.databaseFolder);
          if(parsed.settings.inactivityAnimationDelay !== undefined){
            inactivityAnimationDelay = ensurePositiveMs(parsed.settings.inactivityAnimationDelay, DEFAULT_ANIMATION_DELAY);
          }
          if(parsed.settings.inactivityDashboardDelay !== undefined){
            inactivityDashboardDelay = ensurePositiveMs(parsed.settings.inactivityDashboardDelay, DEFAULT_DASHBOARD_DELAY);
          }
          if(parsed.settings.passwordInactivityDelay !== undefined){
            passwordInactivityDelay = ensurePositiveMs(parsed.settings.passwordInactivityDelay, DEFAULT_PASSWORD_DELAY);
          }
        }
        reportCompany = '';
        if(typeof parsed.reportCompany === 'string'){
          reportCompany = parsed.reportCompany.trim();
        } else if(parsed.settings && typeof parsed.settings.reportCompany === 'string'){
          reportCompany = parsed.settings.reportCompany.trim();
        }
        if(typeof parsed.date === 'string' && parsed.date){
          restoredDateOverride = parsed.date;
          try { localStorage.setItem('workDate', restoredDateOverride); } catch(_err){}
        }
        recalculateReportSequence();
        selected = null;
        dirty = false;
        if(unsavedBanner) unsavedBanner.style.display='none';
        setCurrentReportEditing(null);
        return true;
      } catch(err){
        console.warn('Nu am putut citi datele locale.', err);
      } finally {
        restoringState = false;
      }
      return false;
    }

    // ======= Paletă culori roluri =======
    const rolePalette = [
      { bg:'#dbeafe', border:'#60a5fa' },
      { bg:'#fee2e2', border:'#ef4444' },
      { bg:'#fef3c7', border:'#f59e0b' },
      { bg:'#e5e7eb', border:'#9ca3af' },
      { bg:'#dcfce7', border:'#22c55e' },
      { bg:'#ede9fe', border:'#8b5cf6' },
      { bg:'#e0f2fe', border:'#38bdf8' },
    ];
    let roles = ['Sudor','Lăcătuș','Instalator','TESA','Magazioner','Sef Echipa'];
    const roleColors = new Map();
    function getRoleColor(role){
      const key = role || '—';
      if(!roleColors.has(key)){
        const i = roleColors.size % rolePalette.length;
        roleColors.set(key, rolePalette[i]);
      }
      return roleColors.get(key);
    }

    // ======= Date inițiale =======
    let zones = [
      { id: 'z1', name: 'Front de lucru 1', gridIndex: 0, startDate: '', endDate: '' },
      { id: 'z2', name: 'Front de lucru 2', gridIndex: 2, startDate: '', endDate: '' },
      { id: 'z3', name: 'Front de lucru 3', gridIndex: 4, startDate: '', endDate: '' },
      { id: 'z4', name: '', gridIndex: 1, startDate: '', endDate: '' },
      { id: 'z5', name: '', gridIndex: 3, startDate: '', endDate: '' },
      { id: 'z6', name: '', gridIndex: 5, startDate: '', endDate: '' },
      { id: 'z7', name: '', gridIndex: 6, startDate: '', endDate: '' },
      { id: 'z8', name: '', gridIndex: 7, startDate: '', endDate: '' },
      { id: 'z9', name: '', gridIndex: 8, startDate: '', endDate: '' },
      { id: 'z10', name: '', gridIndex: 9, startDate: '', endDate: '' },
    ];

    let people = [
      { id: 'p1', name: 'Popescu Vasile', role: 'Instalator', zoneId: 'z1', status: 'Activ', inactiveFrom:'', inactiveTo:'', resignationDate:'' },
      { id: 'p2', name: 'Ion Popescu', role: 'Sudor', zoneId: 'z2', status: 'Activ', inactiveFrom:'', inactiveTo:'', resignationDate:'' },
      { id: 'p3', name: 'Maria Ionescu', role: 'TESA', zoneId: 'z4', status: 'Activ', inactiveFrom:'', inactiveTo:'', resignationDate:'' },
    ];

    let tasks = [];
    let tasksArchive = [];
    let taskPdfShowActive = true;
    let taskPdfShowArchive = false;
    let taskPdfShowStats = true;
    let taskArchiveVisible = false;
    let taskSettingsOpen = false;
    let reportEntries = [];
    let savedReports = [];
    let reportCompany = '';
    let editingReportId = null;
    let editingReportNumber = null;
    let reportSequence = 1;
    let reportsSearchTerm = '';
    let databaseFolder = '';
    let reportOccurrenceCounts = new Map();
    let pendingReportAddIds = [];
    let pendingReportAddSelect = null;

    // ======= Stare & referințe DOM =======
    let selected = null; // { type: 'zone'|'person', id: string }
    const zonesWrap = document.getElementById('zonesWrap');
    const deleteBtn = document.getElementById('deleteSelected');
    const dupAlert = document.getElementById('dupAlert');
    const workDate = document.getElementById('workDate');
    const dateLabel = document.getElementById('dateLabel');
    const ganttChart = document.getElementById('ganttChart');
    const roleInput = document.getElementById('newRoleInput');
    const saveRoleBtn = document.getElementById('saveRoleBtn');
    const cancelRoleBtn = document.getElementById('cancelRoleBtn');

    const poolActive = document.getElementById('poolActive');
    const poolCO = document.getElementById('poolCO');
    const poolCM = document.getElementById('poolCM');
    const poolResigned = document.getElementById('poolResigned');

    const togglePoolActiveBtn = document.getElementById('togglePoolActive');
    const togglePoolCOBtn = document.getElementById('togglePoolCO');
    const togglePoolCMBtn = document.getElementById('togglePoolCM');
    const togglePoolResignedBtn = document.getElementById('togglePoolResigned');

    const excludeTESAChk = document.getElementById('excludeTESA');
    const zoneChipsWrap = document.getElementById('zoneChips');
    const zonesSelectAllBtn = document.getElementById('zonesSelectAll');
    const allPeopleCount = document.getElementById('allPeopleCount');
    const statusSelect = document.getElementById('personStatus');
    const personNameInput = document.getElementById('personName');
    const inactivePeriodRow = document.getElementById('inactivePeriod');
    const inactiveFromInput = document.getElementById('inactiveFrom');
    const inactiveToInput = document.getElementById('inactiveTo');
    const resignationRow = document.getElementById('resignationRow');
    const resignationDateInput = document.getElementById('resignationDate');
    const dashboardDateLabel = document.getElementById('dashboardDate');
    const dashboardCardsEl = document.getElementById('dashboardCards');
    const dashboardDetailsEl = document.getElementById('dashboardDetails');
    const dashboardDetailsTitleEl = document.getElementById('dashboardDetailsTitle');
    const dashboardDetailsBodyEl = document.getElementById('dashboardDetailsBody');
    const dashboardDetailsPlaceholderEl = document.getElementById('dashboardDetailsPlaceholder');
    const dashboardBackButton = document.getElementById('dashboardBackButton');
    const dashboardTickerListEl = document.getElementById('dashboardTickerList');
    const dashboardTickerEmptyEl = document.getElementById('dashboardTickerEmpty');
    const dashboardTickerNowEl = document.getElementById('dashboardTickerNow');
    const versionButton = document.getElementById('versionButton');
    const versionModal = document.getElementById('versionModal');
    const versionContentEl = document.getElementById('versionContent');
    const versionCloseBtn = document.getElementById('versionClose');
    const landingView = document.getElementById('landingView');
    const appShell = document.getElementById('appShell');
    const addTaskBtn = document.getElementById('addTaskBtn');
    const exportTasksPdfBtn = document.getElementById('exportTasksPdfBtn');
    const taskSettingsBtn = document.getElementById('taskSettingsBtn');
    const taskSettingsMenu = document.getElementById('taskSettingsMenu');
    const taskSettingsActiveToggle = document.getElementById('taskSettingsActiveToggle');
    const taskSettingsArchiveToggle = document.getElementById('taskSettingsArchiveToggle');
    const taskSettingsStatsToggle = document.getElementById('taskSettingsStatsToggle');
    const tasksTableBody = document.querySelector('#tasksTable tbody');
    const archiveTableBody = document.querySelector('#archiveTable tbody');
    const toggleArchiveBtn = document.getElementById('toggleArchiveBtn');
    const archiveContainer = document.getElementById('archiveContainer');
    const taskStatsEl = document.getElementById('taskStats');
    const databaseSettingsBtn = document.getElementById('databaseSettingsBtn');
    const databaseFolderLabel = document.getElementById('databaseFolderLabel');

    const reportsActiveSelect = document.getElementById('reportsActiveSelect');
    const reportsInactiveSelect = document.getElementById('reportsInactiveSelect');
    const reportsAddActiveBtn = document.getElementById('reportsAddActive');
    const reportsAddInactiveBtn = document.getElementById('reportsAddInactive');
    const reportsClearBtn = document.getElementById('reportsClear');
    const reportsTableBody = document.querySelector('#reportsTable tbody');
    const reportsExportPdfBtn = document.getElementById('reportsExportPdfBtn');
    const reportsExportExcelBtn = document.getElementById('reportsExportExcelBtn');
    const reportCompanyInput = document.getElementById('reportCompanyInput');
    const reportsSelectionMessage = document.getElementById('reportsSelectionMessage');
    const reportsGrandTotalCell = document.getElementById('reportsGrandTotal');
    const reportsSearchInput = document.getElementById('reportsSearchInput');
    const reportStartInput = document.getElementById('reportStartInput');
    const reportStartApplyBtn = document.getElementById('reportStartApplyBtn');
    const reportNextNumberLabel = document.getElementById('reportNextNumberLabel');
    const reportsSaveSnapshotBtn = document.getElementById('reportsSaveSnapshotBtn');
    const savedReportsList = document.getElementById('savedReportsList');
    const reportsAddPrompt = document.getElementById('reportsAddPrompt');
    const reportsAddPromptTeamSection = document.getElementById('reportsAddPromptTeam');
    const reportsAddPromptHint = document.getElementById('reportsAddPromptHint');
    const reportsAddPromptError = document.getElementById('reportsAddPromptError');
    const reportsAddPromptTeamBtn = document.getElementById('reportsAddPromptTeamBtn');
    const reportsAddPromptNewBtn = document.getElementById('reportsAddPromptNewBtn');
    const reportsAddPromptGroupList = document.getElementById('reportsAddPromptGroupList');
    const reportsAddPromptTeamCancelBtn = document.getElementById('reportsAddPromptTeamCancel');
    const reportsAddPromptCloseBtn = document.getElementById('reportsAddPromptClose');
    const saveBtn = document.getElementById('saveBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsMenu = document.getElementById('settingsMenu');
    const settingsAnonToggle = document.getElementById('settingsAnonToggle');
    const settingsHideRolesToggle = document.getElementById('settingsHideRolesToggle');
    const settingsTimingToggle = document.getElementById('settingsTimingToggle');
    const settingsTimingPanel = document.getElementById('settingsTimingPanel');
    const settingsAnimationDelayInput = document.getElementById('settingsAnimationDelay');
    const settingsDashboardDelayInput = document.getElementById('settingsDashboardDelay');
    const settingsPasswordDelayInput = document.getElementById('settingsPasswordDelay');
    const settingsPdfZonesToggle = document.getElementById('settingsPdfZonesToggle');
    const settingsPdfRolesToggle = document.getElementById('settingsPdfRolesToggle');
    const settingsPdfSummaryToggle = document.getElementById('settingsPdfSummaryToggle');
    const settingsPdfInactiveToggle = document.getElementById('settingsPdfInactiveToggle');
    const settingsRoleManagerToggle = document.getElementById('settingsRoleManagerToggle');
    const settingsDisplayToggle = document.getElementById('settingsDisplayToggle');
    const settingsDisplayPanel = document.getElementById('settingsDisplayPanel');
    const settingsPdfToggle = document.getElementById('settingsPdfToggle');
    const settingsPdfPanel = document.getElementById('settingsPdfPanel');
    const roleManagerPanel = document.getElementById('roleManager');
    const bulkAddPersonBtn = document.getElementById('bulkAddPerson');
    const personSearchInput = document.getElementById('personSearchInput');

    const DEFAULT_ANIMATION_DELAY = 1 * 60 * 1000;
    const DEFAULT_DASHBOARD_DELAY = 4 * 60 * 1000;
    const DEFAULT_PASSWORD_DELAY = 5 * 60 * 1000;
    const DASHBOARD_TASKS_CLASS = 'dashboard-tasks-only';
    const DASHBOARD_DETAIL_FULL_CLASS = 'dashboard-detail-full';
    let inactivityAnimationDelay = DEFAULT_ANIMATION_DELAY;
    let inactivityDashboardDelay = DEFAULT_DASHBOARD_DELAY;
    let passwordInactivityDelay = DEFAULT_PASSWORD_DELAY;
    let reschedulePasswordTimeout = null;
    const ANIMATION_TABS = new Set(['panel','chart','tasks','reports']);
    let landingClockInterval = null;
    let inactivityAnimationTimeout = null;
    let inactivityReturnTimeout = null;
    let statsAnimating = false;
    let statsAnimationInterval = null;
    let statsAnimationIndex = 0;
    let dashboardCurrentPhase = 'idle';
    let dashboardDetailKey = null;
    let dashboardDetailContext = null;
    let dashboardDetailFullscreen = false;
    let dashboardCardElements = new Map();
    let dashboardTickerData = [];
    let dashboardTickerInterval = null;
    let dashboardTickerIndex = 0;
    let pendingStatsAnimation = false;
    let autoFullscreenActive = false;
    let fullscreenPending = false;
    let activeView = document.body.classList.contains('landing-mode') ? 'dashboard' : 'panel';

    function updateStatusFormVisibility(){
      if(!statusSelect) return;
      const value = statusSelect.value || 'Activ';
      if(inactivePeriodRow){
        const showPeriod = value === 'Inactiv CO' || value === 'Inactiv CM';
        inactivePeriodRow.style.display = showPeriod ? 'grid' : 'none';
      }
      if(resignationRow){
        resignationRow.style.display = value === 'Demisie' ? 'grid' : 'none';
      }
    }

    let suppressStatusChange = false;
    statusSelect?.addEventListener('change', ()=>{
      if(!statusSelect) return;
      if(suppressStatusChange) return;
      const previous = statusSelect.dataset.prevValue || 'Activ';
      const current = statusSelect.value || 'Activ';
      if(current === 'Demisie' && previous !== 'Demisie'){
        const confirmed = confirm('Marcați persoana ca demisionată? Persoana nu va mai fi inclusă în statistici și rapoarte.');
        if(!confirmed){
          suppressStatusChange = true;
          statusSelect.value = previous;
          suppressStatusChange = false;
          updateStatusFormVisibility();
          return;
        }
      }
      if(current !== 'Demisie' && previous === 'Demisie' && resignationDateInput){
        resignationDateInput.value = '';
      }
      statusSelect.dataset.prevValue = current;
      updateStatusFormVisibility();
    });

    let anonymize = false;
    let hideRoles = false;
    let pdfShowZones = true;
    let pdfShowRoleStats = true;
    let pdfShowSummary = true;
    let pdfShowInactive = true;
    let settingsOpen = false;
    let searchTerm = '';
    let searchTermNormalized = '';
    let searchMatchesInRender = 0;
    let searchNeedsFocus = false;
    function maskFirstName(fullName){
      const raw = (fullName || '').trim();
      if(!raw) return '*****';
      const parts = raw.split(/\s+/);
      if(parts.length === 0) return '*****';
      parts[0] = '*****';
      return parts.join(' ');
    }
    function getDisplayName(p){
      if(!p) return '';
      const actual = p.name || '(fără nume)';
      return anonymize ? maskFirstName(actual) : actual;
    }
    function nameForAlert(p, fallback){
      if(p) return getDisplayName(p);
      if(anonymize) return maskFirstName(fallback || '');
      return fallback || '';
    }

    function refreshSettingsUI(){
      settingsAnonToggle && (settingsAnonToggle.checked = anonymize);
      settingsHideRolesToggle && (settingsHideRolesToggle.checked = hideRoles);
      settingsPdfZonesToggle && (settingsPdfZonesToggle.checked = pdfShowZones);
      settingsPdfRolesToggle && (settingsPdfRolesToggle.checked = pdfShowRoleStats);
      settingsPdfSummaryToggle && (settingsPdfSummaryToggle.checked = pdfShowSummary);
      settingsPdfInactiveToggle && (settingsPdfInactiveToggle.checked = pdfShowInactive);
      if(settingsBtn){
        const pdfDefaultState = pdfShowZones && pdfShowRoleStats && pdfShowSummary && pdfShowInactive;
        settingsBtn.classList.toggle('active', anonymize || hideRoles || !pdfDefaultState);
      }
      updateTimingInputs();
    }

    function msToMinutesValue(ms, fallbackMinutes){
      if(!Number.isFinite(ms) || ms <= 0) return fallbackMinutes;
      return Math.max(1, Math.round(ms / 60000));
    }

    function minutesToMs(value, fallback){
      const parsed = Number.parseFloat(String(value).replace(',', '.'));
      if(!Number.isFinite(parsed) || parsed <= 0) return fallback;
      return Math.round(parsed * 60000);
    }

    function updateTimingInputs(){
      const animationMinutes = msToMinutesValue(inactivityAnimationDelay, Math.round(DEFAULT_ANIMATION_DELAY / 60000));
      const dashboardMinutes = msToMinutesValue(inactivityDashboardDelay, Math.round(DEFAULT_DASHBOARD_DELAY / 60000));
      const passwordMinutes = msToMinutesValue(passwordInactivityDelay, Math.round(DEFAULT_PASSWORD_DELAY / 60000));
      if(settingsAnimationDelayInput){
        settingsAnimationDelayInput.value = animationMinutes;
      }
      if(settingsDashboardDelayInput){
        settingsDashboardDelayInput.value = dashboardMinutes;
      }
      if(settingsPasswordDelayInput){
        settingsPasswordDelayInput.value = passwordMinutes;
      }
    }

    function applyAnimationDelayFromInput(){
      if(!settingsAnimationDelayInput) return;
      const fallbackMs = ensurePositiveMs(inactivityAnimationDelay, DEFAULT_ANIMATION_DELAY);
      const parsed = minutesToMs(settingsAnimationDelayInput.value, fallbackMs);
      inactivityAnimationDelay = ensurePositiveMs(parsed, DEFAULT_ANIMATION_DELAY);
      updateTimingInputs();
      scheduleLocalPersist();
      scheduleInactivityMonitors();
    }

    function applyDashboardDelayFromInput(){
      if(!settingsDashboardDelayInput) return;
      const fallbackMs = ensurePositiveMs(inactivityDashboardDelay, DEFAULT_DASHBOARD_DELAY);
      const parsed = minutesToMs(settingsDashboardDelayInput.value, fallbackMs);
      inactivityDashboardDelay = ensurePositiveMs(parsed, DEFAULT_DASHBOARD_DELAY);
      updateTimingInputs();
      scheduleLocalPersist();
      scheduleInactivityMonitors();
    }

    function applyPasswordDelayFromInput(){
      if(!settingsPasswordDelayInput) return;
      const fallbackMs = ensurePositiveMs(passwordInactivityDelay, DEFAULT_PASSWORD_DELAY);
      const parsed = minutesToMs(settingsPasswordDelayInput.value, fallbackMs);
      passwordInactivityDelay = ensurePositiveMs(parsed, DEFAULT_PASSWORD_DELAY);
      updateTimingInputs();
      scheduleLocalPersist();
      if(typeof reschedulePasswordTimeout === 'function'){
        reschedulePasswordTimeout();
      }
    }

    function setSettingsOpen(open){
      settingsOpen = open;
      if(settingsMenu){
        settingsMenu.classList.toggle('open', open);
        settingsMenu.setAttribute('aria-hidden', open ? 'false' : 'true');
        if(open){
          settingsMenu.scrollIntoView({behavior:'smooth', block:'start'});
        }
      }
      if(settingsBtn){
        settingsBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
      }
      if(!open){
        setDisplaySettingsVisible(false);
        setPdfSettingsVisible(false);
        setRoleManagerVisible(false);
        setTimingSettingsVisible(false);
      }
    }

    function setRoleManagerVisible(show){
      if(!roleManagerPanel) return;
      const visible = !!show;
      roleManagerPanel.classList.toggle('open', visible);
      if(settingsRoleManagerToggle){
        settingsRoleManagerToggle.textContent = visible ? '🔽 Ascunde gestionare roluri' : '⚙️ Gestionare roluri';
      }
      if(visible){
        renderRoleManager();
      }
    }

    function setTimingSettingsVisible(show){
      if(!settingsTimingPanel || !settingsTimingToggle) return;
      const visible = !!show;
      settingsTimingPanel.classList.toggle('open', visible);
      settingsTimingToggle.textContent = visible ? '🔽 Ascunde setări timpi' : '⚙️ Setări timpi';
    }

    function setDisplaySettingsVisible(show){
      if(!settingsDisplayPanel || !settingsDisplayToggle) return;
      const visible = !!show;
      settingsDisplayPanel.classList.toggle('open', visible);
      settingsDisplayToggle.textContent = visible ? '🔽 Ascunde setări afișare' : '⚙️ Setări afișare';
    }

    function setPdfSettingsVisible(show){
      if(!settingsPdfPanel || !settingsPdfToggle) return;
      const visible = !!show;
      settingsPdfPanel.classList.toggle('open', visible);
      settingsPdfToggle.textContent = visible ? '🔽 Ascunde setări raport PDF' : '⚙️ Setări raport PDF';
    }

    dashboardBackButton?.addEventListener('click', (event)=>{
      event.preventDefault();
      exitDashboardDetailFullscreen();
    });

    settingsBtn?.addEventListener('click', (e)=>{
      e.stopPropagation();
      if(!settingsOpen){
        const panelTabBtn = document.querySelector('.tab[data-tab="panel"]');
        if(panelTabBtn && !panelTabBtn.classList.contains('active')){
          panelTabBtn.click();
        }
      }
      setSettingsOpen(!settingsOpen);
    });

    document.addEventListener('click', (e)=>{
      const target = e.target;

      if(settingsOpen && !(settingsMenu?.contains(target) || settingsBtn?.contains(target))){
        setSettingsOpen(false);
      }

      if(!selected) return;
      const keepSelection = target.closest('.zoneBox')
        || target.closest('.personRow')
        || target.closest('#zoneForm')
        || target.closest('#personForm')
        || target.closest('#deleteSelected')
        || target.closest('#applyZone')
        || target.closest('#applyPerson')
        || target.closest('#settingsMenu')
        || target.closest('.settingsWrapper')
        || target.closest('#settingsBtn')
        || target.closest('#settingsRoleManagerToggle')
        || target.closest('#settingsDisplayToggle')
        || target.closest('#settingsPdfToggle')
        || target.closest('#settingsDisplayPanel')
        || target.closest('#settingsPdfPanel')
        || target.closest('#roleManager');

      if(!keepSelection){
        selected = null;
        render();
      }
    });

    settingsAnonToggle?.addEventListener('change', ()=>{
      anonymize = !!settingsAnonToggle.checked;
      refreshSettingsUI();
      render();
      scheduleLocalPersist();
    });

    settingsHideRolesToggle?.addEventListener('change', ()=>{
      hideRoles = !!settingsHideRolesToggle.checked;
      refreshSettingsUI();
      render();
      scheduleLocalPersist();
    });

    settingsPdfZonesToggle?.addEventListener('change', ()=>{
      pdfShowZones = !!settingsPdfZonesToggle.checked;
      refreshSettingsUI();
      scheduleLocalPersist();
    });

    settingsPdfRolesToggle?.addEventListener('change', ()=>{
      pdfShowRoleStats = !!settingsPdfRolesToggle.checked;
      refreshSettingsUI();
      scheduleLocalPersist();
    });

    settingsPdfSummaryToggle?.addEventListener('change', ()=>{
      pdfShowSummary = !!settingsPdfSummaryToggle.checked;
      refreshSettingsUI();
      scheduleLocalPersist();
    });

      settingsPdfInactiveToggle?.addEventListener('change', ()=>{
        pdfShowInactive = !!settingsPdfInactiveToggle.checked;
        refreshSettingsUI();
        scheduleLocalPersist();
      });

    settingsDisplayToggle?.addEventListener('click', (e)=>{
      e.preventDefault();
      const next = !(settingsDisplayPanel?.classList.contains('open'));
      setDisplaySettingsVisible(next);
    });

    settingsPdfToggle?.addEventListener('click', (e)=>{
      e.preventDefault();
      const next = !(settingsPdfPanel?.classList.contains('open'));
      setPdfSettingsVisible(next);
    });

    settingsTimingToggle?.addEventListener('click', (e)=>{
      e.preventDefault();
      const next = !(settingsTimingPanel?.classList.contains('open'));
      setTimingSettingsVisible(next);
    });

    settingsAnimationDelayInput?.addEventListener('change', applyAnimationDelayFromInput);
    settingsAnimationDelayInput?.addEventListener('blur', applyAnimationDelayFromInput);
    settingsDashboardDelayInput?.addEventListener('change', applyDashboardDelayFromInput);
    settingsDashboardDelayInput?.addEventListener('blur', applyDashboardDelayFromInput);
    settingsPasswordDelayInput?.addEventListener('change', applyPasswordDelayFromInput);
    settingsPasswordDelayInput?.addEventListener('blur', applyPasswordDelayFromInput);

    settingsRoleManagerToggle?.addEventListener('click', (e)=>{
      e.preventDefault();
      const next = !(roleManagerPanel?.classList.contains('open'));
      setRoleManagerVisible(next);
    });

    setDisplaySettingsVisible(false);
    setPdfSettingsVisible(false);
    setSettingsOpen(false);
    setRoleManagerVisible(false);
    restoreFromLocalStorage();
    refreshSettingsUI();

    // ======= Utilitare =======
    function todayStr(){
      const d = new Date();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${m}-${day}`;
    }
    function parseDateValue(value){
      if(!value && value !== 0) return null;
      if(value instanceof Date){
        return isNaN(value.getTime()) ? null : value;
      }
      if(typeof value === 'number'){
        const date = new Date(value);
        return isNaN(date.getTime()) ? null : date;
      }
      const str = String(value).trim();
      if(!str) return null;
      const isoMatch = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(isoMatch){
        const year = Number(isoMatch[1]);
        const month = Number(isoMatch[2]);
        const day = Number(isoMatch[3]);
        if(Number.isFinite(year) && Number.isFinite(month) && Number.isFinite(day)){
          const candidate = new Date(year, month - 1, day);
          if(candidate.getFullYear() === year && candidate.getMonth() === month - 1 && candidate.getDate() === day){
            return candidate;
          }
        }
      }
      const parsed = Date.parse(str);
      if(Number.isNaN(parsed)) return null;
      const parsedDate = new Date(parsed);
      return isNaN(parsedDate.getTime()) ? null : parsedDate;
    }
    function formatDateDMY(value, separator = '/'){
      const date = parseDateValue(value);
      if(!date) return '';
      const day = String(date.getDate()).padStart(2,'0');
      const month = String(date.getMonth()+1).padStart(2,'0');
      const year = date.getFullYear();
      return `${day}${separator}${month}${separator}${year}`;
    }
    function niceDate(iso){
      const formatted = formatDateDMY(iso, '/');
      return formatted || '—';
    }
    function sanitizeFolderName(input){
      if(typeof input !== 'string') return '';
      const trimmed = input.trim().replace(/[\\/:*?"<>|]+/g,'').replace(/\s+/g,' ').trim();
      return trimmed.slice(0, 80);
    }
    function formatFolderForFile(input){
      const sanitized = sanitizeFolderName(input);
      if(!sanitized) return '';
      return sanitized.replace(/\s+/g,'-');
    }
    function getCurrentMonthLabel(){
      let base;
      if(workDate?.value){
        base = new Date(workDate.value+'T00:00:00');
      }
      if(!base || isNaN(base.getTime())){
        base = new Date();
      }
      return base.toLocaleDateString('ro-RO', { month:'long', year:'numeric' });
    }
    function extractMonthKeyFromDate(value){
      if(!value) return '';
      const trimmed = String(value).trim();
      if(!trimmed) return '';
      const match = trimmed.match(/^(\d{4})-(\d{2})/);
      if(!match) return '';
      const year = Number(match[1]);
      const month = Number(match[2]);
      if(!Number.isFinite(year) || !Number.isFinite(month) || month < 1 || month > 12) return '';
      return `${match[1]}-${match[2]}`;
    }
    function formatMonthKeyToLabel(key){
      if(!key) return '';
      const parts = key.split('-');
      if(parts.length < 2) return '';
      const year = Number(parts[0]);
      const monthIndex = Number(parts[1]) - 1;
      if(!Number.isFinite(year) || !Number.isFinite(monthIndex) || monthIndex < 0 || monthIndex > 11) return '';
      const date = new Date(year, monthIndex, 1);
      if(isNaN(date.getTime())) return '';
      return date.toLocaleDateString('ro-RO', { month:'long', year:'numeric' });
    }
    function getDominantMonthLabelFromContexts(contexts){
      if(!Array.isArray(contexts) || !contexts.length) return getCurrentMonthLabel();
      const counts = new Map();
      contexts.forEach(ctx=>{
        const key = extractMonthKeyFromDate(ctx?.entry?.date || '');
        if(!key) return;
        counts.set(key, (counts.get(key) || 0) + 1);
      });
      if(!counts.size) return getCurrentMonthLabel();
      let chosenKey = '';
      let chosenCount = 0;
      counts.forEach((count, key)=>{
        if(count > chosenCount || (count === chosenCount && key > chosenKey)){
          chosenKey = key;
          chosenCount = count;
        }
      });
      const label = formatMonthKeyToLabel(chosenKey);
      return label || getCurrentMonthLabel();
    }
    const numberFormatter = new Intl.NumberFormat('ro-RO', { maximumFractionDigits: 2 });
    function parseNumericInput(value){
      if(value === null || value === undefined) return NaN;
      if(typeof value === 'number') return Number.isFinite(value) ? value : NaN;
      const str = String(value).trim();
      if(!str) return NaN;
      const normalized = str.replace(',', '.');
      const num = Number(normalized);
      return Number.isFinite(num) ? num : NaN;
    }
    function formatNumber(value){
      return numberFormatter.format(value);
    }
    function normName(n){ return (n||'').trim().toLowerCase(); }
    function matchesSearchTerm(person){
      if(!searchTermNormalized) return false;
      return normName(person?.name).includes(searchTermNormalized);
    }
    function uniqueRoles(list){
      const s=new Set(), out=[];
      (list||[]).forEach(r=>{
        if(typeof r==='string'){
          const t=r.trim(); if(t && !s.has(t)){ s.add(t); out.push(t); }
        }
      });
      return out;
    }
    function normalizeRoles(list){
      return uniqueRoles((Array.isArray(list)?list:[]).map(r=> typeof r==='string'? r : (r&&r.name)||''));
    }
    const EXCLUDED_ROLES = new Set(['TESA','Magazioner','Sef Echipa']);
    const VERSION_HISTORY = [
      {
        version: 'v1.3.1',
        date: '27 ianuarie 2026',
        changes: [
          'Cardurile din dashboard nu se mai măresc la click; animația se oprește imediat ce sunt accesate detaliile statistice.',
          'Istoricul versiunilor a fost actualizat cu ultimele livrări pentru ca butonul dedicat să reflecte starea curentă.',
          'Tabul Rapoarte permite adăugarea mai multor activități pentru aceeași echipă, fiecare cu cantitate și unitate proprie, direct din tabel.'
        ]
      },
      {
        version: 'v1.3.0',
        date: '20 ianuarie 2026',
        changes: [
          'Buton de versiune cu listă cronologică a tuturor cerințelor implementate și acces rapid la notele de lansare.',
          'Eliminarea animației automate a cardurilor la inactivitate și menținerea panoului static fără redirecționare către Panou.',
          'Cardul pentru fronturi de lucru active redenumit, recalculat și mutat lângă totalurile oamenilor și taskurilor deschise.',
          'Cardul principal redenumit „Total oameni” pentru a alinia terminologia cu cerințele actuale.',
          'Mesajul pentru „Total oameni astăzi” actualizat să facă referire la fronturi de lucru active.',
          'Panoul landing extins pe toată lățimea ferestrei pentru a se alinia cu layoutul taburilor principale.'
        ]
      },
      {
        version: 'v1.2.0',
        date: '2 decembrie 2025',
        changes: [
          'Adăugare căutare rapidă și evidențiere pentru persoane, împreună cu semnalarea duplicatelor în selecții.',
          'Setări grupate sub rotița din toolbar: gestionare roluri, opțiuni de afișare și secțiuni configurabile pentru raportul PDF.',
          'Import rapid de persoane multiple cu rol implicit Sudor și relocarea automată a oamenilor la nealocați la ștergerea zonelor.',
          'Tabul Taskuri refăcut cu ordonare prin drag & drop, comentarii editabile, arhivare automată, statistici zilnice/lunare și export PDF.',
          'Butoane reproiectate (inclusiv salvare verde) și personalizare cromatică pentru Taskuri și exporturile PDF.',
          'Toggle global de Anonimizare care maschează doar primul prenume și ascundere opțională a rolurilor în UI/PDF.',
          'Perioadele CO/CM afișate în rapoarte (reducerea la o singură zi când se aplică) și iconițe cu căști colorate pentru zone în PDF.',
          'Salvare automată a bazei de date JSON la fiecare oră, buton dedicat de salvare lângă taburi și configurarea folderului bazei din aplicație.'
        ]
      },
      {
        version: 'v1.1.0',
        date: '5 noiembrie 2025',
        changes: [
          'Tabul Rapoarte ecran complet cu selecție din activi/inactivi, totaluri inline și export PDF/Excel.',
          'Adăugare persoane pe același criteriu direct din selecție, păstrând datele comune și calculele automate ale totalului.',
          'Copiere rapidă de linii, numerotare configurabilă și avertizare roșie când o persoană apare de mai multe ori.',
          'Coloane dedicate pentru dată, ore lucrate și total, plus colorarea benzilor Nr. crt. în funcție de persoană.',
          'Salvare/încărcare rapoarte cu editare in-place fără renumerotare și actualizare automată a câmpului firmă.',
          'Sinteză pe persoane ordonată după total, împărțirea sumelor pe membri ai echipei și tabel suplimentar cu nume unice în PDF.',
          'Export Excel în format .xlsx cu formule păstrate și evidențierea totalurilor RON/EUR.',
          'Validări suplimentare (firmă obligatorie, mesaje duplicate, curățarea tabelului după salvare) și personalizare culori/fonturi în PDF.'
        ]
      },
      {
        version: 'v1.0.2',
        date: '18 octombrie 2025',
        changes: [
          'Dashboard principal cu ceas live, animație pe carduri și ticker de taskuri active.',
          'Configurări pentru temporizările de parolă, revenire la dashboard și animație, plus revenire automată din taburi după inactivitate.',
          'Full-screen pentru dashboard la inactivitate și posibilitatea de a ieși din animație/FS printr-un simplu click.',
          'Metri pentru „Total oameni astăzi” împărțiți între Directi și TESA/Magazioner/Șef echipă, cu actualizări live.',
          'Layout-urile Panou/Grafic/Taskuri/Rapoarte extinse pe tot ecranul și grafic Gantt responsive pentru fronturi.'
        ]
      },
      {
        version: 'v1.0.1',
        date: '28 septembrie 2025',
        changes: [
          'Editor de selecție pentru zone și persoane cu validări de duplicate și mutare prin drag & drop.',
          'Pools pentru nealocați, CO și CM cu numărători dedicate și schimbarea statusului direct din formular.',
          'Statistici pe roluri, total Directi și control al rolurilor (adăugare, redenumire, ștergere) cu păstrarea culorilor.',
          'Import/export JSON și PDF pentru harta șantierului, plus setări de parolă și monitorizare inactivitate (5 minute).',
          'Toolbar extins cu adăugare zonă/persoană/rol și mesaj de avertizare pentru salvări nescrise.'
        ]
      },
      {
        version: 'v1.0.0',
        date: '14 septembrie 2025',
        changes: [
          'Structură inițială cu taburi Panou, Grafic, Taskuri și Rapoarte într-un singur fișier index.html.',
          'Gestionare de fronturi, roluri și persoane, inclusiv statusuri active/inactive și numărări agregate.',
          'Taskuri de lucru cu arhivare, statistici și export inițial, plus rapoarte PDF/Excel bazate pe selecțiile din aplicație.',
          'Persistență locală a datelor, auto-salvare și importuri JSON pentru backup rapid.',
          'Animații și stilizare modernă pentru carduri, liste și toolbar-uri.'
        ]
      }
    ];
    const APP_VERSION = VERSION_HISTORY.length ? VERSION_HISTORY[0].version : 'v0.0.0';
    function roleKey(role){ return (role || '').trim(); }
    function isDirect(p){
      if(!p) return false;
      return !EXCLUDED_ROLES.has(roleKey(p.role));
    }
    function isActive(p){ return !p || !p.status || p.status === 'Activ'; }
    function isInactiveCO(p){ return p?.status === 'Inactiv CO'; }
    function isInactiveCM(p){ return p?.status === 'Inactiv CM'; }
    function isResigned(p){ return p?.status === 'Demisie'; }

    // ======= Inițializare dată =======
    function initDate(){
      let saved = restoredDateOverride || localStorage.getItem('workDate');
      if(restoredDateOverride){
        try { localStorage.setItem('workDate', restoredDateOverride); } catch(_err){}
        restoredDateOverride = null;
      }
      workDate.value = saved || todayStr();
      dateLabel.textContent = niceDate(workDate.value);
    }

    // ======= Render general =======
    function render(){
      refreshSettingsUI();
      searchMatchesInRender = 0;
      zonesWrap.innerHTML = '';
      const ordered = [...zones].sort((a,b)=>a.gridIndex-b.gridIndex);
      ordered.forEach((z) => zonesWrap.appendChild(renderZone(z)));
      renderForms();
      renderStats();
      renderPools();
      const rmPanel = document.getElementById('roleManager');
      if(rmPanel?.classList.contains('open')) renderRoleManager();
      renderZoneChips();
      renderGantt();
      renderTasks();
      renderReports();
      highlight();
      validateDuplicates(true);
      updateHeaderTotals();
      updateDatabaseFolderLabel();
      updateSearchFeedback();
      if(searchTermNormalized && searchNeedsFocus){
        const firstMatch = document.querySelector('.personRow.search-hit');
        if(firstMatch){
          firstMatch.scrollIntoView({behavior:'smooth', block:'center'});
        }
        searchNeedsFocus = false;
      } else if(!searchTermNormalized){
        searchNeedsFocus = false;
      }
    }

    // ======= Header total =======
    function updateHeaderTotals(){
      if(allPeopleCount) allPeopleCount.textContent = String(people.filter(p=>!isResigned(p)).length);
    }

    // ======= Istoric versiuni =======
    function renderVersionHistory(){
      if(!versionContentEl) return;
      versionContentEl.innerHTML = '';
      VERSION_HISTORY.forEach(entry => {
        const section = document.createElement('section');
        section.className = 'versionEntry';
        const title = document.createElement('h4');
        title.textContent = entry.version;
        section.appendChild(title);
        if(Array.isArray(entry.changes) && entry.changes.length){
          const list = document.createElement('ul');
          entry.changes.forEach(text => {
            const li = document.createElement('li');
            li.textContent = text;
            list.appendChild(li);
          });
          section.appendChild(list);
        }
        versionContentEl.appendChild(section);
      });
    }

    function openVersionModal(){
      if(!versionModal) return;
      renderVersionHistory();
      versionModal.classList.add('show');
      versionModal.setAttribute('aria-hidden', 'false');
      document.body.classList.add('version-modal-open');
      const focusTarget = versionContentEl || versionCloseBtn;
      if(focusTarget && typeof focusTarget.focus === 'function'){
        focusTarget.focus();
      }
    }

    function closeVersionModal(){
      if(!versionModal) return;
      versionModal.classList.remove('show');
      versionModal.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('version-modal-open');
      if(versionButton && typeof versionButton.focus === 'function'){
        versionButton.focus();
      }
    }

    function updateDatabaseFolderLabel(){
      if(!databaseFolderLabel) return;
      if(databaseFolder){
        databaseFolderLabel.textContent = `Folder salvare preferat: ${databaseFolder}`;
      } else {
        databaseFolderLabel.textContent = 'Folder salvare: implicit (descărcări)';
      }
    }

    function updateSearchFeedback(){
      if(!personSearchInput) return;
      const hasQuery = !!searchTermNormalized;
      personSearchInput.classList.toggle('has-query', hasQuery);
      personSearchInput.classList.toggle('not-found', hasQuery && searchMatchesInRender === 0);
      if(hasQuery){
        personSearchInput.title = searchMatchesInRender
          ? `${searchMatchesInRender} rezultate găsite`
          : 'Nicio persoană găsită';
      } else {
        personSearchInput.title = 'Căutare rapidă după nume';
      }
    }

    // ======= Zone & Persoane =======
    function renderZone(z){
      const box = document.createElement('div');
      box.className = 'zoneBox' + (selected && selected.type==='zone' && selected.id===z.id ? ' active' : '');
      box.dataset.zoneId = z.id;
      box.addEventListener('click', (e)=>{ e.stopPropagation(); select({type:'zone', id:z.id}); });
      box.addEventListener('dragover', (e)=>{ e.preventDefault(); });
      box.addEventListener('drop', onDropPerson);

      const header = document.createElement('div'); header.className = 'zoneHeader'; header.textContent = z.name || '\u00A0';
      const list = document.createElement('div'); list.className = 'zoneList';

      // în zone afişăm DOAR persoanele ACTIVE alocate la această zonă
      people.filter(p=>p && p.zoneId===z.id && isActive(p)).forEach(p=> list.appendChild(renderPersonRow(p)) );

      if(searchTermNormalized && people.some(p=>p && p.zoneId===z.id && isActive(p) && matchesSearchTerm(p))){
        box.classList.add('search-hit');
      }

      box.appendChild(header); box.appendChild(list);
      return box;
    }

    function renderPersonRow(p){
      const row = document.createElement('div'); row.className = 'personRow'; row.draggable = true; row.dataset.personId = p.id;
      row.addEventListener('dragstart', (e)=>{ row.classList.add('dragGhost'); e.dataTransfer.setData('text/plain', p.id); });
      row.addEventListener('dragend', ()=>row.classList.remove('dragGhost'));
      row.addEventListener('click', (e)=>{ e.stopPropagation(); select({type:'person', id:p.id}); });

      if(!isActive(p)) row.classList.add('inactive');

      const c = getRoleColor(p.role||'—');
      const bullet = document.createElement('span'); bullet.className='bullet'; bullet.style.background=c.border; bullet.style.borderColor=c.border;
      const title = document.createElement('div'); title.style.flex='1'; title.style.display='flex'; title.style.gap='8px'; title.style.alignItems='center';
      const name = document.createElement('span'); name.textContent = getDisplayName(p) || '(fără nume)';
      title.appendChild(name);
      if(!hideRoles){
        const role = document.createElement('span'); role.className = 'role'; role.textContent = p.role || '—';
        role.style.background = c.bg; role.style.borderColor = c.border;
        title.appendChild(document.createTextNode(' – '));
        title.appendChild(role);
      }

      if(p.status && p.status!=='Activ'){
        const st = document.createElement('span');
        st.className='status';
        let txt = '';
        if(p.status === 'Inactiv CO'){
          txt = 'CO';
        } else if(p.status === 'Inactiv CM'){
          txt = 'CM';
        } else if(p.status === 'Demisie'){
          txt = 'Demisie';
          if(p.resignationDate){
            txt += ` ${p.resignationDate}`;
          }
        } else {
          txt = p.status;
        }
        if(p.status !== 'Demisie' && (p.inactiveFrom || p.inactiveTo)){
          if(p.inactiveFrom && p.inactiveTo && p.inactiveFrom === p.inactiveTo){
            txt += ` ${p.inactiveFrom}`;
          } else {
            txt += ` ${p.inactiveFrom || ''}`;
            if(p.inactiveTo) txt += `-${p.inactiveTo}`;
          }
        }
        st.textContent = txt;
        title.appendChild(st);
      }

      row.appendChild(bullet); row.appendChild(title);
      if(selected && selected.type==='person' && selected.id===p.id) row.classList.add('selected');
      if(isNameDuplicatedExcluding(p.name, p.id)) row.classList.add('dup');
      if(matchesSearchTerm(p)){
        row.classList.add('search-hit');
        searchMatchesInRender++;
      }
      return row;
    }

    function onDropPerson(e){
      e.preventDefault();
      const pid = e.dataTransfer.getData('text/plain');
      const zId = e.currentTarget.dataset.zoneId;
      movePersonToZone(pid, zId);
    }

    function isNameDuplicatedExcluding(name, excludeId){
      const n = normName(name); if(!n) return false;
      return people.some(q=> q && q.id!==excludeId && normName(q.name)===n);
    }

    function movePersonToZone(personId, targetZoneId){
      const p = people.find(x=>x && x.id===personId); if(!p) return;
      const displayName = getDisplayName(p);
      if(!isActive(p)){ showDupAlert(`${displayName} este inactiv (${p.status}). Schimbă statusul la "Activ" pentru a-l aloca într-o zonă.`); return; }
      if(isNameDuplicatedExcluding(p.name, p.id)){
        showDupAlert(`${displayName} există deja ca persoană distinctă. Te rog redenumește unul dintre înregistrări.`);
        return;
      }
      p.zoneId = targetZoneId; render(); markDirty();
    }

    // ======= Pools (nealocați activi, CO, CM) =======
    function renderPools(){
      renderPoolActive();
      renderPoolCO();
      renderPoolCM();
      renderPoolResigned();
    }

    function renderPoolActive(){
      poolActive.innerHTML='';
      const listActiveUnassigned = people.filter(p=> p && isActive(p) && !p.zoneId);
      togglePoolActiveBtn.textContent = `Afișare oameni nealocați (${listActiveUnassigned.length})`;
      const highlightPool = !!searchTermNormalized && listActiveUnassigned.some(matchesSearchTerm);
      poolActive.classList.toggle('search-hit', highlightPool);
      const activeWrap = poolActive.closest('.unassignedWrap');
      if(activeWrap) activeWrap.classList.toggle('search-hit', highlightPool);
      if(togglePoolActiveBtn) togglePoolActiveBtn.classList.toggle('search-hit', highlightPool);

      if(listActiveUnassigned.length===0){
        const empty = document.createElement('div'); empty.className='pool empty'; empty.textContent='Nu sunt persoane nealocate (active).'; poolActive.appendChild(empty);
      } else {
        const list = document.createElement('div'); list.className='pool';
        listActiveUnassigned.forEach(p=> list.appendChild(renderPersonRow(p)) );
        poolActive.appendChild(list);
      }
      poolActive.addEventListener('dragover', (e)=>{ e.preventDefault(); });
      poolActive.addEventListener('drop', (e)=>{
        e.preventDefault();
        const pid = e.dataTransfer.getData('text/plain');
        const p = people.find(x=>x && x.id===pid); if(!p) return;
        if(!isActive(p)){ showDupAlert(`${getDisplayName(p)} este inactiv (${p.status}).`); return; }
        p.zoneId = null; render(); markDirty();
      });
    }

    function renderPoolCO(){
      poolCO.innerHTML='';
      const listCO = people.filter(p=> isInactiveCO(p));
      togglePoolCOBtn.textContent = `Afișare oameni CO (${listCO.length})`;
      const highlightPool = !!searchTermNormalized && listCO.some(matchesSearchTerm);
      poolCO.classList.toggle('search-hit', highlightPool);
      const coWrap = poolCO.closest('.unassignedWrap');
      if(coWrap) coWrap.classList.toggle('search-hit', highlightPool);
      if(togglePoolCOBtn) togglePoolCOBtn.classList.toggle('search-hit', highlightPool);

      if(listCO.length===0){
        const empty = document.createElement('div'); empty.className='pool empty'; empty.textContent='Nu sunt persoane în CO.'; poolCO.appendChild(empty);
      } else {
        const list = document.createElement('div'); list.className='pool';
        listCO.forEach(p=> list.appendChild(renderPersonRow(p)) );
        poolCO.appendChild(list);
      }
      poolCO.addEventListener('dragover', (e)=>{ e.preventDefault(); });
      poolCO.addEventListener('drop', (e)=>{ e.preventDefault(); showDupAlert('Persoanele CO nu pot fi mutate aici prin drag & drop. Schimbă statusul la "Inactiv CO" din editor.'); });
    }

    function renderPoolCM(){
      poolCM.innerHTML='';
      const listCM = people.filter(p=> isInactiveCM(p));
      togglePoolCMBtn.textContent = `Afișare oameni CM (${listCM.length})`;
      const highlightPool = !!searchTermNormalized && listCM.some(matchesSearchTerm);
      poolCM.classList.toggle('search-hit', highlightPool);
      const cmWrap = poolCM.closest('.unassignedWrap');
      if(cmWrap) cmWrap.classList.toggle('search-hit', highlightPool);
      if(togglePoolCMBtn) togglePoolCMBtn.classList.toggle('search-hit', highlightPool);

      if(listCM.length===0){
        const empty = document.createElement('div'); empty.className='pool empty'; empty.textContent='Nu sunt persoane în CM.'; poolCM.appendChild(empty);
      } else {
        const list = document.createElement('div'); list.className='pool';
        listCM.forEach(p=> list.appendChild(renderPersonRow(p)) );
        poolCM.appendChild(list);
      }
      poolCM.addEventListener('dragover', (e)=>{ e.preventDefault(); });
      poolCM.addEventListener('drop', (e)=>{ e.preventDefault(); showDupAlert('Persoanele CM nu pot fi mutate aici prin drag & drop. Schimbă statusul la "Inactiv CM" din editor.'); });
    }

    function renderPoolResigned(){
      if(!poolResigned) return;
      poolResigned.innerHTML='';
      const listResigned = people.filter(p=> isResigned(p));
      if(togglePoolResignedBtn){
        togglePoolResignedBtn.textContent = `Afișare demisionați (${listResigned.length})`;
      }
      const highlightPool = !!searchTermNormalized && listResigned.some(matchesSearchTerm);
      poolResigned.classList.toggle('search-hit', highlightPool);
      const resignedWrap = poolResigned.closest('.unassignedWrap');
      if(resignedWrap) resignedWrap.classList.toggle('search-hit', highlightPool);
      if(togglePoolResignedBtn) togglePoolResignedBtn.classList.toggle('search-hit', highlightPool);

      if(listResigned.length === 0){
        const empty = document.createElement('div');
        empty.className = 'pool empty';
        empty.textContent = 'Nu sunt persoane demisionate.';
        poolResigned.appendChild(empty);
      } else {
        const list = document.createElement('div');
        list.className = 'pool';
        listResigned.forEach(p=> list.appendChild(renderPersonRow(p)) );
        poolResigned.appendChild(list);
      }
    }

    togglePoolActiveBtn.addEventListener('click', ()=>{
      const vis = poolActive.style.display !== 'none';
      poolActive.style.display = vis ? 'none' : 'block';
    });
    togglePoolCOBtn.addEventListener('click', ()=>{
      const vis = poolCO.style.display !== 'none';
      poolCO.style.display = vis ? 'none' : 'block';
    });
    togglePoolCMBtn.addEventListener('click', ()=>{
      const vis = poolCM.style.display !== 'none';
      poolCM.style.display = vis ? 'none' : 'block';
    });
    togglePoolResignedBtn?.addEventListener('click', ()=>{
      if(!poolResigned) return;
      const vis = poolResigned.style.display !== 'none';
      poolResigned.style.display = vis ? 'none' : 'block';
    });

    function applySearchTerm(raw){
      const value = typeof raw === 'string' ? raw : '';
      if(value === searchTerm){
        if(!searchTermNormalized) searchNeedsFocus = false;
        return;
      }
      searchTerm = value;
      searchTermNormalized = normName(value);
      searchNeedsFocus = !!searchTermNormalized;
      render();
    }

    personSearchInput?.addEventListener('input', ()=> applySearchTerm(personSearchInput.value));
    personSearchInput?.addEventListener('search', ()=> applySearchTerm(personSearchInput.value));

    // ======= Taskuri =======
    function normalizeDateString(value){
      if(!value) return '';
      return String(value).slice(0,10);
    }

    let draggedTaskId = null;

    function ensureTaskDefaults(task){
      if(!task) return false;
      let changed = false;
      if(!task.id){
        task.id = 't'+Math.random().toString(36).slice(2,7);
        changed = true;
      }
      if(typeof task.name !== 'string'){
        task.name = task.name ? String(task.name) : '';
        changed = true;
      }
      if(typeof task.comment !== 'string'){
        task.comment = task.comment ? String(task.comment) : '';
        changed = true;
      }
      const normalizedCreated = normalizeDateString(task.createdAt);
      if(!normalizedCreated){
        task.createdAt = todayStr();
        changed = true;
      } else if(task.createdAt !== normalizedCreated){
        task.createdAt = normalizedCreated;
        changed = true;
      }
      if(task.done){
        const normalizedClosed = normalizeDateString(task.closedAt);
        if(!normalizedClosed){
          task.closedAt = todayStr();
          changed = true;
        } else if(task.closedAt !== normalizedClosed){
          task.closedAt = normalizedClosed;
          changed = true;
        }
      } else if(task.closedAt === undefined){
        task.closedAt = '';
        changed = true;
      } else {
        const normalizedClosed = normalizeDateString(task.closedAt);
        if(task.closedAt !== normalizedClosed){
          task.closedAt = normalizedClosed;
          changed = true;
        }
      }
      return changed;
    }

    function mapImportedTask(raw){
      const created = normalizeDateString(raw?.createdAt) || todayStr();
      let closed = normalizeDateString(raw?.closedAt);
      const task = {
        id: raw && raw.id ? String(raw.id) : 't'+Math.random().toString(36).slice(2,7),
        name: typeof raw?.name === 'string' ? raw.name : '',
        comment: typeof raw?.comment === 'string' ? raw.comment : '',
        done: !!raw?.done,
        createdAt: created,
        closedAt: closed || ''
      };
      if(task.done && !task.closedAt){
        task.closedAt = todayStr();
      }
      return task;
    }

    function editTaskName(task){
      const response = prompt('Editează task:', task.name || '');
      if(response === null) return;
      const trimmed = response.trim();
      if(!trimmed) return;
      task.name = trimmed;
      renderTasks();
      markDirty();
    }

    function editTaskComment(task){
      const response = prompt(`Comentariu pentru "${task.name || 'Task'}"`, task.comment || '');
      if(response === null) return;
      task.comment = response.trim();
      renderTasks();
      markDirty();
    }

    function createCommentCell(task){
      const td = document.createElement('td');
      td.className = 'taskComment';
      if(task.comment){
        td.textContent = task.comment;
      } else {
        td.classList.add('empty');
        td.textContent = 'Adaugă comentariu';
      }
      td.title = 'Click pentru a edita comentariul';
      td.addEventListener('click', ()=> editTaskComment(task));
      return td;
    }

    function resetTaskDropVisuals(){
      if(!tasksTableBody) return;
      tasksTableBody.classList.remove('drop-target-end');
      tasksTableBody.querySelectorAll('.drop-target').forEach(el=>el.classList.remove('drop-target'));
    }

    function handleTaskDragStart(e){
      draggedTaskId = e.currentTarget.dataset.taskId;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', draggedTaskId);
      e.currentTarget.classList.add('dragging');
    }

    function handleTaskDragEnd(e){
      e.currentTarget.classList.remove('dragging');
      resetTaskDropVisuals();
      draggedTaskId = null;
    }

    function handleTaskDragOver(e){
      if(!draggedTaskId) return;
      const row = e.currentTarget;
      if(row.dataset.taskId === draggedTaskId) return;
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      resetTaskDropVisuals();
      row.classList.add('drop-target');
    }

    function handleTaskDragLeave(e){
      e.currentTarget.classList.remove('drop-target');
    }

    function handleTaskDrop(e){
      if(!draggedTaskId) return;
      e.preventDefault();
      const targetRow = e.currentTarget;
      const targetId = targetRow.dataset.taskId;
      if(!targetId || targetId === draggedTaskId){
        resetTaskDropVisuals();
        return;
      }
      const fromIdx = tasks.findIndex(t=>t.id===draggedTaskId);
      const toIdx = tasks.findIndex(t=>t.id===targetId);
      if(fromIdx === -1 || toIdx === -1){
        resetTaskDropVisuals();
        return;
      }
      const rect = targetRow.getBoundingClientRect();
      const dropAfter = e.clientY > rect.top + rect.height/2;
      const [moved] = tasks.splice(fromIdx,1);
      let newIndex = toIdx;
      if(dropAfter){
        if(fromIdx < toIdx) newIndex = toIdx;
        else newIndex = toIdx + 1;
      } else {
        if(fromIdx < toIdx) newIndex = toIdx - 1;
        else newIndex = toIdx;
      }
      if(newIndex < 0) newIndex = 0;
      if(newIndex > tasks.length) newIndex = tasks.length;
      tasks.splice(newIndex, 0, moved);
      resetTaskDropVisuals();
      renderTasks();
      markDirty();
    }

    function handleTaskTableDragOver(e){
      if(!draggedTaskId) return;
      const row = e.target.closest('tr');
      if(row) return;
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      tasksTableBody.classList.add('drop-target-end');
    }

    function handleTaskTableDrop(e){
      if(!draggedTaskId) return;
      const row = e.target.closest('tr');
      if(row) return;
      e.preventDefault();
      const fromIdx = tasks.findIndex(t=>t.id===draggedTaskId);
      if(fromIdx === -1) return;
      const [moved] = tasks.splice(fromIdx,1);
      tasks.push(moved);
      resetTaskDropVisuals();
      renderTasks();
      markDirty();
    }

    function handleTaskTableDragLeave(e){
      if(!draggedTaskId) return;
      if(e.currentTarget.contains(e.relatedTarget)) return;
      tasksTableBody.classList.remove('drop-target-end');
    }

    function sortMapEntries(map){
      return Array.from(map.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
    }

    function formatBreakdownHtml(map, formatter){
      if(!map || map.size===0) return '<div class="muted">—</div>';
      return `<ul>${sortMapEntries(map).map(([key,count])=>`<li>${formatter(key)} – ${count}</li>`).join('')}</ul>`;
    }

    function formatBreakdownPlain(map, formatter){
      if(!map || map.size===0) return '—';
      return sortMapEntries(map).map(([key,count])=>`${formatter(key)} – ${count}`).join(', ');
    }

    function formatMonthLabel(monthKey){
      if(!monthKey) return '—';
      const [year, month] = monthKey.split('-');
      if(!year || !month) return monthKey;
      const date = new Date(Number(year), Number(month)-1, 1);
      if(Number.isNaN(date.getTime())) return monthKey;
      return date.toLocaleDateString('ro-RO', { month:'long', year:'numeric' });
    }

    function getTaskStatsData(){
      const all = [...tasks, ...tasksArchive];
      const openCount = all.filter(t=>!t.done).length;
      const closed = all.filter(t=>t.done);
      const daily = new Map();
      const monthly = new Map();
      closed.forEach(t=>{
        const day = normalizeDateString(t.closedAt);
        if(!day) return;
        daily.set(day, (daily.get(day)||0)+1);
        const month = day.slice(0,7);
        if(month) monthly.set(month, (monthly.get(month)||0)+1);
      });
      return { openCount, closedCount: closed.length, daily, monthly };
    }

    function syncTaskSettingsControls(){
      if(taskSettingsActiveToggle) taskSettingsActiveToggle.checked = !!taskPdfShowActive;
      if(taskSettingsArchiveToggle) taskSettingsArchiveToggle.checked = !!taskPdfShowArchive;
      if(taskSettingsStatsToggle) taskSettingsStatsToggle.checked = !!taskPdfShowStats;
    }

    function setTaskSettingsOpen(open){
      taskSettingsOpen = !!open;
      if(taskSettingsMenu){
        taskSettingsMenu.classList.toggle('open', taskSettingsOpen);
        taskSettingsMenu.setAttribute('aria-hidden', taskSettingsOpen ? 'false' : 'true');
      }
      if(taskSettingsBtn){
        taskSettingsBtn.setAttribute('aria-expanded', taskSettingsOpen ? 'true' : 'false');
        taskSettingsBtn.classList.toggle('active', taskSettingsOpen);
      }
      syncTaskSettingsControls();
    }

    function renderTasks(){
      if(!tasksTableBody || !archiveTableBody) return;
      let mutated = false;
      tasks.forEach(t=>{ if(ensureTaskDefaults(t)) mutated = true; });
      tasksArchive.forEach(t=>{ if(ensureTaskDefaults(t)) mutated = true; });
      if(mutated) markDirty();

      syncTaskSettingsControls();
      if(archiveContainer){
        archiveContainer.classList.toggle('open', taskArchiveVisible);
        archiveContainer.setAttribute('aria-hidden', taskArchiveVisible ? 'false' : 'true');
      }
      if(toggleArchiveBtn){
        toggleArchiveBtn.textContent = taskArchiveVisible ? 'Ascunde' : 'Afișează';
        toggleArchiveBtn.title = taskArchiveVisible ? 'Ascunde arhiva de taskuri' : 'Afișează arhiva de taskuri';
        toggleArchiveBtn.setAttribute('aria-expanded', taskArchiveVisible ? 'true' : 'false');
      }

      const completed = tasks.filter(t=>t && t.done);
      if(completed.length){
        completed.forEach(t=>{ if(!t.closedAt) t.closedAt = todayStr(); tasksArchive.push(t); });
        tasks = tasks.filter(t=>!t.done);
        markDirty();
      }

      tasksTableBody.innerHTML='';
      tasks.forEach((t, index)=>{
        const tr = document.createElement('tr');
        tr.dataset.taskId = t.id;
        tr.draggable = true;
        tr.addEventListener('dragstart', handleTaskDragStart);
        tr.addEventListener('dragend', handleTaskDragEnd);
        tr.addEventListener('dragover', handleTaskDragOver);
        tr.addEventListener('dragleave', handleTaskDragLeave);
        tr.addEventListener('drop', handleTaskDrop);

        const tdIndex = document.createElement('td');
        tdIndex.className = 'taskIndex';
        tdIndex.textContent = String(index + 1);

        const tdName = document.createElement('td');
        tdName.textContent = t.name || '';
        tdName.className = 'taskName' + (t.done ? ' done' : '');

        const tdComment = createCommentCell(t);

        const tdCreated = document.createElement('td');
        tdCreated.className = 'taskDate';
        tdCreated.textContent = niceDate(t.createdAt);

        const tdClosed = document.createElement('td');
        tdClosed.className = 'taskDate';
        tdClosed.textContent = (t.done && t.closedAt) ? niceDate(t.closedAt) : '—';

        const tdStatus = document.createElement('td');
        tdStatus.className = 'taskStatus';
        const chk = document.createElement('input'); chk.type='checkbox'; chk.checked=!!t.done;
        chk.addEventListener('change', ()=>{
          t.done = chk.checked;
          if(t.done && !t.closedAt) t.closedAt = todayStr();
          renderTasks();
          markDirty();
        });
        tdStatus.appendChild(chk);

        const tdAct = document.createElement('td'); tdAct.className='taskActions';
        const edit = document.createElement('button'); edit.textContent='✏️'; edit.className='ghost'; edit.title='Redenumește';
        edit.addEventListener('click', ()=> editTaskName(t));
        const del = document.createElement('button'); del.textContent='🗑️'; del.className='ghost'; del.title='Șterge';
        del.addEventListener('click', ()=>{
          const idx = tasks.findIndex(x=>x.id===t.id);
          if(idx>-1){ tasks.splice(idx,1); renderTasks(); markDirty(); }
        });
        tdAct.appendChild(edit); tdAct.appendChild(del);

        tr.appendChild(tdIndex);
        tr.appendChild(tdName);
        tr.appendChild(tdComment);
        tr.appendChild(tdCreated);
        tr.appendChild(tdClosed);
        tr.appendChild(tdStatus);
        tr.appendChild(tdAct);
        tasksTableBody.appendChild(tr);
      });

      archiveTableBody.innerHTML='';
      tasksArchive.forEach((t, idx)=>{
        const tr = document.createElement('tr');
        tr.dataset.taskId = t.id;

        const tdName = document.createElement('td');
        tdName.textContent = t.name || '';
        tdName.className = 'taskName' + (t.done ? ' done' : '');

        const tdComment = createCommentCell(t);

        const tdCreated = document.createElement('td');
        tdCreated.className = 'taskDate';
        tdCreated.textContent = niceDate(t.createdAt);

        const tdClosed = document.createElement('td');
        tdClosed.className = 'taskDate';
        tdClosed.textContent = t.closedAt ? niceDate(t.closedAt) : '—';

        const tdStatus = document.createElement('td');
        tdStatus.className = 'taskStatus';
        tdStatus.textContent = t.done ? '✓' : '—';

        const tdAct = document.createElement('td'); tdAct.className='taskActions';
        const restore = document.createElement('button'); restore.textContent='↩️'; restore.className='ghost'; restore.title='Scoate din arhivă';
        restore.addEventListener('click', ()=>{
          t.done = false;
          tasks.push(t);
          tasksArchive.splice(idx,1);
          renderTasks();
          markDirty();
        });
        const del = document.createElement('button'); del.textContent='🗑️'; del.className='ghost'; del.title='Șterge';
        del.addEventListener('click', ()=>{
          tasksArchive.splice(idx,1);
          renderTasks();
          markDirty();
        });
        tdAct.appendChild(restore); tdAct.appendChild(del);

        tr.appendChild(tdName);
        tr.appendChild(tdComment);
        tr.appendChild(tdCreated);
        tr.appendChild(tdClosed);
        tr.appendChild(tdStatus);
        tr.appendChild(tdAct);
        archiveTableBody.appendChild(tr);
      });

      const stats = getTaskStatsData();
      if(taskStatsEl){
        taskStatsEl.innerHTML = `
          <div><strong>Deschise:</strong> ${stats.openCount} | <strong>Închise:</strong> ${stats.closedCount}</div>
          <div style="margin-top:6px"><strong>Închideri pe zile</strong>${formatBreakdownHtml(stats.daily, niceDate)}</div>
          <div style="margin-top:6px"><strong>Închideri pe lună</strong>${formatBreakdownHtml(stats.monthly, formatMonthLabel)}</div>
        `;
      }
      renderDashboard();
    }

    if(tasksTableBody){
      tasksTableBody.addEventListener('dragover', handleTaskTableDragOver);
      tasksTableBody.addEventListener('drop', handleTaskTableDrop);
      tasksTableBody.addEventListener('dragleave', handleTaskTableDragLeave);
    }

    addTaskBtn?.addEventListener('click', ()=>{
      const name = prompt('Descriere task:');
      if(name === null) return;
      const trimmed = name.trim();
      if(!trimmed) return;
      tasks.push({ id: 't'+Math.random().toString(36).slice(2,7), name: trimmed, comment:'', done:false, createdAt: todayStr(), closedAt:'' });
      renderTasks();
      markDirty();
    });

    taskSettingsBtn?.addEventListener('click', (e)=>{
      e.preventDefault();
      setTaskSettingsOpen(!taskSettingsOpen);
    });

    document.addEventListener('click', (e)=>{
      if(!taskSettingsOpen) return;
      if(taskSettingsMenu?.contains(e.target) || taskSettingsBtn?.contains(e.target)) return;
      setTaskSettingsOpen(false);
    });

    taskSettingsActiveToggle?.addEventListener('change', ()=>{
      taskPdfShowActive = !!taskSettingsActiveToggle.checked;
      scheduleLocalPersist();
    });

    taskSettingsArchiveToggle?.addEventListener('change', ()=>{
      taskPdfShowArchive = !!taskSettingsArchiveToggle.checked;
      scheduleLocalPersist();
    });

    taskSettingsStatsToggle?.addEventListener('change', ()=>{
      taskPdfShowStats = !!taskSettingsStatsToggle.checked;
      scheduleLocalPersist();
    });

    toggleArchiveBtn?.addEventListener('click', ()=>{
      taskArchiveVisible = !taskArchiveVisible;
      renderTasks();
      scheduleLocalPersist();
    });

    setTaskSettingsOpen(false);

    exportTasksPdfBtn?.addEventListener('click', exportTasksPDF);

    databaseSettingsBtn?.addEventListener('click', ()=>{
      const current = databaseFolder || '';
      const response = prompt('Folder preferat pentru salvarea bazei de date (informativ):', current);
      if(response === null) return;
      const sanitized = sanitizeFolderName(response);
      if(response.trim() && !sanitized){
        alert('Numele folderului nu poate conține caractere speciale. Valoarea a fost resetată.');
      }
      databaseFolder = sanitized;
      updateDatabaseFolderLabel();
      scheduleLocalPersist();
    });

    function buildTasksPdfHTML(){
      const esc = s=>String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;');
      const currentYear = new Date().getFullYear();
      const stats = getTaskStatsData();
      const dailyPlain = formatBreakdownPlain(stats.daily, niceDate);
      const monthlyPlain = formatBreakdownPlain(stats.monthly, formatMonthLabel);
      const buildRows = list => list.map((t, idx)=>{
        const closedDisplay = t.closedAt ? niceDate(t.closedAt) : '—';
        return `<tr><td>${idx+1}</td><td>${esc(t.name)}</td><td>${esc(t.comment||'')}</td><td>${esc(niceDate(t.createdAt))}</td><td>${esc(closedDisplay)}</td><td>${t.done?'✓':'—'}</td></tr>`;
      }).join('');
      const sections = [];
      if(taskPdfShowActive){
        const rows = buildRows(tasks);
        const table = rows
          ? `<table><thead><tr><th>Nr.</th><th>Task</th><th>Comentarii</th><th>Creat</th><th>Închis</th><th>Status</th></tr></thead><tbody>${rows}</tbody></table>`
          : `<div class="muted">Nu există taskuri active.</div>`;
        sections.push('<h2>Active</h2>' + table);
      }
      if(taskPdfShowArchive){
        const rows = buildRows(tasksArchive);
        const table = rows
          ? `<table><thead><tr><th>Nr.</th><th>Task</th><th>Comentarii</th><th>Creat</th><th>Închis</th><th>Status</th></tr></thead><tbody>${rows}</tbody></table>`
          : `<div class="muted">Nu există taskuri în arhivă.</div>`;
        sections.push('<h2>Arhivă</h2>' + table);
      }
      if(taskPdfShowStats){
        sections.push('<h2>Statistici</h2>'
          + `<div>Deschise: ${stats.openCount}</div>`
          + `<div>Închise: ${stats.closedCount}</div>`
          + `<div>Închideri pe zile: ${esc(dailyPlain)}</div>`
          + `<div>Închideri pe lună: ${esc(monthlyPlain)}</div>`);
      }
      if(!sections.length){
        sections.push('<div class="muted">Nu a fost selectată nicio secțiune pentru export.</div>');
      }
      const copyrightText = `© ${currentYear} — Aplicație șantier Ticlete Gabriel`;
      return `<!DOCTYPE html><html><head><meta charset="utf-8" />
        <title>Raport taskuri</title>
        <style>
          body{font-family:system-ui,-apple-system,Segoe UI,Roboto;margin:24px;color:#0f172a;background:#f8fafc;padding-bottom:60px}
          table{width:100%;border-collapse:collapse;margin-bottom:16px}
          th,td{border:1px solid #e5e7eb;padding:6px 8px;font-size:12px}
          th{text-align:left;background:#2563eb;color:red}
          th:first-child,td:first-child{text-align:center}
          h2{margin-top:24px}
          .muted{color:#6b7280;margin-bottom:16px}
          footer.pageFooter{position:fixed;left:0;right:0;bottom:12px;text-align:center;font-size:11px;color:#6b7280}
          @page { size: A4; margin: 16mm; }
          @media print {
            footer.pageFooter{bottom:10mm;}
          }
        </style>
      </head><body>
        <h1>Taskuri</h1>
        ${sections.join('')}
        <footer class="pageFooter">${esc(copyrightText)}</footer>
      </body></html>`;
    }

    function exportTasksPDF(){
      const html = buildTasksPdfHTML();
      const w = window.open('', '_blank');
      if(!w){ alert('Popup blocat. Permite deschiderea de ferestre pentru export PDF.'); return; }
      w.document.open(); w.document.write(html); w.document.close(); setTimeout(()=>{ w.focus(); w.print(); }, 300);
    }

    // ======= Rapoarte =======
    function normalizeReportValue(value){
      if(value === null || value === undefined) return '';
      if(typeof value === 'number' && Number.isFinite(value)) return String(value);
      if(typeof value === 'string') return value;
      return '';
    }

    // Datele comune se împart între întregul criteriu (data), iar activitățile se sincronizează pe fiecare linie.
    const REPORT_GROUP_FIELDS = ['date','hours'];
    const REPORT_LINE_FIELDS = ['activity','quantity','unit','valueRon','valueEur','valueTotal','valueCurrency','notes'];

    function mapImportedReportEntry(raw){
      return {
        id: raw && raw.id ? String(raw.id) : 'rep'+Math.random().toString(36).slice(2,7),
        personId: typeof raw?.personId === 'string' ? raw.personId : null,
        groupId: typeof raw?.groupId === 'string' && raw.groupId.trim() ? raw.groupId : null,
        lineId: typeof raw?.lineId === 'string' && raw.lineId.trim() ? raw.lineId : null,
        snapshotName: typeof raw?.snapshotName === 'string' ? raw.snapshotName : '',
        snapshotRole: typeof raw?.snapshotRole === 'string' ? raw.snapshotRole : '',
        snapshotStatus: typeof raw?.snapshotStatus === 'string' ? raw.snapshotStatus : 'Activ',
        snapshotZoneId: typeof raw?.snapshotZoneId === 'string' ? raw.snapshotZoneId : null,
        date: typeof raw?.date === 'string' ? raw.date : '',
        activity: typeof raw?.activity === 'string' ? raw.activity : '',
        quantity: normalizeReportValue(raw?.quantity),
        unit: typeof raw?.unit === 'string' ? raw.unit : '',
        valueRon: normalizeReportValue(raw?.valueRon),
        valueEur: normalizeReportValue(raw?.valueEur),
        valueTotal: normalizeReportValue(raw?.valueTotal),
        valueCurrency: typeof raw?.valueCurrency === 'string' ? raw.valueCurrency : '',
        hours: normalizeReportValue(raw?.hours),
        notes: typeof raw?.notes === 'string' ? raw.notes : '',
        extraNames: Array.isArray(raw?.extraNames)
          ? raw.extraNames.map(name => typeof name === 'string' ? name : '')
          : []
      };
    }

    function normalizeReportEntriesAfterLoad(){
      if(!Array.isArray(reportEntries)){
        reportEntries = [];
        return;
      }
      const next = [];
      reportEntries.forEach(rawEntry=>{
        if(!rawEntry || typeof rawEntry !== 'object') return;
        const entry = { ...rawEntry };
        entry.id = entry.id ? String(entry.id) : 'rep'+Math.random().toString(36).slice(2,7);
        entry.personId = typeof entry.personId === 'string' ? entry.personId : null;
        const groupIdValue = typeof entry.groupId === 'string' && entry.groupId.trim()
          ? entry.groupId.trim()
          : entry.id;
        entry.groupId = groupIdValue;
        const lineIdValue = typeof entry.lineId === 'string' && entry.lineId.trim()
          ? entry.lineId.trim()
          : groupIdValue;
        entry.lineId = lineIdValue;
        entry.quantity = normalizeReportValue(entry.quantity);
        entry.valueRon = normalizeReportValue(entry.valueRon);
        entry.valueEur = normalizeReportValue(entry.valueEur);
        entry.valueTotal = normalizeReportValue(entry.valueTotal);
        entry.hours = normalizeReportValue(entry.hours);
        entry.valueCurrency = typeof entry.valueCurrency === 'string' ? entry.valueCurrency : '';
        const legacyExtras = Array.isArray(entry.extraNames) ? entry.extraNames.slice() : [];
        delete entry.extraNames;
        updateEntryTotal(entry);
        next.push(entry);
        legacyExtras.forEach(name=>{
          const trimmed = typeof name === 'string' ? name.trim() : '';
          if(!trimmed) return;
          const extra = {
            ...entry,
            id: 'rep'+Math.random().toString(36).slice(2,7),
            personId: null,
            snapshotName: trimmed,
            groupId: groupIdValue
          };
          updateEntryTotal(extra);
          next.push(extra);
        });
      });
      reportEntries = next;
    }

    function setCurrentReportEditing(id, number){
      editingReportId = id || null;
      if(number === undefined || number === null){
        editingReportNumber = null;
      } else {
        editingReportNumber = number;
      }
      updateReportEditingUI();
    }

    function updateReportEditingUI(){
      if(!reportsSaveSnapshotBtn) return;
      if(editingReportId){
        reportsSaveSnapshotBtn.textContent = 'Salvează modificări';
        reportsSaveSnapshotBtn.title = 'Înlocuiește raportul salvat încărcat.';
      } else {
        reportsSaveSnapshotBtn.textContent = 'Salvează raport';
        reportsSaveSnapshotBtn.title = '';
      }
    }

    function serializeSavedReport(report){
      const entries = Array.isArray(report?.entries) ? report.entries.map(mapImportedReportEntry) : [];
      const companyValue = typeof report?.company === 'string' ? report.company.trim() : '';
      return {
        id: typeof report?.id === 'string' ? report.id : 'saved'+Math.random().toString(36).slice(2,7),
        number: report?.number !== undefined ? report.number : '',
        createdAt: typeof report?.createdAt === 'string' ? report.createdAt : new Date().toISOString(),
        date: typeof report?.date === 'string' ? report.date : '',
        company: companyValue,
        entries
      };
    }

    function mapImportedSavedReport(raw){
      const base = raw && typeof raw === 'object' ? raw : {};
      const id = typeof base.id === 'string' ? base.id : 'saved'+Math.random().toString(36).slice(2,7);
      const numberValue = base.number !== undefined ? base.number : '';
      const createdAt = typeof base.createdAt === 'string' ? base.createdAt : new Date().toISOString();
      const dateValue = typeof base.date === 'string' ? base.date : '';
      const entries = Array.isArray(base.entries) ? base.entries.map(mapImportedReportEntry) : [];
      const companyValue = typeof base.company === 'string' ? base.company.trim() : '';
      return { id, number: numberValue, createdAt, date: dateValue, company: companyValue, entries };
    }

    function cloneReportEntry(entry){
      return mapImportedReportEntry(entry);
    }

    function parseReportNumber(value){
      if(value === null || value === undefined) return NaN;
      if(typeof value === 'number') return Number.isFinite(value) ? value : NaN;
      const str = String(value).trim();
      if(!str) return NaN;
      const numeric = Number(str);
      if(Number.isFinite(numeric)) return numeric;
      const match = str.match(/\d+/);
      return match ? Number(match[0]) : NaN;
    }

    function recalculateReportSequence(){
      const numbers = savedReports.map(report=> parseReportNumber(report?.number)).filter(Number.isFinite);
      const max = numbers.length ? Math.max(...numbers) : 0;
      if(!Number.isFinite(reportSequence) || reportSequence <= max){
        reportSequence = Math.max(1, max + 1);
      }
      refreshReportSequenceUI();
    }

    function getNextReportNumber(){
      const numbers = savedReports.map(report=> parseReportNumber(report?.number)).filter(Number.isFinite);
      const max = numbers.length ? Math.max(...numbers) : 0;
      const base = Number.isFinite(reportSequence) ? Math.max(reportSequence, max + 1) : max + 1;
      return base || 1;
    }

    function createReportEntryFromPerson(person){
      const id = 'rep'+Math.random().toString(36).slice(2,7);
      return {
        id,
        groupId: id,
        lineId: id,
        personId: person?.id || null,
        snapshotName: person?.name || '',
        snapshotRole: person?.role || '',
        snapshotStatus: person?.status || 'Activ',
        snapshotZoneId: person?.zoneId || null,
        date: '',
        activity: '',
        quantity: '',
        unit: '',
        valueRon: '',
        valueEur: '',
        valueCurrency: '',
        hours: '',
        valueTotal: '',
        notes: ''
      };
    }

    function getReportGroupOrder(){
      const order = [];
      const seen = new Set();
      reportEntries.forEach(entry=>{
        if(!entry) return;
        const id = getEntryGroupId(entry);
        if(!seen.has(id)){
          seen.add(id);
          order.push(id);
        }
      });
      return order;
    }

    function getGroupIdByNumber(number){
      if(!Number.isFinite(number)) return null;
      const order = getReportGroupOrder();
      const index = Math.floor(number) - 1;
      if(index < 0 || index >= order.length) return null;
      return order[index];
    }

    function getReportGroupNumbers(){
      return getReportGroupOrder().map((_, index)=> index + 1);
    }

    function findLastGroupIndex(groupId){
      if(!groupId) return -1;
      let lastIndex = -1;
      reportEntries.forEach((entry, index)=>{
        if(!entry) return;
        if(getEntryGroupId(entry) === groupId){
          lastIndex = index;
        }
      });
      return lastIndex;
    }

    function insertEntryAsNewGroup(entry){
      if(!entry) return;
      reportEntries.push(entry);
    }

    function insertEntryIntoGroup(entry, groupId){
      if(!entry) return;
      if(!groupId){
        insertEntryAsNewGroup(entry);
        return;
      }
      const lastIndex = findLastGroupIndex(groupId);
      if(lastIndex >= 0){
        reportEntries.splice(lastIndex + 1, 0, entry);
      } else {
        reportEntries.push(entry);
      }
    }

    function findLastLineIndex(groupId, lineId){
      if(!groupId || !lineId) return -1;
      let lastIndex = -1;
      reportEntries.forEach((entry, index)=>{
        if(!entry) return;
        if(getEntryGroupId(entry) !== groupId) return;
        if(getEntryLineId(entry) !== lineId) return;
        lastIndex = index;
      });
      return lastIndex;
    }

    function insertEntryIntoGroupLine(entry, groupId, lineId){
      if(!entry) return;
      const gid = groupId || getEntryGroupId(entry);
      const lid = lineId || getEntryLineId(entry);
      const lastIndex = findLastLineIndex(gid, lid);
      if(lastIndex >= 0){
        reportEntries.splice(lastIndex + 1, 0, entry);
      } else {
        insertEntryIntoGroup(entry, gid);
      }
    }

    function applyTemplateToEntry(template, entry){
      if(!template || !entry) return;
      const templateLineId = getEntryLineId(template);
      if(templateLineId){
        entry.lineId = templateLineId;
      }
      REPORT_GROUP_FIELDS.forEach(field=>{
        if(Object.prototype.hasOwnProperty.call(template, field)){
          entry[field] = template[field] ?? '';
        }
      });
      REPORT_LINE_FIELDS.forEach(field=>{
        if(Object.prototype.hasOwnProperty.call(template, field)){
          entry[field] = template[field] ?? '';
        }
      });
    }

    function compareByName(a,b){
      return normName(a?.name).localeCompare(normName(b?.name));
    }

    function formatInactiveLabel(person){
      const status = person?.status || 'Inactiv';
      if(status === 'Demisie'){
        if(person?.resignationDate){
          return `Demisie (${niceDate(person.resignationDate)})`;
        }
        return 'Demisie';
      }
      let period = '';
      if(person?.inactiveFrom){
        const sameDay = person.inactiveFrom && person.inactiveTo && person.inactiveFrom === person.inactiveTo;
        const start = niceDate(person.inactiveFrom);
        const end = person.inactiveTo && !sameDay ? ' – '+niceDate(person.inactiveTo) : '';
        period = ` (${start}${end})`;
      }
      return `${status}${period}`;
    }

    function formatReportOptionLabel(person){
      if(!person) return '';
      const parts = [getDisplayName(person)];
      if(person.status && person.status !== 'Activ'){
        parts.push(`[${formatInactiveLabel(person)}]`);
      }
      return parts.join(' ');
    }

    function getEntryGroupId(entry){
      if(!entry) return '';
      if(typeof entry.groupId === 'string' && entry.groupId.trim()){
        entry.groupId = entry.groupId.trim();
        return entry.groupId;
      }
      if(entry.id){
        const id = String(entry.id);
        entry.groupId = id;
        return id;
      }
      const fallbackId = 'rep'+Math.random().toString(36).slice(2,7);
      entry.id = fallbackId;
      entry.groupId = fallbackId;
      return fallbackId;
    }

    function getEntryLineId(entry){
      if(!entry) return '';
      const groupId = getEntryGroupId(entry);
      if(typeof entry.lineId === 'string' && entry.lineId.trim()){
        entry.lineId = entry.lineId.trim();
        return entry.lineId;
      }
      entry.lineId = groupId;
      return entry.lineId;
    }

    function getReportMemberKey(entry){
      if(!entry) return '';
      if(entry.personId){
        return `id:${entry.personId}`;
      }
      const normalized = normName(entry.snapshotName);
      if(normalized){
        return `name:${normalized}`;
      }
      return entry.id ? `entry:${entry.id}` : '';
    }

    function updateEntryTotal(entry){
      if(!entry) return { number: NaN, text: '', currency: '' };
      const qty = parseNumericInput(entry.quantity);
      const ron = parseNumericInput(entry.valueRon);
      const eur = parseNumericInput(entry.valueEur);
      let total = NaN;
      let currency = '';
      if(Number.isFinite(qty)){
        if(Number.isFinite(ron)){
          total = qty * ron;
          currency = 'RON';
        } else if(Number.isFinite(eur)){
          total = qty * eur;
          currency = 'EUR';
        }
      }
      if(Number.isFinite(total)){
        const rounded = Math.round(total * 100) / 100;
        const text = String(Number(rounded.toFixed(2)));
        entry.valueTotal = text;
        entry.valueCurrency = currency;
        return { number: rounded, text, currency };
      }
      entry.valueTotal = '';
      entry.valueCurrency = '';
      return { number: NaN, text: '', currency: '' };
    }

    function addPeopleToReport(ids, options = {}){
      const selectedIds = Array.isArray(ids) ? ids.filter(Boolean) : [];
      if(!selectedIds.length) return false;

      const mode = options.mode === 'group' ? 'group' : 'new';
      if(mode === 'group'){
        const groupId = options.groupId;
        if(!groupId) return false;
        const template = reportEntries.find(entry=> entry && getEntryGroupId(entry) === groupId);
        if(!template) return false;
        const groupEntries = reportEntries.filter(entry=> entry && getEntryGroupId(entry) === groupId);
        const existingIds = new Set(groupEntries.map(entry=> entry.personId).filter(Boolean));
        const existingNames = new Set(groupEntries.map(entry=> normName(entry.snapshotName)).filter(Boolean));
        const existingMemberKeys = new Set(groupEntries.map(getReportMemberKey).filter(Boolean));
        const lineTemplates = new Map();
        groupEntries.forEach(entry=>{
          if(!entry) return;
          const lineId = getEntryLineId(entry);
          if(lineId && !lineTemplates.has(lineId)){
            lineTemplates.set(lineId, entry);
          }
        });
        if(!lineTemplates.size && template){
          lineTemplates.set(getEntryLineId(template), template);
        }
        let addedToGroup = false;
        let skippedDuplicate = false;
        selectedIds.forEach(personId=>{
          const person = people.find(p=>p.id === personId);
          if(!person) return;
          if(person.id && existingIds.has(person.id)){
            skippedDuplicate = true;
            return;
          }
          const normalizedName = normName(person.name);
          if(!person.id && normalizedName && existingNames.has(normalizedName)){
            skippedDuplicate = true;
            return;
          }
          const memberKey = person.id ? `id:${person.id}` : (normalizedName ? `name:${normalizedName}` : '');
          if(memberKey && existingMemberKeys.has(memberKey)){
            skippedDuplicate = true;
            return;
          }
          lineTemplates.forEach((lineTemplate, lineId)=>{
            const entry = createReportEntryFromPerson(person);
            entry.groupId = groupId;
            entry.lineId = lineId;
            applyTemplateToEntry(lineTemplate, entry);
            entry.groupId = groupId;
            entry.lineId = lineId;
            const totalInfo = updateEntryTotal(entry);
            insertEntryIntoGroupLine(entry, groupId, lineId);
            syncReportTotalInput(entry.id, totalInfo);
          });
          if(person.id) existingIds.add(person.id);
          if(normalizedName) existingNames.add(normalizedName);
          if(memberKey) existingMemberKeys.add(memberKey);
          addedToGroup = true;
        });
        if(options.showDuplicateWarning){
          if(skippedDuplicate && !addedToGroup){
            setReportsAddPromptError('Persoana selectată este deja în acest criteriu.');
          } else if(skippedDuplicate){
            setReportsAddPromptError('Unele persoane erau deja în acest criteriu și nu au fost adăugate din nou.');
          } else {
            setReportsAddPromptError('');
          }
        }
        if(addedToGroup){
          renderReports();
          markDirty();
        }
        return addedToGroup;
      }

      let firstEntry = null;
      let targetGroupId = null;
      let added = false;
      selectedIds.forEach(personId=>{
        const person = people.find(p=>p.id === personId);
        if(!person) return;
        const entry = createReportEntryFromPerson(person);
        if(!firstEntry){
          updateEntryTotal(entry);
          insertEntryAsNewGroup(entry);
          firstEntry = entry;
          targetGroupId = entry.groupId;
          added = true;
        } else if(targetGroupId){
          entry.groupId = targetGroupId;
          applyTemplateToEntry(firstEntry, entry);
          entry.groupId = targetGroupId;
          entry.lineId = getEntryLineId(firstEntry);
          const totalInfo = updateEntryTotal(entry);
          insertEntryIntoGroupLine(entry, targetGroupId, getEntryLineId(entry));
          syncReportTotalInput(entry.id, totalInfo);
          added = true;
        }
      });

      if(added){
        renderReports();
        markDirty();
      }

      return added;
    }

    function removeReportEntry(entryId){
      const next = reportEntries.filter(entry=>entry.id !== entryId);
      if(next.length !== reportEntries.length){
        reportEntries = next;
        renderReports();
        markDirty();
      }
    }

    function removeReportMember(groupId, memberKey){
      if(!groupId || !memberKey) return;
      const next = reportEntries.filter(entry=>{
        if(getEntryGroupId(entry) !== groupId) return true;
        const key = getReportMemberKey(entry);
        return key !== memberKey;
      });
      if(next.length !== reportEntries.length){
        reportEntries = next;
        renderReports();
        markDirty();
      }
    }

    function removeReportGroup(groupId){
      if(!groupId) return;
      const next = reportEntries.filter(entry=> getEntryGroupId(entry) !== groupId);
      if(next.length !== reportEntries.length){
        reportEntries = next;
        renderReports();
        markDirty();
      }
    }

    function addReportActivity(groupId, sourceLineId){
      if(!groupId) return;
      const groupEntries = reportEntries.filter(entry=> getEntryGroupId(entry) === groupId);
      if(!groupEntries.length) return;
      const newLineId = 'rep'+Math.random().toString(36).slice(2,7);
      let preferredLineId = sourceLineId && groupEntries.some(entry=> getEntryLineId(entry) === sourceLineId)
        ? sourceLineId
        : getEntryLineId(groupEntries[0]);
      const memberTemplates = new Map();
      groupEntries.forEach(entry=>{
        const key = getReportMemberKey(entry);
        if(!key) return;
        const lineMatches = getEntryLineId(entry) === preferredLineId;
        if(lineMatches || !memberTemplates.has(key)){
          memberTemplates.set(key, entry);
          if(lineMatches) return;
        }
      });
      if(!memberTemplates.size){
        groupEntries.forEach(entry=>{
          const key = getReportMemberKey(entry);
          if(key && !memberTemplates.has(key)){
            memberTemplates.set(key, entry);
          }
        });
      }
      const templateForGroup = groupEntries.find(entry=> getEntryLineId(entry) === preferredLineId) || groupEntries[0];
      memberTemplates.forEach(templateEntry=>{
        const clone = mapImportedReportEntry(templateEntry);
        clone.id = 'rep'+Math.random().toString(36).slice(2,7);
        clone.groupId = groupId;
        clone.lineId = newLineId;
        clone.activity = '';
        clone.quantity = '';
        clone.unit = '';
        clone.valueRon = '';
        clone.valueEur = '';
        clone.valueTotal = '';
        clone.valueCurrency = '';
        clone.notes = '';
        clone.date = templateForGroup?.date || clone.date || '';
        const totalInfo = updateEntryTotal(clone);
        insertEntryIntoGroupLine(clone, groupId, newLineId);
        syncReportTotalInput(clone.id, totalInfo);
      });
      renderReports();
      markDirty();
    }

    function duplicateReportGroup(groupId){
      if(!groupId) return;
      const groupEntries = reportEntries.filter(entry=> getEntryGroupId(entry) === groupId);
      if(!groupEntries.length) return;
      const insertAt = findLastGroupIndex(groupId);
      const newGroupId = 'rep'+Math.random().toString(36).slice(2,7);
      const lineIdMap = new Map();
      const clones = groupEntries.map((entry, index)=>{
        const clone = mapImportedReportEntry(entry);
        clone.id = 'rep'+Math.random().toString(36).slice(2,7);
        clone.groupId = newGroupId;
        const originalLineId = getEntryLineId(entry);
        let mappedLineId = lineIdMap.get(originalLineId);
        if(!mappedLineId){
          mappedLineId = 'rep'+Math.random().toString(36).slice(2,7);
          lineIdMap.set(originalLineId, mappedLineId);
        }
        clone.lineId = mappedLineId;
        if(index === 0){
          clone.id = newGroupId;
        }
        const fallbackTotal = normalizeReportValue(entry.valueTotal);
        const fallbackCurrency = typeof entry.valueCurrency === 'string' ? entry.valueCurrency : '';
        const totalInfo = updateEntryTotal(clone);
        if(!Number.isFinite(totalInfo.number)){
          clone.valueTotal = fallbackTotal;
          clone.valueCurrency = fallbackCurrency;
        }
        return clone;
      });
      if(!clones.length) return;
      const targetIndex = insertAt >= 0 ? insertAt + 1 : reportEntries.length;
      reportEntries.splice(targetIndex, 0, ...clones);
      renderReports();
      markDirty();
    }

    function getEntryDisplayName(entry, person){
      if(person) return getDisplayName(person);
      const fallback = entry.snapshotName || '(fără nume)';
      return anonymize ? maskFirstName(fallback) : fallback;
    }

    function getEntryRole(entry, person){
      if(hideRoles) return '—';
      const role = person ? (person.role || '—') : (entry.snapshotRole || '—');
      return role || '—';
    }

    function getEntryStatus(entry, person){
      return person ? (person.status || 'Activ') : (entry.snapshotStatus || 'Activ');
    }

    function getReportEntriesWithContext(){
      const order = [];
      const groups = new Map();
      const fallbackCounts = new Map();

      reportEntries.forEach(entry=>{
        if(!entry) return;
        const groupId = getEntryGroupId(entry);
        const lineId = getEntryLineId(entry);
        if(!groups.has(groupId)){
          groups.set(groupId, { lines:new Map(), order:[] });
          order.push(groupId);
        }
        const group = groups.get(groupId);
        if(!group.lines.has(lineId)){
          group.lines.set(lineId, []);
          group.order.push(lineId);
        }
        group.lines.get(lineId).push(entry);
        if(entry.personId){
          fallbackCounts.set(entry.personId, (fallbackCounts.get(entry.personId) || 0) + 1);
        }
      });

      const counts = (reportOccurrenceCounts && reportOccurrenceCounts.size) ? reportOccurrenceCounts : fallbackCounts;
      const contexts = [];
      let rowCounter = 0;

      order.forEach(groupId=>{
        const group = groups.get(groupId);
        if(!group) return;

        const lineEntries = [];
        group.order.forEach(lineId=>{
          const entries = (group.lines.get(lineId) || []).filter(Boolean);
          if(entries.length){
            lineEntries.push({ lineId, entries });
          }
        });
        if(!lineEntries.length) return;

        rowCounter++;
        const groupRowNumber = rowCounter;
        const groupLineCount = lineEntries.length;
        lineEntries.forEach(({ lineId, entries }, index)=>{
          const baseEntry = entries[0];
          if(!baseEntry) return;
          const memberMap = new Map();
          entries.forEach(entry=>{
            const person = entry.personId ? people.find(p=>p.id===entry.personId) : null;
            const key = getReportMemberKey(entry);
            if(key && memberMap.has(key)) return;
            memberMap.set(key, {
              entry,
              person,
              displayName: getEntryDisplayName(entry, person),
              roleKey: person?.role || entry.snapshotRole || '—',
              status: getEntryStatus(entry, person),
              occurrenceCount: entry.personId ? (counts.get(entry.personId) || 0) : 0
            });
          });
          const members = Array.from(memberMap.values());
          const roleKey = members[0]?.roleKey || '—';
          const hoursNum = parseNumericInput(baseEntry.hours);
          const qtyNum = parseNumericInput(baseEntry.quantity);
          const ronNum = parseNumericInput(baseEntry.valueRon);
          const eurNum = parseNumericInput(baseEntry.valueEur);
          const totalInfo = updateEntryTotal(baseEntry);

          contexts.push({
            groupId,
            lineId,
            rowNumber: groupRowNumber,
            entry: baseEntry,
            members,
            roleKey,
            hoursNum,
            qtyNum,
            ronNum,
            eurNum,
            totalNum: totalInfo.number,
            totalText: totalInfo.text,
            totalCurrency: totalInfo.currency || '',
            groupSize: members.length,
            groupLineCount,
            lineIndex: index,
            isFirstLine: index === 0
          });
        });
      });

      return contexts;
    }

    function computeCurrencyTotals(contexts){
      const totals = new Map();
      (Array.isArray(contexts) ? contexts : []).forEach(ctx=>{
        if(!ctx) return;
        if(!Number.isFinite(ctx.totalNum)) return;
        const currency = ctx.totalCurrency || '';
        if(!currency) return;
        const prev = totals.get(currency) || 0;
        totals.set(currency, prev + ctx.totalNum);
      });
      return totals;
    }

    function formatCurrencyTotals(totals){
      if(!totals || totals.size === 0) return '';
      const parts = [];
      totals.forEach((value, currency)=>{
        if(!Number.isFinite(value)) return;
        const rounded = Math.round(value * 100) / 100;
        parts.push(`Total ${currency}: ${formatNumber(rounded)}`);
      });
      return parts.join(' • ');
    }

    function aggregateTotalsPerPerson(contexts){
      const result = new Map();
      (Array.isArray(contexts) ? contexts : []).forEach(ctx=>{
        if(!ctx || !Array.isArray(ctx.members)) return;
        const groupSize = ctx.groupSize || ctx.members.length || 1;
        const totalShare = (Number.isFinite(ctx.totalNum) && ctx.totalCurrency && groupSize > 0)
          ? ctx.totalNum / groupSize
          : NaN;
        ctx.members.forEach(member=>{
          const fallbackName = member?.entry?.snapshotName || '(fără nume)';
          const name = member?.displayName || fallbackName;
          if(!result.has(name)){
            result.set(name, {
              totals: new Map(),
              hours: 0,
              hoursCount: 0
            });
          }
          const bucket = result.get(name);
          if(Number.isFinite(totalShare) && ctx.totalCurrency){
            const currency = ctx.totalCurrency;
            bucket.totals.set(currency, (bucket.totals.get(currency) || 0) + totalShare);
          }
          if(ctx.isFirstLine && Number.isFinite(ctx.hoursNum)){
            bucket.hours += ctx.hoursNum;
            bucket.hoursCount += 1;
          }
        });
      });
      return result;
    }

    function buildPersonSummaryRows(contexts){
      const aggregated = aggregateTotalsPerPerson(contexts);
      const rows = Array.from(aggregated.entries()).map(([name, data])=>{
        const totalValue = Array.from(data.totals.values()).reduce((sum, value)=>{
          return Number.isFinite(value) ? sum + value : sum;
        }, 0);
        return {
          name,
          summary: formatCurrencyTotals(data.totals) || '',
          hours: data.hours,
          hasHours: data.hoursCount > 0,
          totalValue: Number.isFinite(totalValue) ? totalValue : 0
        };
      });
      rows.sort((a,b)=>{
        if(a.totalValue !== b.totalValue){
          return a.totalValue - b.totalValue;
        }
        return a.name.localeCompare(b.name, 'ro', { sensitivity:'base' });
      });
      return rows.map(({ totalValue, ...rest })=> rest);
    }

    function refreshReportsGrandTotalFromContexts(contexts){
      if(!reportsGrandTotalCell) return;
      const totals = computeCurrencyTotals(contexts);
      const summary = formatCurrencyTotals(totals);
      reportsGrandTotalCell.textContent = summary || '0';
    }

    function refreshReportsGrandTotal(){
      const contexts = getReportEntriesWithContext();
      refreshReportsGrandTotalFromContexts(contexts);
    }

    function updateReportsSelectionMessage(){
      if(!reportsSelectionMessage) return;
      let selectedId = null;
      if(reportsActiveSelect && reportsActiveSelect.selectedOptions.length){
        const opts = reportsActiveSelect.selectedOptions;
        selectedId = opts[opts.length - 1].value;
      } else if(reportsInactiveSelect && reportsInactiveSelect.selectedOptions.length){
        const opts = reportsInactiveSelect.selectedOptions;
        selectedId = opts[opts.length - 1].value;
      }
      if(selectedId){
        const count = reportOccurrenceCounts.get(selectedId) || 0;
        if(count > 1){
          const person = people.find(p=>p.id === selectedId);
          const name = person ? getDisplayName(person) : 'Persoana selectată';
          reportsSelectionMessage.textContent = `${name} este în raport de ${count} ori.`;
          reportsSelectionMessage.style.display = 'block';
          reportsSelectionMessage.style.color = '#b91c1c';
          return;
        }
      }
      reportsSelectionMessage.textContent = '';
      reportsSelectionMessage.style.display = 'none';
    }

    function setReportsAddPromptError(message){
      if(reportsAddPromptError){
        reportsAddPromptError.textContent = message || '';
      }
    }

    function resetReportsAddPrompt(){
      if(reportsAddPromptTeamSection){
        reportsAddPromptTeamSection.classList.remove('active');
      }
      if(reportsAddPromptGroupList){
        reportsAddPromptGroupList.innerHTML = '';
      }
      setReportsAddPromptError('');
    }

    function updateReportsAddPromptHint(){
      if(!reportsAddPromptHint) return;
      const numbers = getReportGroupNumbers();
      reportsAddPromptHint.textContent = numbers.length
        ? `Selectează criteriul dorit: ${numbers.join(', ')}`
        : 'Nu există criterii existente în raport.';
    }

    function renderReportsAddPromptGroups(){
      if(!reportsAddPromptGroupList) return;
      const numbers = getReportGroupNumbers();
      reportsAddPromptGroupList.innerHTML = '';
      if(!numbers.length){
        const empty = document.createElement('div');
        empty.className = 'reportsAddPromptHint';
        empty.textContent = 'Nu există criterii disponibile.';
        reportsAddPromptGroupList.appendChild(empty);
        return;
      }
      numbers.forEach(number=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.dataset.reportNumber = String(number);
        btn.textContent = `Criteriu ${number}`;
        reportsAddPromptGroupList.appendChild(btn);
      });
    }

    function openReportsAddPrompt(){
      if(!reportsAddPrompt) return;
      resetReportsAddPrompt();
      updateReportsAddPromptHint();
      reportsAddPrompt.classList.add('show');
      reportsAddPrompt.setAttribute('aria-hidden','false');
      (reportsAddPromptNewBtn || reportsAddPromptTeamBtn)?.focus();
    }

    function closeReportsAddPrompt(){
      if(!reportsAddPrompt) return;
      reportsAddPrompt.classList.remove('show');
      reportsAddPrompt.setAttribute('aria-hidden','true');
      resetReportsAddPrompt();
    }

    function finalizeReportsAdd(success){
      if(success && pendingReportAddSelect){
        ensureReportsSelectionCleared(pendingReportAddSelect);
      }
      pendingReportAddIds = [];
      pendingReportAddSelect = null;
    }

    function requestReportsAdd(ids, selectEl){
      const selectedIds = Array.isArray(ids) ? ids.filter(Boolean) : [];
      if(!selectedIds.length) return;
      pendingReportAddIds = selectedIds;
      pendingReportAddSelect = selectEl || null;
      if(!reportsAddPrompt){
        const added = addPeopleToReport(selectedIds, { mode: 'new' });
        if(added){
          finalizeReportsAdd(true);
        } else {
          finalizeReportsAdd(false);
        }
        return;
      }
      openReportsAddPrompt();
    }

    function syncGroupField(entry, field, value, sourceElement){
      if(!REPORT_GROUP_FIELDS.includes(field)) return;
      const groupId = getEntryGroupId(entry);
      reportEntries.forEach(other=>{
        if(!other || other.id === entry.id) return;
        if(getEntryGroupId(other) !== groupId) return;
        other[field] = value;
      });
      if(!reportsTableBody) return;
      const rows = reportsTableBody.querySelectorAll(`tr[data-group-id="${groupId}"]`);
      rows.forEach(row=>{
        const selector = field === 'activity' || field === 'notes' ? 'textarea' : 'input';
        const el = row.querySelector(`${selector}[data-field="${field}"]`);
        if(el && el !== sourceElement){
          el.value = value;
        }
      });
    }

    function syncLineField(entry, field, value, sourceElement){
      if(!REPORT_LINE_FIELDS.includes(field)) return;
      const groupId = getEntryGroupId(entry);
      const lineId = getEntryLineId(entry);
      const affectsTotal = field === 'quantity' || field === 'valueRon' || field === 'valueEur';
      reportEntries.forEach(other=>{
        if(!other || other.id === entry.id) return;
        if(getEntryGroupId(other) !== groupId) return;
        if(getEntryLineId(other) !== lineId) return;
        other[field] = value;
        if(affectsTotal){
          const info = updateEntryTotal(other);
          syncReportTotalInput(other.id, info);
        }
      });
      if(!reportsTableBody) return;
      const rows = reportsTableBody.querySelectorAll(`tr[data-group-id="${groupId}"][data-line-id="${lineId}"]`);
      rows.forEach(row=>{
        const selector = field === 'activity' || field === 'notes' ? 'textarea' : 'input';
        const el = row.querySelector(`${selector}[data-field="${field}"]`);
        if(el && el !== sourceElement){
          el.value = value;
        }
      });
    }

    function renderReports(){
      const filter = (reportsSearchTerm || '').trim().toLowerCase();

      if(reportCompanyInput){
        reportCompanyInput.value = reportCompany;
        reportCompanyInput.classList.remove('invalid');
      }

      const occurrences = new Map();
      reportEntries.forEach(entry=>{
        if(entry && entry.personId){
          const current = occurrences.get(entry.personId) || 0;
          occurrences.set(entry.personId, current + 1);
        }
      });

      reportOccurrenceCounts = new Map(occurrences);

      if(reportsActiveSelect){
        const active = people.filter(p=>isActive(p)).sort(compareByName);
        reportsActiveSelect.innerHTML='';
        let matches = 0;
        active.forEach(p=>{
          const label = formatReportOptionLabel(p);
          if(filter && !label.toLowerCase().includes(filter)) return;
          const opt = document.createElement('option');
          opt.value = p.id;
          const count = occurrences.get(p.id) || 0;
          opt.textContent = count ? `${label} (în raport x${count})` : label;
          opt.style.color = count > 1 ? '#b91c1c' : '';
          reportsActiveSelect.appendChild(opt);
          matches++;
        });
        if(matches === 0){
          const opt = document.createElement('option');
          opt.disabled = true;
          opt.textContent = filter ? 'Nicio persoană găsită' : 'Nu sunt persoane active';
          reportsActiveSelect.appendChild(opt);
        }
        reportsActiveSelect.disabled = matches === 0;
      }

      if(reportsInactiveSelect){
        const inactive = people.filter(p=> isInactiveCO(p) || isInactiveCM(p)).sort(compareByName);
        reportsInactiveSelect.innerHTML='';
        let matches = 0;
        inactive.forEach(p=>{
          const label = formatReportOptionLabel(p);
          if(filter && !label.toLowerCase().includes(filter)) return;
          const opt = document.createElement('option');
          opt.value = p.id;
          const count = occurrences.get(p.id) || 0;
          opt.textContent = count ? `${label} (în raport x${count})` : label;
          opt.style.color = count > 1 ? '#b91c1c' : '';
          reportsInactiveSelect.appendChild(opt);
          matches++;
        });
        if(matches === 0){
          const opt = document.createElement('option');
          opt.disabled = true;
          opt.textContent = filter ? 'Nicio persoană găsită' : 'Nu sunt persoane inactive';
          reportsInactiveSelect.appendChild(opt);
        }
        reportsInactiveSelect.disabled = matches === 0;
      }

      const contexts = getReportEntriesWithContext();
      if(reportsTableBody){
        reportsTableBody.innerHTML='';
        contexts.forEach(ctx=>{
          const { entry, members, roleKey, rowNumber, totalNum, totalCurrency, groupSize, groupId, lineId, groupLineCount = 1, isFirstLine = true } = ctx;
          const row = document.createElement('tr');
          row.dataset.reportId = entry.id;
          row.dataset.groupId = groupId;
          row.dataset.lineId = lineId || '';
          const roleColor = getRoleColor(roleKey || '—');
          if(roleColor){
            row.style.background = roleColor.bg;
          }

          const spanCount = Math.max(1, Number(groupLineCount) || 1);
          if(isFirstLine){
            const idxCell = document.createElement('td');
            idxCell.className = 'reportsIndexCell';
            idxCell.textContent = String(rowNumber);
            idxCell.rowSpan = spanCount;
            row.appendChild(idxCell);

            const dateCell = document.createElement('td');
            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.value = entry.date || '';
            dateInput.dataset.reportId = entry.id;
            dateInput.dataset.groupId = groupId;
            dateInput.dataset.field = 'date';
            dateCell.appendChild(dateInput);
            dateCell.rowSpan = spanCount;
            row.appendChild(dateCell);

            const nameCell = document.createElement('td');
            nameCell.className = 'reportsNameCell';
            nameCell.rowSpan = spanCount;
            const membersWrap = document.createElement('div');
            membersWrap.className = 'reportsMembers';
            members.forEach(member=>{
              const memberRow = document.createElement('div');
              memberRow.className = 'reportsMember';
              if(member.occurrenceCount > 1){
                memberRow.classList.add('duplicate');
              }
              const nameStrong = document.createElement('strong');
              nameStrong.textContent = member.displayName || '(fără nume)';
              memberRow.appendChild(nameStrong);
              if(member.person && member.person.status && member.person.status !== 'Activ'){
                const statusSpan = document.createElement('span');
                statusSpan.className = 'status';
                statusSpan.textContent = `Status: ${member.person.status}`;
                memberRow.appendChild(statusSpan);
              } else if(!member.person){
                const missingSpan = document.createElement('span');
                missingSpan.className = 'reportsMissingPerson';
                missingSpan.textContent = 'Persoană inexistentă în listă';
                memberRow.appendChild(missingSpan);
              }
              const removeMemberBtn = document.createElement('button');
              removeMemberBtn.type = 'button';
              removeMemberBtn.dataset.reportAction = 'remove-member';
              removeMemberBtn.dataset.reportId = member.entry.id;
              removeMemberBtn.dataset.reportGroupId = groupId;
              const memberKey = getReportMemberKey(member.entry) || member.entry.id;
              if(memberKey){
                removeMemberBtn.dataset.reportPersonKey = memberKey;
              }
              removeMemberBtn.title = 'Elimină persoana din echipă';
              removeMemberBtn.textContent = '✕';
              memberRow.appendChild(removeMemberBtn);
              membersWrap.appendChild(memberRow);
            });
            if(!membersWrap.children.length){
              const placeholder = document.createElement('div');
              placeholder.className = 'reportsMember';
              const nameStrong = document.createElement('strong');
              nameStrong.textContent = entry.snapshotName || '(fără nume)';
              placeholder.appendChild(nameStrong);
              membersWrap.appendChild(placeholder);
            }
            nameCell.appendChild(membersWrap);
            row.appendChild(nameCell);
          }

          const activityCell = document.createElement('td');
          const activityInput = document.createElement('textarea');
          activityInput.value = entry.activity || '';
          activityInput.dataset.reportId = entry.id;
          activityInput.dataset.groupId = groupId;
          activityInput.dataset.field = 'activity';
          activityCell.appendChild(activityInput);
          row.appendChild(activityCell);

          if(isFirstLine){
            const hoursCell = document.createElement('td');
            hoursCell.className = 'numeric';
            hoursCell.rowSpan = spanCount;
            const hoursInput = document.createElement('input');
            hoursInput.type = 'number';
            hoursInput.step = 'any';
            hoursInput.value = entry.hours || '';
            hoursInput.dataset.reportId = entry.id;
            hoursInput.dataset.groupId = groupId;
            hoursInput.dataset.field = 'hours';
            hoursCell.appendChild(hoursInput);
            row.appendChild(hoursCell);
          }

          const qtyCell = document.createElement('td');
          qtyCell.className = 'numeric';
          const qtyInput = document.createElement('input');
          qtyInput.type = 'number';
          qtyInput.step = 'any';
          qtyInput.value = entry.quantity || '';
          qtyInput.dataset.reportId = entry.id;
          qtyInput.dataset.groupId = groupId;
          qtyInput.dataset.field = 'quantity';
          qtyCell.appendChild(qtyInput);
          row.appendChild(qtyCell);

          const unitCell = document.createElement('td');
          const unitInput = document.createElement('input');
          unitInput.type = 'text';
          unitInput.value = entry.unit || '';
          unitInput.dataset.reportId = entry.id;
          unitInput.dataset.groupId = groupId;
          unitInput.dataset.field = 'unit';
          unitCell.appendChild(unitInput);
          row.appendChild(unitCell);

          const ronCell = document.createElement('td');
          ronCell.className = 'numeric';
          const ronInput = document.createElement('input');
          ronInput.type = 'number';
          ronInput.step = 'any';
          ronInput.value = entry.valueRon || '';
          ronInput.dataset.reportId = entry.id;
          ronInput.dataset.groupId = groupId;
          ronInput.dataset.field = 'valueRon';
          ronCell.appendChild(ronInput);
          row.appendChild(ronCell);

          const eurCell = document.createElement('td');
          eurCell.className = 'numeric';
          const eurInput = document.createElement('input');
          eurInput.type = 'number';
          eurInput.step = 'any';
          eurInput.value = entry.valueEur || '';
          eurInput.dataset.reportId = entry.id;
          eurInput.dataset.groupId = groupId;
          eurInput.dataset.field = 'valueEur';
          eurCell.appendChild(eurInput);
          row.appendChild(eurCell);

          const totalCell = document.createElement('td');
          totalCell.className = 'numeric';
          const totalInput = document.createElement('input');
          totalInput.type = 'text';
          totalInput.readOnly = true;
          totalInput.tabIndex = -1;
          totalInput.style.textAlign = 'right';
          const formattedTotal = Number.isFinite(totalNum) ? formatNumber(totalNum) : '';
          const fallbackCurrency = entry.valueCurrency || '';
          const fallbackText = entry.valueTotal || '';
          if(formattedTotal){
            totalInput.value = totalCurrency ? `${formattedTotal} ${totalCurrency}` : formattedTotal;
          } else if(fallbackText){
            totalInput.value = fallbackCurrency ? `${fallbackText} ${fallbackCurrency}` : fallbackText;
          } else {
            totalInput.value = '';
          }
          totalInput.dataset.reportId = entry.id;
          totalInput.dataset.groupId = groupId;
          totalInput.dataset.field = 'valueTotal';
          totalCell.appendChild(totalInput);
          row.appendChild(totalCell);

          const notesCell = document.createElement('td');
          const notesInput = document.createElement('textarea');
          notesInput.value = entry.notes || '';
          notesInput.dataset.reportId = entry.id;
          notesInput.dataset.groupId = groupId;
          notesInput.dataset.field = 'notes';
          notesCell.appendChild(notesInput);
          row.appendChild(notesCell);

          const actionsCell = document.createElement('td');
          actionsCell.className = 'actionsCell';
          const addActivityBtn = document.createElement('button');
          addActivityBtn.type = 'button';
          addActivityBtn.className = 'ghost';
          addActivityBtn.textContent = '➕';
          addActivityBtn.title = 'Adaugă activitate pentru echipă';
          addActivityBtn.dataset.reportAction = 'add-activity';
          addActivityBtn.dataset.reportGroupId = groupId;
          addActivityBtn.dataset.reportLineId = lineId || '';
          actionsCell.appendChild(addActivityBtn);
          const copyBtn = document.createElement('button');
          copyBtn.type = 'button';
          copyBtn.className = 'ghost';
          copyBtn.textContent = '📄';
          copyBtn.title = 'Copiază criteriul';
          copyBtn.dataset.reportAction = 'copy-group';
          copyBtn.dataset.reportGroupId = groupId;
          actionsCell.appendChild(copyBtn);
          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'ghost';
          removeBtn.textContent = '🗑️';
          removeBtn.title = 'Șterge criteriul';
          removeBtn.dataset.reportAction = 'remove-group';
          removeBtn.dataset.reportGroupId = groupId;
          actionsCell.appendChild(removeBtn);
          row.appendChild(actionsCell);

          reportsTableBody.appendChild(row);
        });
      }

      refreshReportsGrandTotalFromContexts(contexts);

      if(reportsClearBtn){
        reportsClearBtn.disabled = reportEntries.length === 0;
      }
      renderSavedReports();
      refreshReportSequenceUI();
      updateReportsSelectionMessage();
      updateReportsAddPromptHint();
      updateReportEditingUI();
    }

    function refreshReportSequenceUI(){
      const nextNumber = getNextReportNumber();
      if(reportNextNumberLabel){
        reportNextNumberLabel.textContent = String(nextNumber);
      }
      if(reportStartInput && !reportStartInput.value){
        reportStartInput.placeholder = `Pornește de la (următor: ${nextNumber})`;
      }
    }

    function applyReportSequenceStart(){
      if(!reportStartInput) return;
      const raw = Number(reportStartInput.value);
      if(!Number.isFinite(raw) || raw <= 0){
        alert('Introduceți un număr valid pentru startul numerotării.');
        reportStartInput.focus();
        return;
      }
      reportSequence = Math.max(1, Math.floor(raw));
      recalculateReportSequence();
      refreshReportSequenceUI();
      markDirty();
      scheduleLocalPersist();
    }

    function renderSavedReports(){
      if(!savedReportsList) return;
      savedReportsList.innerHTML='';
      if(!savedReports.length){
        savedReportsList.classList.add('empty');
        const empty = document.createElement('div');
        empty.className = 'muted';
        empty.textContent = 'Niciun raport salvat momentan.';
        savedReportsList.appendChild(empty);
        renderDashboard();
        return;
      }
      savedReportsList.classList.remove('empty');
      const items = [...savedReports].sort((a,b)=>{
        const da = new Date(a?.createdAt || 0).getTime();
        const db = new Date(b?.createdAt || 0).getTime();
        return db - da;
      });
      items.forEach(report=>{
        const card = document.createElement('div');
        card.className = 'savedReportCard';
        card.dataset.reportId = report.id;

        const header = document.createElement('header');
        const title = document.createElement('strong');
        const displayNumber = report.number !== undefined && report.number !== null ? report.number : getNextReportNumber();
        title.textContent = `Raport nr. ${displayNumber}`;
        header.appendChild(title);

        const actions = document.createElement('div');
        actions.className = 'savedReportActions';
        const loadBtn = document.createElement('button');
        loadBtn.type = 'button';
        loadBtn.className = 'primary';
        loadBtn.textContent = 'Încarcă';
        loadBtn.dataset.reportAction = 'load';
        loadBtn.dataset.reportId = report.id;
        actions.appendChild(loadBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'ghost';
        deleteBtn.textContent = 'Șterge';
        deleteBtn.dataset.reportAction = 'delete';
        deleteBtn.dataset.reportId = report.id;
        actions.appendChild(deleteBtn);

        header.appendChild(actions);
        card.appendChild(header);

        const meta = document.createElement('div');
        meta.className = 'savedReportMeta';
        const dateText = report.date ? niceDate(report.date) : '—';
        let savedText = '';
        if(report.createdAt){
          const savedDate = new Date(report.createdAt);
          if(!isNaN(savedDate.getTime())){
            savedText = savedDate.toLocaleString('ro-RO', { dateStyle:'medium', timeStyle:'short' });
          }
        }
        const parts = [`Data raport: ${dateText}`, `Persoane: ${Array.isArray(report.entries) ? report.entries.length : 0}`];
        if(savedText){
          parts.push(`Salvat: ${savedText}`);
        }
        const companyInfo = (report.company || '').trim();
        if(companyInfo){
          parts.push(`Firmă: ${companyInfo}`);
        }
        meta.textContent = parts.join(' • ');
        card.appendChild(meta);

        savedReportsList.appendChild(card);
      });
      renderDashboard();
    }

    function handleReportFieldInput(e){
      const target = e.target;
      if(!target?.dataset?.reportId || !target.dataset.field) return;
      const entry = reportEntries.find(item=>item.id === target.dataset.reportId);
      if(!entry) return;
      const field = target.dataset.field;
      if(field === 'valueTotal'){
        return;
      }
      const value = target.value;
      entry[field] = value;
      const affectsTotal = field === 'quantity' || field === 'valueRon' || field === 'valueEur';
      if(affectsTotal){
        const totalInfo = updateEntryTotal(entry);
        syncReportTotalInput(entry.id, totalInfo);
      }
      if(REPORT_GROUP_FIELDS.includes(field)){
        syncGroupField(entry, field, value, target);
      } else if(REPORT_LINE_FIELDS.includes(field)){
        syncLineField(entry, field, value, target);
      }
      if(affectsTotal){
        refreshReportsGrandTotal();
      }
      markDirty();
    }

    function handleReportTableClick(e){
      const btn = e.target.closest('button[data-report-action]');
      if(!btn) return;
      const action = btn.dataset.reportAction;
      if(action === 'remove'){
        removeReportEntry(btn.dataset.reportId);
      } else if(action === 'remove-member'){
        const groupId = btn.dataset.reportGroupId || '';
        const memberKey = btn.dataset.reportPersonKey || '';
        if(groupId && memberKey){
          removeReportMember(groupId, memberKey);
        } else {
          removeReportEntry(btn.dataset.reportId);
        }
      } else if(action === 'remove-group'){
        removeReportGroup(btn.dataset.reportGroupId || btn.dataset.groupId || '');
      } else if(action === 'copy-group'){
        duplicateReportGroup(btn.dataset.reportGroupId || btn.dataset.groupId || '');
      } else if(action === 'add-activity'){
        addReportActivity(btn.dataset.reportGroupId || '', btn.dataset.reportLineId || '');
      }
    }

    function syncReportTotalInput(reportId, info){
      if(!reportsTableBody) return;
      const totalInput = reportsTableBody.querySelector(`input[data-report-id="${reportId}"][data-field="valueTotal"]`);
      if(!totalInput) return;
      if(info && Number.isFinite(info.number)){
        const formatted = formatNumber(info.number);
        totalInput.value = info.currency ? `${formatted} ${info.currency}` : formatted;
      } else {
        totalInput.value = '';
      }
    }

    function ensureReportsSelectionCleared(selectEl){
      if(!selectEl) return;
      Array.from(selectEl.options).forEach(opt=>opt.selected=false);
      updateReportsSelectionMessage();
    }

    function buildReportsPdfHtml(){
      const contexts = getReportEntriesWithContext();
      if(!contexts.length){
        return '';
      }
      const esc = s=>String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;');
      const currentYear = new Date().getFullYear();
      const monthLabel = getDominantMonthLabelFromContexts(contexts);
      const periodLabel = monthLabel || niceDate(workDate?.value || todayStr());
      const reportTitle = monthLabel ? `Raport individual de lucru luna ${monthLabel}` : 'Raport individual de lucru';
      const generationDate = formatDateDMY(new Date());
      const companyLabel = (reportCompany || '').trim();
      const rowsHtml = contexts.map(ctx=>{
        const { rowNumber, entry, members, roleKey, hoursNum, qtyNum, ronNum, eurNum, totalNum, totalCurrency, groupLineCount = 1, isFirstLine = true } = ctx;
        const color = getRoleColor(roleKey || '—');
        const background = color?.bg || '#ffffff';
        const hoursDisplay = Number.isFinite(hoursNum) ? formatNumber(hoursNum) : esc(entry.hours || '');
        const qtyDisplay = Number.isFinite(qtyNum) ? formatNumber(qtyNum) : esc(entry.quantity || '');
        const ronDisplay = Number.isFinite(ronNum) ? formatNumber(ronNum) : esc(entry.valueRon || '');
        const eurDisplay = Number.isFinite(eurNum) ? formatNumber(eurNum) : esc(entry.valueEur || '');
        const totalDisplay = Number.isFinite(totalNum)
          ? formatNumber(totalNum)
          : esc(entry.valueTotal || '');
        const formattedDate = formatDateDMY(entry.date);
        const dateDisplay = formattedDate ? esc(formattedDate) : '';
        const activityHtml = esc(entry.activity || '').replace(/\n/g,'<br>');
        const notesHtml = esc(entry.notes || '').replace(/\n/g,'<br>');
        const nrDisplay = String(rowNumber);
        const namesHtml = Array.isArray(members) && members.length
          ? members.map(member=>{
              const baseName = esc(member?.displayName || member?.entry?.snapshotName || '(fără nume)');
              if(member?.person && member.person.status && member.person.status !== 'Activ'){
                return `${baseName} <span class="status">(${esc(member.person.status)})</span>`;
              }
              if(!member?.person){
                return `${baseName} <span class="status">(persoană lipsă)</span>`;
              }
              return baseName;
            }).join('<br>')
          : esc(entry.snapshotName || '(fără nume)');
        const totalWithCurrency = Number.isFinite(totalNum)
          ? (totalCurrency ? `${formatNumber(totalNum)} ${totalCurrency}` : formatNumber(totalNum))
          : (entry.valueCurrency ? `${esc(entry.valueTotal || '')} ${esc(entry.valueCurrency)}` : totalDisplay);
        const lineCount = Math.max(1, groupLineCount || 1);
        const rowSpanAttr = lineCount > 1 ? ` rowspan="${lineCount}"` : '';
        const cells = [];
        if(isFirstLine){
          cells.push(`<td${rowSpanAttr} style="font-weight:600;text-align:center">${nrDisplay}</td>`);
          cells.push(`<td${rowSpanAttr}>${dateDisplay}</td>`);
          cells.push(`<td${rowSpanAttr}>${namesHtml}</td>`);
        }
        const hoursCellHtml = isFirstLine
          ? `<td${rowSpanAttr} style="text-align:right">${hoursDisplay}</td>`
          : '';
        const baseRow = `<tr style="background:${background}">`
          + cells.join('')
          + `<td>${activityHtml}</td>`
          + hoursCellHtml
          + `<td style="text-align:right">${qtyDisplay}</td>`
          + `<td>${esc(entry.unit || '')}</td>`
          + `<td style="text-align:right">${ronDisplay}</td>`
          + `<td style="text-align:right">${eurDisplay}</td>`
          + `<td style="text-align:right">${totalWithCurrency}</td>`
          + `<td>${notesHtml}</td>`
        + `</tr>`;
        return baseRow;
      }).join('');

      const totalsMap = computeCurrencyTotals(contexts);
      const totalsSummary = formatCurrencyTotals(totalsMap) || '0';

      const totalsRowHtml = `<tfoot><tr>`
        + `<td colspan="10" style="text-align:right;font-weight:600">${esc(totalsSummary)}</td>`
        + `<td></td>`
      + `</tr></tfoot>`;

      const personRows = buildPersonSummaryRows(contexts);

      const summaryRowsHtml = personRows.length
        ? personRows.map(item=>{
            const hoursText = item.hasHours ? formatNumber(item.hours) : '0';
            const totalsText = item.summary || '—';
            return `<tr><td>${esc(item.name)}</td><td>${esc(totalsText)}</td><td>${esc(hoursText)}</td></tr>`;
          }).join('')
        : `<tr><td colspan="3" class="muted">Nu există sume înregistrate.</td></tr>`;

      const copyrightText = `© ${currentYear} — Aplicație șantier Ticlete Gabriel`;

      return `<!DOCTYPE html><html><head><meta charset="utf-8" />`
        + `<title>${esc(reportTitle)}</title>`
        + `<style>`
        + `  body{font-family:system-ui,-apple-system,Segoe UI,Roboto;margin:24px;color:#0f172a;background:#f8fafc;padding-bottom:60px}`
        + `  h1{color:#1e3a8a;margin-bottom:8px}`
        + `  .muted{color:#6b7280}`
        + `  table{width:100%;border-collapse:collapse;font-size:12px}`
        + `  th,td{border:1px solid #d1d5db;padding:6px 8px;vertical-align:top;color:#000}`
        + `  th{background:#111827;color:red;font-size:13px}`
        + `  tr{break-inside:avoid}`
        + `  td span.status{color:#b91c1c;font-size:11px}`
        + `  table.personSummary th, table.personSummary td{text-align:left}`
        + `  table.personSummary th{background:#111827;color:red;font-size:13px}`
        + `  table.personSummary td{font-size:14px}`
        + `  table.personSummary th:nth-child(2), table.personSummary td:nth-child(2){width:130px}`
        + `  table.personSummary th:nth-child(3), table.personSummary td:nth-child(3){width:110px}`
        + `  footer.pageFooter{position:fixed;left:0;right:0;bottom:12px;text-align:center;font-size:11px;color:#6b7280}`
        + `  @page { size: A4 landscape; margin: 14mm; }`
        + `  @media print { footer.pageFooter{bottom:10mm;} }`
        + `</style>`
        + `</head><body>`
        + `<h1>${esc(reportTitle)}</h1>`
        + (companyLabel ? `<div style="margin-bottom:8px;font-size:15px"><strong style="font-size:15px">Firmă:</strong> <span style="font-size:15px">${esc(companyLabel)}</span></div>` : '')
        + `<div class="muted">Perioada raportului: ${esc(periodLabel)}</div>`
        + (generationDate ? `<div class="muted">Data generare raport: ${esc(generationDate)}</div>` : '')
        + `<table>`
        + `  <thead>`
        + `    <tr>`
        + `      <th>Nr.</th><th>Data</th><th>Nume &amp; echipă</th><th>Descriere activitate</th><th>Ore lucrate</th><th>Cantitate</th><th>U.M.</th><th>Valoare (RON)</th><th>Valoare (EUR)</th><th>Total</th><th>Observații</th>`
        + `    </tr>`
        + `  </thead>`
        + `  <tbody>${rowsHtml}</tbody>`
        + `  ${totalsRowHtml}`
        + `</table>`
        + `<h2 style="margin-top:20px">Sinteză pe persoane</h2>`
        + `<table class="personSummary">`
        + `  <thead><tr><th>Nume</th><th>Totaluri</th><th>Ore lucrate</th></tr></thead>`
        + `  <tbody>${summaryRowsHtml}</tbody>`
        + `</table>`
        + `<footer class="pageFooter">${esc(copyrightText)}</footer>`
        + `</body></html>`;
    }

    function exportReportsPdf(){
      if(!reportEntries.length){
        alert('Nu există persoane în raport.');
        return;
      }
      const html = buildReportsPdfHtml();
      if(!html){
        alert('Nu s-a putut genera raportul.');
        return;
      }
      const w = window.open('', '_blank');
      if(!w){ alert('Popup blocat. Permite deschiderea de ferestre pentru export PDF.'); return; }
      w.document.open(); w.document.write(html); w.document.close(); setTimeout(()=>{ w.focus(); w.print(); }, 300);
    }

    function escapeXml(text){
      return String(text ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;');
    }

    const utf8Encoder = new TextEncoder();

    function encodeUtf8(str){
      return utf8Encoder.encode(String(str ?? ''));
    }

    function formatNumberForExcel(value){
      if(!Number.isFinite(value)) return '';
      return (Math.round(value * 100) / 100).toFixed(2);
    }

    function columnLetter(index){
      let dividend = index + 1;
      let letters = '';
      while(dividend > 0){
        const modulo = (dividend - 1) % 26;
        letters = String.fromCharCode(65 + modulo) + letters;
        dividend = Math.floor((dividend - modulo) / 26);
      }
      return letters;
    }

    const CRC32_TABLE = (()=>{
      const table = new Uint32Array(256);
      for(let i=0;i<256;i++){
        let c = i;
        for(let k=0;k<8;k++){
          c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
        }
        table[i] = c >>> 0;
      }
      return table;
    })();

    function crc32(array){
      let crc = 0 ^ (-1);
      for(let i=0;i<array.length;i++){
        crc = (crc >>> 8) ^ CRC32_TABLE[(crc ^ array[i]) & 0xff];
      }
      return (crc ^ (-1)) >>> 0;
    }

    function writeUint16LE(buffer, offset, value){
      buffer[offset] = value & 0xff;
      buffer[offset + 1] = (value >>> 8) & 0xff;
    }

    function writeUint32LE(buffer, offset, value){
      buffer[offset] = value & 0xff;
      buffer[offset + 1] = (value >>> 8) & 0xff;
      buffer[offset + 2] = (value >>> 16) & 0xff;
      buffer[offset + 3] = (value >>> 24) & 0xff;
    }

    function createZipFile(files){
      let offset = 0;
      const chunks = [];
      const records = [];

      files.forEach(file=>{
        const data = file.content instanceof Uint8Array ? file.content : encodeUtf8(file.content || '');
        const nameBytes = encodeUtf8(file.name);
        const crc = crc32(data);
        const compressedSize = data.length;
        const uncompressedSize = data.length;
        const localHeader = new Uint8Array(30 + nameBytes.length);
        writeUint32LE(localHeader, 0, 0x04034b50);
        writeUint16LE(localHeader, 4, 20);
        writeUint16LE(localHeader, 6, 0);
        writeUint16LE(localHeader, 8, 0);
        writeUint16LE(localHeader, 10, 0);
        writeUint16LE(localHeader, 12, 0);
        writeUint32LE(localHeader, 14, crc);
        writeUint32LE(localHeader, 18, compressedSize);
        writeUint32LE(localHeader, 22, uncompressedSize);
        writeUint16LE(localHeader, 26, nameBytes.length);
        writeUint16LE(localHeader, 28, 0);
        localHeader.set(nameBytes, 30);
        const localOffset = offset;
        offset += localHeader.length + data.length;
        chunks.push(localHeader, data);
        records.push({ nameBytes, crc, compressedSize, uncompressedSize, offset: localOffset });
      });

      const centralChunks = [];
      let centralSize = 0;
      const centralOffset = offset;

      records.forEach(record=>{
        const { nameBytes, crc, compressedSize, uncompressedSize, offset: localOffset } = record;
        const centralHeader = new Uint8Array(46 + nameBytes.length);
        writeUint32LE(centralHeader, 0, 0x02014b50);
        writeUint16LE(centralHeader, 4, 0x0014);
        writeUint16LE(centralHeader, 6, 20);
        writeUint16LE(centralHeader, 8, 0);
        writeUint16LE(centralHeader, 10, 0);
        writeUint16LE(centralHeader, 12, 0);
        writeUint16LE(centralHeader, 14, 0);
        writeUint32LE(centralHeader, 16, crc);
        writeUint32LE(centralHeader, 20, compressedSize);
        writeUint32LE(centralHeader, 24, uncompressedSize);
        writeUint16LE(centralHeader, 28, nameBytes.length);
        writeUint16LE(centralHeader, 30, 0);
        writeUint16LE(centralHeader, 32, 0);
        writeUint16LE(centralHeader, 34, 0);
        writeUint16LE(centralHeader, 36, 0);
        writeUint32LE(centralHeader, 38, 0);
        writeUint32LE(centralHeader, 42, localOffset);
        centralHeader.set(nameBytes, 46);
        centralChunks.push(centralHeader);
        centralSize += centralHeader.length;
      });

      offset += centralSize;

      const endRecord = new Uint8Array(22);
      writeUint32LE(endRecord, 0, 0x06054b50);
      writeUint16LE(endRecord, 4, 0);
      writeUint16LE(endRecord, 6, 0);
      writeUint16LE(endRecord, 8, records.length);
      writeUint16LE(endRecord, 10, records.length);
      writeUint32LE(endRecord, 12, centralSize);
      writeUint32LE(endRecord, 16, centralOffset);
      writeUint16LE(endRecord, 20, 0);

      const totalSize = chunks.reduce((sum, chunk)=>sum + chunk.length, 0) + centralSize + endRecord.length;
      const output = new Uint8Array(totalSize);
      let position = 0;
      chunks.forEach(chunk=>{ output.set(chunk, position); position += chunk.length; });
      centralChunks.forEach(chunk=>{ output.set(chunk, position); position += chunk.length; });
      output.set(endRecord, position);
      return output;
    }

    function buildSheetXml(contexts, totalsSummary, personRows){
      const headers = ['Nr.', 'Data', 'Nume & echipă', 'Descriere activitate', 'Ore lucrate', 'Cantitate', 'U.M.', 'Valoare (RON)', 'Valoare (EUR)', 'Total', 'Observații'];
      const rows = [];
      rows.push(headers.map(value=>({ type:'s', value })));

      contexts.forEach(ctx=>{
        const entry = ctx.entry || {};
        const hasQty = Number.isFinite(ctx.qtyNum);
        const hasRon = Number.isFinite(ctx.ronNum);
        const hasEur = Number.isFinite(ctx.eurNum);
        const namesValue = Array.isArray(ctx.members) && ctx.members.length
          ? ctx.members.map(member=> member?.displayName || member?.entry?.snapshotName || '').filter(Boolean).join(', ')
          : (ctx.entry?.snapshotName || '');
        const totalString = Number.isFinite(ctx.totalNum)
          ? (ctx.totalCurrency ? `${formatNumberForExcel(ctx.totalNum)} ${ctx.totalCurrency}` : formatNumberForExcel(ctx.totalNum))
          : (entry.valueCurrency ? `${entry.valueTotal || ''} ${entry.valueCurrency}` : (entry.valueTotal || ''));
        const formattedDate = formatDateDMY(entry.date);
        const shareHoursAcrossGroup = Number(ctx.groupLineCount || 1) > 1;
        const hoursCell = ctx.isFirstLine
          ? (Number.isFinite(ctx.hoursNum) ? { type:'n', value: formatNumberForExcel(ctx.hoursNum) } : { type:'s', value: entry.hours || '' })
          : (shareHoursAcrossGroup ? { type:'s', value: '' } : { type:'s', value: entry.hours || '' });
        const rowCells = [
          { type:'n', value: String(ctx.rowNumber || '') },
          { type:'s', value: formattedDate || '' },
          { type:'s', value: namesValue },
          { type:'s', value: entry.activity || '' },
          hoursCell,
          hasQty ? { type:'n', value: formatNumberForExcel(ctx.qtyNum) } : { type:'s', value: entry.quantity || '' },
          { type:'s', value: entry.unit || '' },
          hasRon ? { type:'n', value: formatNumberForExcel(ctx.ronNum) } : { type:'s', value: entry.valueRon || '' },
          hasEur ? { type:'n', value: formatNumberForExcel(ctx.eurNum) } : { type:'s', value: entry.valueEur || '' },
          null,
          { type:'s', value: entry.notes || '' }
        ];

        const shouldUseFormula = hasQty && (hasRon || hasEur);
        if(shouldUseFormula){
          const formulaTemplate = '=IF(AND(ISNUMBER(F{row}),ISNUMBER(H{row})),TEXT(F{row}*H{row},"0.00")&" RON",IF(AND(ISNUMBER(F{row}),ISNUMBER(I{row})),TEXT(F{row}*I{row},"0.00")&" EUR",""))';
          rowCells[9] = { type:'f', formulaTemplate, result: totalString };
        } else if(totalString){
          rowCells[9] = { type:'s', value: totalString };
        }

        rows.push(rowCells);
      });

      const totalRow = new Array(headers.length).fill(null);
      totalRow[9] = { type:'s', value: totalsSummary };
      rows.push(totalRow);

      rows.push([]);

      rows.push([
        { type:'s', value:'Nume' },
        { type:'s', value:'Ore lucrate' },
        { type:'s', value:'Totaluri' }
      ]);
      personRows.forEach(item=>{
        const hoursCell = item.hasHours
          ? { type:'n', value: formatNumberForExcel(item.hours) }
          : { type:'n', value: '0' };
        rows.push([
          { type:'s', value:item.name },
          hoursCell,
          { type:'s', value:item.summary || '—' }
        ]);
      });

      const dimensionRef = `A1:${columnLetter(headers.length - 1)}${rows.length}`;

      const sheetRowsXml = rows.map((cells, rowIndex)=>{
        const r = rowIndex + 1;
        if(!cells || !cells.length){
          return `<row r="${r}"/>`;
        }
        const cellsXml = cells.map((cell, colIndex)=>{
          if(!cell) return '';
          const cellRef = `${columnLetter(colIndex)}${r}`;
          if(cell.type === 'f'){
            const template = cell.formulaTemplate || cell.formula || '';
            if(!template) return '';
            const formula = escapeXml(template.replace(/\{row\}/g, String(r)));
            const cached = cell.result ?? '';
            if(cached !== undefined && cached !== null && cached !== ''){
              return `<c r="${cellRef}" t="str"><f>${formula}</f><v>${escapeXml(cached)}</v></c>`;
            }
            return `<c r="${cellRef}" t="str"><f>${formula}</f></c>`;
          }
          if(cell.value === undefined || cell.value === null || cell.value === '') return '';
          if(cell.type === 'n'){
            return `<c r="${cellRef}"><v>${cell.value}</v></c>`;
          }
          const text = escapeXml(cell.value);
          return `<c r="${cellRef}" t="inlineStr"><is><t>${text}</t></is></c>`;
        }).filter(Boolean).join('');
        return `<row r="${r}">${cellsXml}</row>`;
      }).join('');

      return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>`
        + `<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">`
        + `<dimension ref="${dimensionRef}"/>`
        + `<sheetData>${sheetRowsXml}</sheetData>`
        + `</worksheet>`;
    }

    function buildXlsxArchive(contexts, totalsSummary, personRows){
      const sheetXml = buildSheetXml(contexts, totalsSummary, personRows);
      const timestamp = new Date().toISOString();
      const contentTypes = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>`
        + `<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">`
        + `<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>`
        + `<Default Extension="xml" ContentType="application/xml"/>`
        + `<Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>`
        + `<Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>`
        + `<Override PartName="/xl/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml"/>`
        + `<Override PartName="/docProps/core.xml" ContentType="application/vnd.openxmlformats-package.core-properties+xml"/>`
        + `<Override PartName="/docProps/app.xml" ContentType="application/vnd.openxmlformats-officedocument.extended-properties+xml"/>`
        + `</Types>`;

      const rels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>`
        + `<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">`
        + `<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>`
        + `<Relationship Id="rId2" Type="http://schemas.openxmlformats.org/package/2006/relationships/metadata/core-properties" Target="docProps/core.xml"/>`
        + `<Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/extended-properties" Target="docProps/app.xml"/>`
        + `</Relationships>`;

      const workbookXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>`
        + `<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">`
        + `<sheets><sheet name="Raport" sheetId="1" r:id="rId1"/></sheets>`
        + `</workbook>`;

      const workbookRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>`
        + `<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">`
        + `<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>`
        + `<Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>`
        + `</Relationships>`;

      const stylesXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>`
        + `<styleSheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">`
        + `<fonts count="1"><font><sz val="11"/><name val="Calibri"/></font></fonts>`
        + `<fills count="1"><fill><patternFill patternType="none"/></fill></fills>`
        + `<borders count="1"><border/></borders>`
        + `<cellStyleXfs count="1"><xf numFmtId="0" fontId="0" fillId="0" borderId="0"/></cellStyleXfs>`
        + `<cellXfs count="1"><xf numFmtId="0" fontId="0" fillId="0" borderId="0" xfId="0"/></cellXfs>`
        + `</styleSheet>`;

      const coreProps = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>`
        + `<cp:coreProperties xmlns:cp="http://schemas.openxmlformats.org/package/2006/metadata/core-properties" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:dcterms="http://purl.org/dc/terms/" xmlns:dcmitype="http://purl.org/dc/dcmitype/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">`
        + `<dc:title>Raport</dc:title>`
        + `<dc:creator>Aplicație șantier</dc:creator>`
        + `<cp:lastModifiedBy>Aplicație șantier</cp:lastModifiedBy>`
        + `<dcterms:created xsi:type="dcterms:W3CDTF">${timestamp}</dcterms:created>`
        + `<dcterms:modified xsi:type="dcterms:W3CDTF">${timestamp}</dcterms:modified>`
        + `</cp:coreProperties>`;

      const appProps = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>`
        + `<Properties xmlns="http://schemas.openxmlformats.org/officeDocument/2006/extended-properties" xmlns:vt="http://schemas.openxmlformats.org/officeDocument/2006/docPropsVTypes">`
        + `<Application>Aplicație șantier</Application>`
        + `</Properties>`;

      return createZipFile([
        { name:'[Content_Types].xml', content: contentTypes },
        { name:'_rels/.rels', content: rels },
        { name:'docProps/app.xml', content: appProps },
        { name:'docProps/core.xml', content: coreProps },
        { name:'xl/workbook.xml', content: workbookXml },
        { name:'xl/_rels/workbook.xml.rels', content: workbookRels },
        { name:'xl/styles.xml', content: stylesXml },
        { name:'xl/worksheets/sheet1.xml', content: sheetXml }
      ]);
    }

    function exportReportsXlsx(){
      if(!reportEntries.length){
        alert('Nu există persoane în raport.');
        return;
      }
      const contexts = getReportEntriesWithContext();
      if(!contexts.length){
        alert('Nu există date de exportat.');
        return;
      }
      const totalsMap = computeCurrencyTotals(contexts);
      const totalsSummary = formatCurrencyTotals(totalsMap) || '0';
      const personRows = buildPersonSummaryRows(contexts);
      const archive = buildXlsxArchive(contexts, totalsSummary, personRows);
      const blob = new Blob([archive], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const datePart = workDate?.value || todayStr();
      a.href = url;
      a.download = `raport-${datePart}.xlsx`;
      a.click();
      URL.revokeObjectURL(url);
    }

    reportsSearchInput?.addEventListener('input', ()=>{
      reportsSearchTerm = reportsSearchInput.value || '';
      renderReports();
    });

    reportCompanyInput?.addEventListener('input', ()=>{
      reportCompany = reportCompanyInput.value || '';
      reportCompanyInput.classList.remove('invalid');
      markDirty();
      scheduleLocalPersist();
    });

    reportsActiveSelect?.addEventListener('change', updateReportsSelectionMessage);
    reportsInactiveSelect?.addEventListener('change', updateReportsSelectionMessage);

    reportStartApplyBtn?.addEventListener('click', applyReportSequenceStart);
    reportStartInput?.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        applyReportSequenceStart();
      }
    });

    reportsSaveSnapshotBtn?.addEventListener('click', ()=>{
      if(!reportEntries.length){
        alert('Nu există persoane în raport de salvat.');
        return;
      }
      const timestamp = new Date().toISOString();
      const reportDate = workDate?.value || todayStr();
      const companyValue = (reportCompany || '').trim();
      if(!companyValue){
        alert('Introduceți firma înainte de a salva raportul.');
        if(reportCompanyInput){
          reportCompanyInput.classList.add('invalid');
          reportCompanyInput.focus();
        }
        return;
      }
      const clonedEntries = reportEntries.map(cloneReportEntry);

      if(editingReportId){
        const index = savedReports.findIndex(item=>item.id === editingReportId);
          if(index >= 0){
            const existing = savedReports[index] || {};
            const preservedNumber = existing.number !== undefined ? existing.number : (editingReportNumber ?? getNextReportNumber());
            savedReports[index] = {
              id: editingReportId,
              number: preservedNumber,
              createdAt: timestamp,
              date: reportDate,
              company: companyValue,
              entries: clonedEntries
            };
          } else {
            const fallbackNumber = editingReportNumber ?? getNextReportNumber();
            savedReports = [{
              id: editingReportId,
              number: fallbackNumber,
              createdAt: timestamp,
              date: reportDate,
              company: companyValue,
              entries: clonedEntries
            }, ...savedReports];
          const numericFallback = parseReportNumber(fallbackNumber);
          if(Number.isFinite(numericFallback)){
            reportSequence = Math.max(reportSequence || 1, numericFallback + 1);
          }
        }
      } else {
        const reportNumber = getNextReportNumber();
        const snapshot = {
          id: 'saved'+Math.random().toString(36).slice(2,7),
          number: reportNumber,
          createdAt: timestamp,
          date: reportDate,
          company: companyValue,
          entries: clonedEntries
        };
        savedReports = [snapshot, ...savedReports];
        reportSequence = Math.max(reportSequence || 1, reportNumber + 1);
      }

      recalculateReportSequence();
      reportEntries = [];
      setCurrentReportEditing(null);
      renderReports();
      markDirty();
      scheduleLocalPersist();
    });

    savedReportsList?.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-report-action]');
      if(!btn) return;
      const id = btn.dataset.reportId;
      const report = savedReports.find(item=>item.id === id);
      if(btn.dataset.reportAction === 'load'){
        if(!report) return;
        if(reportsSearchInput){
          reportsSearchTerm = '';
          reportsSearchInput.value = '';
        }
        reportEntries = Array.isArray(report.entries) ? report.entries.map(mapImportedReportEntry) : [];
        normalizeReportEntriesAfterLoad();
        reportCompany = typeof report.company === 'string' ? report.company.trim() : '';
        setCurrentReportEditing(report.id, report.number);
        renderReports();
        markDirty();
      } else if(btn.dataset.reportAction === 'delete'){
        if(!report) return;
        if(!confirm('Ștergi raportul salvat?')) return;
        savedReports = savedReports.filter(item=>item.id !== id);
        if(editingReportId === id){
          setCurrentReportEditing(null);
        }
        recalculateReportSequence();
        renderSavedReports();
        refreshReportSequenceUI();
        markDirty();
      }
    });

    function handleReportsAddFromSelect(selectEl){
      if(!selectEl) return;
      const ids = Array.from(selectEl.selectedOptions || []).map(opt=>opt.value).filter(Boolean);
      if(!ids.length) return;
      requestReportsAdd(ids, selectEl);
    }

    reportsAddActiveBtn?.addEventListener('click', ()=>{
      handleReportsAddFromSelect(reportsActiveSelect);
    });

    reportsAddInactiveBtn?.addEventListener('click', ()=>{
      handleReportsAddFromSelect(reportsInactiveSelect);
    });

    reportsActiveSelect?.addEventListener('dblclick', ()=>{
      handleReportsAddFromSelect(reportsActiveSelect);
    });

    reportsInactiveSelect?.addEventListener('dblclick', ()=>{
      handleReportsAddFromSelect(reportsInactiveSelect);
    });

    reportsAddPromptNewBtn?.addEventListener('click', ()=>{
      if(!pendingReportAddIds.length){
        closeReportsAddPrompt();
        finalizeReportsAdd(false);
        return;
      }
      setReportsAddPromptError('');
      const added = addPeopleToReport(pendingReportAddIds, { mode: 'new' });
      if(added){
        finalizeReportsAdd(true);
        closeReportsAddPrompt();
      } else {
        setReportsAddPromptError('Nu s-au putut adăuga persoanele selectate.');
      }
    });

    reportsAddPromptTeamBtn?.addEventListener('click', ()=>{
      if(!reportEntries.length){
        setReportsAddPromptError('Nu există criterii în raport. Folosește „Adaugă nou”.');
        return;
      }
      if(!pendingReportAddIds.length){
        setReportsAddPromptError('Selectează persoanele din listă.');
        return;
      }
      const numbers = getReportGroupNumbers();
      if(!numbers.length){
        setReportsAddPromptError('Nu există criterii existente. Creează unul nou.');
        return;
      }
      setReportsAddPromptError('');
      updateReportsAddPromptHint();
      renderReportsAddPromptGroups();
      reportsAddPromptTeamSection?.classList.add('active');
      const firstBtn = reportsAddPromptGroupList?.querySelector('button');
      firstBtn?.focus();
    });

    reportsAddPromptTeamCancelBtn?.addEventListener('click', ()=>{
      reportsAddPromptTeamSection?.classList.remove('active');
      if(reportsAddPromptGroupList){
        reportsAddPromptGroupList.innerHTML = '';
      }
      setReportsAddPromptError('');
      (reportsAddPromptNewBtn || reportsAddPromptTeamBtn)?.focus();
    });

    reportsAddPromptGroupList?.addEventListener('click', (event)=>{
      const btn = event.target.closest('button[data-report-number]');
      if(!btn) return;
      if(!pendingReportAddIds.length){
        setReportsAddPromptError('Selectează persoanele din listă.');
        return;
      }
      const number = Number(btn.dataset.reportNumber);
      if(!Number.isFinite(number) || number <= 0){
        setReportsAddPromptError('Selecția nu este validă.');
        return;
      }
      const groupId = getGroupIdByNumber(Math.floor(number));
      if(!groupId){
        setReportsAddPromptError('Criteriul selectat nu mai există.');
        renderReportsAddPromptGroups();
        return;
      }
      const added = addPeopleToReport(pendingReportAddIds, { mode: 'group', groupId, showDuplicateWarning: true });
      if(added){
        finalizeReportsAdd(true);
        closeReportsAddPrompt();
      }
    });

    reportsAddPromptCloseBtn?.addEventListener('click', ()=>{
      closeReportsAddPrompt();
      finalizeReportsAdd(false);
    });

    reportsAddPrompt?.addEventListener('click', (event)=>{
      if(event.target === reportsAddPrompt){
        closeReportsAddPrompt();
        finalizeReportsAdd(false);
      }
    });

    window.addEventListener('keydown', (event)=>{
      if(event.key === 'Escape' && reportsAddPrompt?.classList.contains('show')){
        event.preventDefault();
        closeReportsAddPrompt();
        finalizeReportsAdd(false);
      }
    });

    reportsClearBtn?.addEventListener('click', ()=>{
      if(!reportEntries.length) return;
      if(!confirm('Golești raportul curent?')) return;
      reportEntries = [];
      reportCompany = '';
      setCurrentReportEditing(null);
      renderReports();
      markDirty();
    });

    reportsTableBody?.addEventListener('input', handleReportFieldInput);
    reportsTableBody?.addEventListener('change', handleReportFieldInput);
    reportsTableBody?.addEventListener('click', handleReportTableClick);

    reportsExportPdfBtn?.addEventListener('click', exportReportsPdf);
    reportsExportExcelBtn?.addEventListener('click', exportReportsXlsx);

    // ======= Duplicates =======
    function findDuplicates(){ const byName={}; people.filter(Boolean).forEach(p=>{ const n=normName(p.name); if(!n) return; byName[n]=(byName[n]||0)+1; }); return new Set(Object.entries(byName).filter(([_,c])=>c>1).map(([n])=>n)); }
    function validateDuplicates(showBanner){ const dups=findDuplicates(); if(showBanner){ dupAlert.classList.toggle('show', dups.size>0); } return dups; }
    function showDupAlert(msg){ dupAlert.textContent = '⚠️ ' + msg; dupAlert.classList.add('show'); setTimeout(()=>dupAlert.classList.remove('show'), 3500); }

    // ======= Selecție & Formulare =======
    function select(sel){ selected = sel; renderForms(); deleteBtn.disabled = !selected; highlight(); }
    function highlight(){
      document.querySelectorAll('.zoneBox').forEach(box=>{
        const zId=box.dataset.zoneId;
        if(selected && selected.type==='zone' && selected.id===zId) box.classList.add('active');
        else box.classList.remove('active');
      });
      document.querySelectorAll('.personRow').forEach(row=>{
        const pid = row.dataset.personId;
        if(selected && selected.type==='person' && selected.id===pid) row.classList.add('selected');
        else row.classList.remove('selected');
      });
    }

    const zoneForm = document.getElementById('zoneForm');
    const personForm = document.getElementById('personForm');

    function renderForms(){
      const noSel = document.getElementById('noSelection');
      const zoneSelect = document.getElementById('personZone');
      const roleSelect = document.getElementById('personRole');
      const editorHeader = document.getElementById('editorHeader');
      const editorDivider = document.getElementById('editorDivider');
      zoneSelect.innerHTML=''; roleSelect.innerHTML=''; roles = normalizeRoles(roles);
      zones.slice().sort((a,b)=>a.gridIndex-b.gridIndex).forEach(z=>{ const o=document.createElement('option'); o.value=z.id; o.textContent=z.name||z.id; zoneSelect.appendChild(o); });
      roles.forEach(rn=>{ const o=document.createElement('option'); o.value=rn; o.textContent=rn; roleSelect.appendChild(o); });

      if(!selected){
        if(editorHeader) editorHeader.style.display='none';
        if(editorDivider) editorDivider.style.display='none';
        noSel.style.display='none';
        zoneForm.style.display='none';
        personForm.style.display='none';
        deleteBtn.disabled = true;
        if(personNameInput){
          personNameInput.value = '';
          personNameInput.readOnly = anonymize;
          delete personNameInput.dataset.actualName;
        }
        if(resignationDateInput){
          resignationDateInput.value = '';
        }
        if(statusSelect){
          statusSelect.dataset.prevValue = 'Activ';
        }
        updateStatusFormVisibility();
        return;
      }
      if(editorHeader) editorHeader.style.display='block';
      if(editorDivider) editorDivider.style.display='block';
      noSel.style.display='none'; deleteBtn.disabled = false;

      if(selected.type==='zone'){
        const z = zones.find(x=>x.id===selected.id) || {};
        zoneForm.style.display='grid'; personForm.style.display='none';
        document.getElementById('zoneName').value = z.name || '';
        document.getElementById('gridIndex').value = z.gridIndex ?? 0;
        document.getElementById('zoneStart').value = z.startDate || '';
        document.getElementById('zoneEnd').value = z.endDate || '';
        if(personNameInput){
          personNameInput.value = '';
          personNameInput.readOnly = anonymize;
          delete personNameInput.dataset.actualName;
        }
        if(resignationDateInput){
          resignationDateInput.value = '';
        }
        if(statusSelect){
          statusSelect.dataset.prevValue = statusSelect.value || 'Activ';
        }
        updateStatusFormVisibility();
      } else {
        const p = people.find(x=>x && x.id===selected.id) || {};
        zoneForm.style.display='none'; personForm.style.display='grid';
        if(personNameInput){
          if(anonymize){
            personNameInput.value = getDisplayName(p);
            personNameInput.readOnly = true;
            personNameInput.dataset.actualName = p.name || '';
          } else {
            personNameInput.value = p.name || '';
            personNameInput.readOnly = false;
            delete personNameInput.dataset.actualName;
          }
        }
        roleSelect.value = p.role || roles[0] || '';
        document.getElementById('personZone').value = p.zoneId || (zones[0]?.id || '');
        statusSelect.value = p.status || 'Activ';
        statusSelect.dataset.prevValue = statusSelect.value || 'Activ';
        inactiveFromInput.value = p.inactiveFrom || '';
        inactiveToInput.value = p.inactiveTo || '';
        if(resignationDateInput){
          resignationDateInput.value = p.resignationDate || '';
        }
        updateStatusFormVisibility();
      }
    }

    document.getElementById('applyZone').addEventListener('click',()=>{
      if(!(selected && selected.type==='zone')) return; const z = zones.find(x=>x.id===selected.id); if(!z) return;
      z.name = document.getElementById('zoneName').value || '';
      z.gridIndex = +document.getElementById('gridIndex').value || 0;
      z.startDate = document.getElementById('zoneStart').value || '';
      z.endDate = document.getElementById('zoneEnd').value || '';
      render(); markDirty();
    });

    document.getElementById('applyPerson').addEventListener('click',()=>{
      if(!(selected && selected.type==='person')) return; const p = people.find(x=>x && x.id===selected.id); if(!p) return;
      const inputValue = personNameInput ? personNameInput.value : '';
      const actualStoredName = personNameInput?.dataset?.actualName;
      const newNameRaw = anonymize ? (actualStoredName || p.name) : (inputValue || p.name);
      const newName = (newNameRaw || '').trim() || p.name || '';
      const newZone = document.getElementById('personZone').value;
      const newRole = document.getElementById('personRole').value;
      const newStatus = statusSelect.value || 'Activ';
      const newInactiveFrom = inactiveFromInput.value || '';
      const newInactiveTo = inactiveToInput.value || newInactiveFrom;
      const newResignationDate = resignationDateInput.value || '';
      if(isNameDuplicatedExcluding(newName, p.id)){
        showDupAlert(`${nameForAlert(p, newName)} există deja ca persoană distinctă. Te rog redenumește unul dintre înregistrări.`);
        return;
      }

      p.name = newName; p.role = newRole; p.status = newStatus;

      if(newStatus === 'Demisie'){
        if(!newResignationDate){
          alert('Selectează data demisiei.');
          resignationDateInput?.focus();
          return;
        }
        p.zoneId = null;
        p.inactiveFrom = '';
        p.inactiveTo = '';
        p.resignationDate = newResignationDate;
      } else if(newStatus !== 'Activ'){
        p.zoneId = null;
        p.inactiveFrom = newInactiveFrom;
        p.inactiveTo = newInactiveTo;
        p.resignationDate = '';
      } else {
        p.zoneId = newZone || p.zoneId || null;
        p.inactiveFrom = '';
        p.inactiveTo = '';
        p.resignationDate = '';
      }

      if(!roles.includes(newRole)) roles.push(newRole);
      render(); markDirty();
    });

    // ======= Adăugare / Ștergere / Rol =======
    document.getElementById('addZone').addEventListener('click',()=>{
      const maxIdx = Math.max(-1, ...zones.map(z=>z.gridIndex));
      const z = { id: 'z'+Math.random().toString(36).slice(2,7), name: 'Front de lucru', gridIndex: isFinite(maxIdx)?maxIdx+1:0, startDate:'', endDate:'' };
      zones.push(z); select({type:'zone', id:z.id}); render(); markDirty();
    });
    document.getElementById('addPerson').addEventListener('click',()=>{
      const defaultRole = roles[0] || 'Rol';
      const p = { id: 'p'+Math.random().toString(36).slice(2,7), name: 'Persoană nouă', role: defaultRole, zoneId: null, status:'Activ', inactiveFrom:'', inactiveTo:'', resignationDate:'' };
      if(isNameDuplicatedExcluding(p.name, p.id)) p.name += ' (2)';
      people.push(p); select({type:'person', id:p.id}); render(); markDirty();
    });

    bulkAddPersonBtn?.addEventListener('click', ()=>{
      const response = prompt('Introduceți numele persoanelor separate prin virgulă (sau linie nouă):');
      if(response === null) return;
      const entries = response.split(/[\n,;]+/).map(n=>n.trim()).filter(Boolean);
      if(!entries.length) return;
      if(!roles.includes('Sudor')){
        roles.push('Sudor');
        roles = normalizeRoles(roles);
      }
      const created = [];
      entries.forEach(baseName=>{
        let candidate = baseName;
        let suffix = 2;
        while(people.some(existing=> normName(existing?.name) === normName(candidate))){
          candidate = `${baseName} (${suffix++})`;
        }
        const person = { id: 'p'+Math.random().toString(36).slice(2,7), name: candidate, role: 'Sudor', zoneId: null, status:'Activ', inactiveFrom:'', inactiveTo:'', resignationDate:'' };
        people.push(person);
        created.push(person);
      });
      if(created.length){
        selected = null;
        if(poolActive) poolActive.style.display = 'block';
        render();
        markDirty();
      }
    });

    document.getElementById('addRole').addEventListener('click',()=>{
      const roleInput = document.getElementById('newRoleInput');
      const saveRoleBtn = document.getElementById('saveRoleBtn');
      const cancelRoleBtn = document.getElementById('cancelRoleBtn');
      roleInput.style.display='inline-block';
      saveRoleBtn.style.display='inline-block';
      cancelRoleBtn.style.display='inline-block';
      roleInput.value=''; roleInput.focus();
      saveRoleBtn.onclick = ()=> addRole(roleInput.value);
      roleInput.onkeydown = (e)=>{ if(e.key==='Enter'){ e.preventDefault(); addRole(roleInput.value); } };
      cancelRoleBtn.onclick = ()=>{
        roleInput.style.display='none'; saveRoleBtn.style.display='none'; cancelRoleBtn.style.display='none'; roleInput.value='';
      };
    });
    function addRole(name){
      const rn=(name||'').trim(); if(!rn) return;
      if(!roles.includes(rn)) roles.push(rn);
      roles = normalizeRoles(roles);
      document.getElementById('newRoleInput').style.display='none';
      document.getElementById('saveRoleBtn').style.display='none';
      document.getElementById('cancelRoleBtn').style.display='none';
      renderForms(); renderStats(); renderGantt();
      const rmPanelNow = document.getElementById('roleManager');
      if(rmPanelNow?.classList.contains('open')) renderRoleManager();
      markDirty();
    }

    document.getElementById('deleteSelected').addEventListener('click',()=>{
      if(!selected) return;
      if(selected.type==='zone'){
        const zoneId = selected.id;
        const zone = zones.find(z=>z.id===zoneId);
        const assigned = people.filter(p=>p && p.zoneId === zoneId);
        let moved = false;
        if(assigned.length){
          const zoneLabel = (zone?.name && zone.name.trim()) ? zone.name.trim() : 'Zonă fără nume';
          const personWord = assigned.length === 1 ? 'persoană' : 'persoane';
          const moveChoice = confirm(`${zoneLabel} conține ${assigned.length} ${personWord}. Apasă OK pentru a le muta la oameni nealocați sau Anulează pentru a continua cu ștergerea definitivă.`);
          if(moveChoice){
            assigned.forEach(p=>{ p.zoneId = null; });
            moved = true;
          } else {
            const confirmDeletePeople = confirm('Ștergi definitiv persoanele din această zonă? Apasă Anulează pentru a renunța la ștergerea zonei.');
            if(!confirmDeletePeople){
              return;
            }
            people = people.filter(p=> p && p.zoneId !== zoneId);
          }
        }
        zones = zones.filter(z=>z.id!==zoneId);
        if(moved && poolActive) poolActive.style.display = 'block';
      } else {
        people = people.filter(p=>p && p.id!==selected.id);
      }
      selected=null; render(); markDirty();
    });

    // ======= Statistici =======
    function roleCounts(){
      const counts = {};
      people.filter(p=>p && !isResigned(p)).forEach(p=>{
        const r = p.role || '—';
        counts[r] = (counts[r] || 0) + 1;
      });
      return counts;
    }
    function renderStats(){
      const counts=roleCounts();
      const ul=document.getElementById('statsRoles'); ul.innerHTML='';
      const displayRoles=uniqueRoles([...(roles||[]),...Object.keys(counts)]);
      displayRoles.forEach(roleName=>{
        const li=document.createElement('li'); const left=document.createElement('span'); left.textContent=roleName; const right=document.createElement('strong'); right.textContent=counts[roleName]||0; li.appendChild(left); li.appendChild(right); ul.appendChild(li);
      });
      // Directi = activi + excluzând TESA/Magazioner/Șef Echipa și DOAR cei din zone
      document.getElementById('totalFaraTesa').textContent = people.filter(p=>isDirect(p) && isActive(p) && p.zoneId).length;
    }

    function updateLandingClock(){
      if(!dashboardDateLabel) return;
      const now = new Date();
      let formatted;
      try {
        formatted = now.toLocaleString('ro-RO', { dateStyle:'long', timeStyle:'medium' });
      } catch(err){
        formatted = now.toLocaleString('ro-RO');
      }
      dashboardDateLabel.textContent = formatted;
    }

    function startLandingClock(){
      updateLandingClock();
      if(landingClockInterval){
        clearInterval(landingClockInterval);
      }
      landingClockInterval = setInterval(updateLandingClock, 1000);
    }

    function stopStatsAnimation(resetPending = true){
      if(statsAnimationInterval){
        clearInterval(statsAnimationInterval);
        statsAnimationInterval = null;
      }
      stopDashboardTicker();
      statsAnimating = false;
      if(resetPending){
        pendingStatsAnimation = false;
      }
      document.body.classList.remove('dashboard-animating');
      if(dashboardCardsEl){
        dashboardCardsEl.querySelectorAll('.dashboardCard').forEach(card=> card.classList.remove('dashboardCard--spotlight'));
      }
    }

    function stopDashboardTicker(resetText = true){
      if(dashboardTickerInterval){
        clearInterval(dashboardTickerInterval);
        dashboardTickerInterval = null;
      }
      if(!dashboardTickerNowEl) return;
      dashboardTickerNowEl.classList.remove('show');
      if(resetText){
        if(dashboardTickerData.length){
          dashboardTickerNowEl.textContent = dashboardTickerData[0];
        } else {
          const fallback = dashboardTickerEmptyEl?.textContent || 'Nu există taskuri active.';
          dashboardTickerNowEl.textContent = fallback;
        }
      }
    }

    function stopDashboardAnimationCycle(options = {}){
      const { resetPending = true } = options;
      dashboardCurrentPhase = 'idle';
      document.body.classList.remove(DASHBOARD_TASKS_CLASS);
      stopStatsAnimation(resetPending);
    }

    function startDashboardCardPhase(){
      if(!(document.body.classList.contains('landing-mode') || activeView === 'dashboard')){
        dashboardCurrentPhase = 'idle';
        return;
      }
      dashboardCurrentPhase = 'cards';
      document.body.classList.remove(DASHBOARD_TASKS_CLASS);
      beginStatsAnimation();
    }

    function startDashboardAnimationCycle(){
      pendingStatsAnimation = false;
      startDashboardCardPhase();
    }

    function startDashboardTicker(){
      if(!dashboardTickerNowEl) return;
      stopDashboardTicker(false);
      if(!dashboardTickerData.length){
        const fallback = dashboardTickerEmptyEl?.textContent || 'Nu există taskuri active.';
        dashboardTickerNowEl.textContent = fallback;
        void dashboardTickerNowEl.offsetWidth;
        dashboardTickerNowEl.classList.add('show');
        return;
      }
      dashboardTickerIndex = 0;
      const showItem = ()=>{
        if(!dashboardTickerNowEl) return;
        if(!dashboardTickerData.length){
          stopDashboardTicker();
          return;
        }
        const text = dashboardTickerData[dashboardTickerIndex % dashboardTickerData.length];
        dashboardTickerNowEl.classList.remove('show');
        void dashboardTickerNowEl.offsetWidth;
        dashboardTickerNowEl.textContent = text;
        dashboardTickerNowEl.classList.add('show');
        dashboardTickerIndex = (dashboardTickerIndex + 1) % dashboardTickerData.length;
      };
      showItem();
      dashboardTickerInterval = setInterval(showItem, 5000);
    }

    function beginStatsAnimation(){
      if(!dashboardCardsEl) return;
      const cards = Array.from(dashboardCardsEl.querySelectorAll('.dashboardCard'));
      if(!cards.length) return;
      stopStatsAnimation(false);
      pendingStatsAnimation = false;
      statsAnimating = true;
      statsAnimationIndex = 0;
      document.body.classList.add('dashboard-animating');
      const cycle = ()=>{
        if(!statsAnimating || !dashboardCardsEl) return;
        const currentCards = Array.from(dashboardCardsEl.querySelectorAll('.dashboardCard'));
        if(!currentCards.length){
          stopStatsAnimation();
          return;
        }
        const index = statsAnimationIndex % currentCards.length;
        currentCards.forEach((card, idx)=>{
          card.classList.toggle('dashboardCard--spotlight', idx === index);
        });
        statsAnimationIndex = (statsAnimationIndex + 1) % currentCards.length;
      };
      cycle();
      startDashboardTicker();
      const cycleInterval = Math.max(2000, ensurePositiveMs(inactivityAnimationDelay, DEFAULT_ANIMATION_DELAY));
      statsAnimationInterval = setInterval(cycle, cycleInterval);
    }

    function triggerStatsAnimation(){
      if(!(document.body.classList.contains('landing-mode') || activeView === 'dashboard')){
        pendingStatsAnimation = true;
        return;
      }
      if(dashboardDetailFullscreen){
        pendingStatsAnimation = true;
        return;
      }
      if(dashboardCurrentPhase !== 'idle'){
        return;
      }
      startDashboardAnimationCycle();
    }

    function clearInactivityTimers(){
      if(inactivityAnimationTimeout){
        clearTimeout(inactivityAnimationTimeout);
        inactivityAnimationTimeout = null;
      }
      if(inactivityReturnTimeout){
        clearTimeout(inactivityReturnTimeout);
        inactivityReturnTimeout = null;
      }
    }

    function scheduleInactivityMonitors(){
      clearInactivityTimers();
      fullscreenPending = false;
      const isLanding = activeView === 'dashboard' || document.body.classList.contains('landing-mode');
      const animationDelay = ensurePositiveMs(inactivityAnimationDelay, DEFAULT_ANIMATION_DELAY);
      inactivityAnimationTimeout = setTimeout(()=>{
        triggerStatsAnimation();
      }, animationDelay);
      if(isLanding) return;
      if(!ANIMATION_TABS.has(activeView)) return;
      const dashboardDelay = ensurePositiveMs(inactivityDashboardDelay, DEFAULT_DASHBOARD_DELAY);
      inactivityReturnTimeout = setTimeout(()=>{
        if(document.body.classList.contains('landing-mode')) return;
        pendingStatsAnimation = false;
        showLanding();
        try {
          if(window.location.hash !== '#dashboard'){
            history.replaceState(null, '', '#dashboard');
          }
        } catch(err){
          // ignorăm erorile istoricului
        }
        fullscreenPending = true;
        requestAnimationFrame(()=> enterFullscreenForDashboard());
      }, dashboardDelay);
    }

    function enterFullscreenForDashboard(){
      if(!fullscreenPending) return;
      fullscreenPending = false;
      const root = document.documentElement;
      if(!root || !root.requestFullscreen){
        autoFullscreenActive = false;
        document.body.classList.remove('landing-fullscreen');
        return;
      }
      root.requestFullscreen().then(()=>{
        autoFullscreenActive = true;
        document.body.classList.add('landing-fullscreen');
      }).catch(()=>{
        autoFullscreenActive = false;
        document.body.classList.remove('landing-fullscreen');
      });
    }

    function exitAutoFullscreen(){
      if(document.exitFullscreen && document.fullscreenElement){
        document.exitFullscreen().catch(()=>{});
      }
      autoFullscreenActive = false;
      fullscreenPending = false;
      document.body.classList.remove('landing-fullscreen');
    }

    function handlePassiveActivity(){
      stopDashboardAnimationCycle();
      fullscreenPending = false;
      scheduleInactivityMonitors();
    }

    function handleUserClick(){
      stopDashboardAnimationCycle();
      pendingStatsAnimation = false;
      fullscreenPending = false;
      if(autoFullscreenActive){
        exitAutoFullscreen();
      }
      scheduleInactivityMonitors();
    }

    function renderDashboard(){
      if(!dashboardCardsEl || !dashboardDetailsEl) return;

      updateLandingClock();

      const safePeople = Array.isArray(people) ? people.filter(Boolean) : [];
      const safeZones = Array.isArray(zones) ? zones.filter(Boolean) : [];
      const safeTasks = Array.isArray(tasks) ? tasks.filter(Boolean) : [];
      const safeArchive = Array.isArray(tasksArchive) ? tasksArchive.filter(Boolean) : [];
      const safeReports = Array.isArray(savedReports) ? savedReports.filter(Boolean) : [];

      const peopleForStats = safePeople.filter(person => !isResigned(person));
      const activePeople = peopleForStats.filter(person => !person.status || person.status === 'Activ');
      const inactivePeople = peopleForStats.filter(person => person.status && person.status !== 'Activ');
      const coPeople = peopleForStats.filter(isInactiveCO);
      const cmPeople = peopleForStats.filter(isInactiveCM);

      const directiActiveInZones = peopleForStats.filter(person => isActive(person) && person.zoneId && isDirect(person)).length;
      const supportActiveInZones = peopleForStats.filter(person => isActive(person) && person.zoneId && EXCLUDED_ROLES.has(roleKey(person.role))).length;
      const totalPeopleToday = directiActiveInZones + supportActiveInZones;

      const openTasks = safeTasks.filter(task => !task.done);
      const closedTasksCount = safeTasks.filter(task => task.done).length + safeArchive.length;

      const fronturiDenumite = safeZones.filter(zone => (zone?.name || '').trim()).length;
      const totalFronturi = safeZones.length;
      const fronturiActiveCount = safeZones.reduce((count, zone)=>{
        const zoneId = zone?.id;
        if(!zoneId) return count;
        const hasActive = peopleForStats.some(person => isActive(person) && person.zoneId === zoneId);
        return hasActive ? count + 1 : count;
      }, 0);

      const formatNamesHint = (list) => {
        if(!Array.isArray(list) || !list.length) return '';
        const names = list.map(person => getDisplayName(person) || '—').filter(Boolean);
        if(!names.length) return '';
        const max = 3;
        const trimmed = names.slice(0, max);
        return names.length > max ? `${trimmed.join(', ')} …` : trimmed.join(', ');
      };

      dashboardCardsEl.innerHTML = '';
      const cardData = [
        {
          key:'today',
          title:'Total oameni astăzi',
          value: totalPeopleToday,
          hint: totalPeopleToday ? 'Din fronturi de lucru active (Directi + TESA/Magazioner/Șef echipă)' : 'Nu există persoane active în fronturi',
          variant:'today',
          breakdown:[
            { label:'Directi', value: directiActiveInZones },
            { label:'TESA', value: supportActiveInZones }
          ]
        },
        {
          key:'all',
          title:'Total oameni',
          value: peopleForStats.length,
          hint:`Activi: ${activePeople.length} • Inactivi: ${inactivePeople.length}`
        },
        {
          key:'tasks',
          title:'Taskuri deschise',
          value: openTasks.length,
          hint:`Închise: ${closedTasksCount}`
        },
        {
          key:'fronturi',
          title:'Fronturi de lucru active',
          value: fronturiActiveCount,
          hint: totalFronturi ? `Fronturi denumite: ${fronturiDenumite} din ${totalFronturi}` : 'Niciun front configurat'
        },
        {
          key:'co',
          title:'Inactivi CO',
          value: coPeople.length,
          hint: coPeople.length ? formatNamesHint(coPeople) : 'Nicio persoană în CO'
        },
        {
          key:'cm',
          title:'Inactivi CM',
          value: cmPeople.length,
          hint: cmPeople.length ? formatNamesHint(cmPeople) : 'Nicio persoană în CM'
        }
      ];

      const cardElements = new Map();
      const detailContext = {
        people: safePeople,
        peopleForStats,
        zones: safeZones,
        openTasks,
        coPeople,
        cmPeople,
        savedReports: safeReports,
        totalPeopleToday,
        directiActiveInZones,
        supportActiveInZones
      };

      cardData.forEach(data => {
        const card = document.createElement('div');
        card.className = 'dashboardCard';
        if(data.variant){
          card.classList.add(`dashboardCard--${data.variant}`);
        }
        card.dataset.detailKey = data.key;
        card.setAttribute('role', 'button');
        card.setAttribute('tabindex', '0');

        const title = document.createElement('div');
        title.className = 'dashboardCardTitle';
        title.textContent = data.title;
        card.appendChild(title);

        const value = document.createElement('div');
        value.className = 'dashboardCardValue';
        value.textContent = String(data.value);
        card.appendChild(value);

        if(Array.isArray(data.breakdown) && data.breakdown.length){
          const breakdown = document.createElement('div');
          breakdown.className = 'dashboardCardBreakdown';
          data.breakdown.forEach(item => {
            const row = document.createElement('div');
            row.className = 'dashboardCardBreakdownRow';
            const label = document.createElement('span');
            label.className = 'label';
            label.textContent = item.label;
            const val = document.createElement('span');
            val.className = 'value';
            val.textContent = String(item.value);
            row.appendChild(label);
            row.appendChild(val);
            breakdown.appendChild(row);
          });
          card.appendChild(breakdown);
        }

        if(data.hint){
          const hint = document.createElement('div');
          hint.className = 'dashboardCardHint';
          hint.textContent = data.hint;
          card.appendChild(hint);
        }

        card.addEventListener('click', ()=> setDashboardDetail(data.key, detailContext, { fullscreen: true }));
        card.addEventListener('keydown', (event)=>{
          if(event.key === 'Enter' || event.key === ' '){
            event.preventDefault();
            setDashboardDetail(data.key, detailContext, { fullscreen: true });
          }
        });

        dashboardCardsEl.appendChild(card);
        cardElements.set(data.key, card);
      });

      dashboardCardElements = cardElements;

      const formatTaskTickerLine = (task) => {
        if(!task) return '';
        const name = (task.name || '').trim() || 'Task fără nume';
        const comment = (task.comment || '').trim();
        const created = task.createdAt ? niceDate(task.createdAt) : '';
        const parts = [name];
        if(comment) parts.push(comment);
        if(created && created !== '—') parts.push(created);
        return parts.join(' • ');
      };

      const tickerLines = openTasks.map(formatTaskTickerLine).filter(Boolean);
      dashboardTickerData = tickerLines;
      if(dashboardTickerListEl){
        dashboardTickerListEl.innerHTML = '';
        if(tickerLines.length){
          tickerLines.forEach(text => {
            const li = document.createElement('li');
            li.className = 'dashboardTickerItem';
            li.textContent = text;
            dashboardTickerListEl.appendChild(li);
          });
        }
      }
      if(dashboardTickerEmptyEl){
        dashboardTickerEmptyEl.style.removeProperty('display');
        dashboardTickerEmptyEl.toggleAttribute('hidden', !!tickerLines.length);
      }
      if(dashboardTickerNowEl){
        const fallbackTicker = dashboardTickerEmptyEl?.textContent || 'Nu există taskuri active.';
        dashboardTickerNowEl.textContent = tickerLines.length ? tickerLines[0] : fallbackTicker;
        if(!statsAnimating){
          dashboardTickerNowEl.classList.remove('show');
        }
      }

      dashboardDetailContext = detailContext;
      updateDashboardCardSelection();
      updateDashboardDetailContent();
    }

    function createDetailEmpty(text){
      const div = document.createElement('div');
      div.className = 'dashboardDetailsEmpty';
      div.textContent = text || '';
      return div;
    }

    function createDetailRow(labelText, valueText, meta, options = {}){
      const row = document.createElement('div');
      row.className = 'dashboardDetailsRow';
      if(options.stacked) row.classList.add('stacked');

      const label = document.createElement('div');
      label.className = 'label';
      label.textContent = labelText || '—';
      row.appendChild(label);

      const value = document.createElement('div');
      value.className = 'value';
      if(valueText){
        const main = document.createElement('div');
        main.textContent = valueText;
        value.appendChild(main);
      }
      if(meta){
        const metaItems = Array.isArray(meta) ? meta : [meta];
        const items = metaItems.filter(Boolean);
        if(items.length){
          const metaEl = document.createElement('div');
          metaEl.className = 'meta';
          items.forEach(text => {
            const line = document.createElement('div');
            line.textContent = text;
            metaEl.appendChild(line);
          });
          value.appendChild(metaEl);
        }
      }
      if(!value.childNodes.length){
        const empty = document.createElement('div');
        empty.textContent = '';
        value.appendChild(empty);
      }
      row.appendChild(value);
      return row;
    }

    function describePersonStatus(person){
      if(!person || !person.status || person.status === 'Activ') return 'Activ';
      if(person.status === 'Demisie'){
        if(person.resignationDate){
          return `Demisie (${niceDate(person.resignationDate)})`;
        }
        return 'Demisie';
      }
      return formatInactiveLabel(person);
    }

    const DASHBOARD_DETAIL_BUILDERS = {
      today(context){
        const details = context.zones
          .map(zone => {
            if(!zone || !zone.id) return null;
            const assigned = context.peopleForStats.filter(person => isActive(person) && person.zoneId === zone.id);
            if(!assigned.length) return null;
            const direct = assigned.filter(isDirect).length;
            const support = assigned.length - direct;
            return {
              name: (zone.name || '').trim() || zone.id,
              total: assigned.length,
              direct,
              support
            };
          })
          .filter(Boolean)
          .sort((a,b)=> b.total - a.total || a.name.localeCompare(b.name,'ro-RO'));
        const section = document.createElement('div');
        section.className = 'dashboardDetailsSection';
        if(!details.length){
          section.appendChild(createDetailEmpty('Nu există persoane active în fronturile de lucru.'));
        } else {
          details.forEach(detail => {
            const meta = [`Directi: ${detail.direct}`, `TESA/Magazioner/Șef echipă: ${detail.support}`];
            section.appendChild(createDetailRow(detail.name, `${detail.total} ${detail.total === 1 ? 'om' : 'oameni'}`, meta));
          });
        }
        return { title: 'Distribuție pe fronturi', body: section };
      },
      all(context){
        const section = document.createElement('div');
        section.className = 'dashboardDetailsSection';
        const zoneMap = new Map((context.zones || []).map(zone => [zone?.id, zone]));
        const sorted = [...(context.people || [])].sort(compareByName);
        if(!sorted.length){
          section.appendChild(createDetailEmpty('Nu există persoane înregistrate.'));
        } else {
          sorted.forEach(person => {
            const name = getDisplayName(person) || '(fără nume)';
            const status = describePersonStatus(person);
            const meta = [];
            if(person.zoneId){
              const zoneName = zoneMap.get(person.zoneId)?.name || '';
              if(zoneName) meta.push(`Front: ${zoneName}`);
            }
            if(person.status === 'Demisie'){
              meta.push('Nu este inclus în statistici');
            }
            section.appendChild(createDetailRow(name, status, meta));
          });
        }
        return { title: 'Situație persoane', body: section };
      },
      tasks(context){
        const section = document.createElement('div');
        section.className = 'dashboardDetailsSection';
        const tasks = Array.isArray(context.openTasks) ? context.openTasks : [];
        if(!tasks.length){
          section.appendChild(createDetailEmpty('Nu există taskuri deschise.'));
        } else {
          tasks.forEach(task => {
            const name = (task.name || '').trim() || 'Task fără nume';
            const meta = [];
            if(task.comment){
              meta.push(task.comment);
            }
            if(task.createdAt){
              const created = niceDate(task.createdAt);
              if(created && created !== '—'){
                meta.push(`Creat: ${created}`);
              }
            }
            section.appendChild(createDetailRow(name, '', meta, { stacked: true }));
          });
        }
        return { title: 'Taskuri deschise', body: section };
      },
      fronturi(context){
        const section = document.createElement('div');
        section.className = 'dashboardDetailsSection';
        const names = (context.zones || [])
          .filter(zone => zone && zone.id && context.peopleForStats.some(person => isActive(person) && person.zoneId === zone.id))
          .map(zone => (zone.name || '').trim() || zone.id)
          .sort((a,b)=> a.localeCompare(b,'ro-RO'));
        if(!names.length){
          section.appendChild(createDetailEmpty('Nu există fronturi active.'));
        } else {
          names.forEach(name => {
            section.appendChild(createDetailRow(name, '', null, { stacked: true }));
          });
        }
        return { title: 'Fronturi de lucru active', body: section };
      },
      co(context){
        const section = document.createElement('div');
        section.className = 'dashboardDetailsSection';
        const sorted = [...(context.coPeople || [])].sort(compareByName);
        if(!sorted.length){
          section.appendChild(createDetailEmpty('Nu există persoane în concediu de odihnă.'));
        } else {
          sorted.forEach(person => {
            section.appendChild(createDetailRow(getDisplayName(person) || '(fără nume)', formatInactiveLabel(person)));
          });
        }
        return { title: 'Persoane în concediu de odihnă', body: section };
      },
      cm(context){
        const section = document.createElement('div');
        section.className = 'dashboardDetailsSection';
        const sorted = [...(context.cmPeople || [])].sort(compareByName);
        if(!sorted.length){
          section.appendChild(createDetailEmpty('Nu există persoane în concediu medical.'));
        } else {
          sorted.forEach(person => {
            section.appendChild(createDetailRow(getDisplayName(person) || '(fără nume)', formatInactiveLabel(person)));
          });
        }
        return { title: 'Persoane în concediu medical', body: section };
      }
    };

    function updateDashboardCardSelection(){
      dashboardCardElements.forEach((el, key)=>{
        const isActive = key === dashboardDetailKey;
        el.classList.toggle('is-active', isActive);
        el.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
    }

    function updateDashboardDetailContent(){
      if(!dashboardDetailsEl || !dashboardDetailsTitleEl || !dashboardDetailsBodyEl || !dashboardDetailsPlaceholderEl){
        return;
      }
      const builder = dashboardDetailKey && DASHBOARD_DETAIL_BUILDERS[dashboardDetailKey];
      if(!builder || !dashboardDetailContext){
        if(dashboardDetailFullscreen){
          dashboardDetailFullscreen = false;
          document.body.classList.remove(DASHBOARD_DETAIL_FULL_CLASS);
          if(dashboardBackButton){
            dashboardBackButton.hidden = true;
            dashboardBackButton.setAttribute('aria-hidden', 'true');
          }
        }
        dashboardDetailKey = null;
        dashboardDetailsTitleEl.textContent = 'Detalii statistici';
        dashboardDetailsPlaceholderEl.removeAttribute('hidden');
        dashboardDetailsPlaceholderEl.style.display = '';
        dashboardDetailsBodyEl.innerHTML = '';
        dashboardDetailsBodyEl.setAttribute('hidden', '');
        updateDashboardCardSelection();
        return;
      }
      dashboardDetailsPlaceholderEl.setAttribute('hidden', '');
      dashboardDetailsPlaceholderEl.style.display = 'none';
      dashboardDetailsBodyEl.removeAttribute('hidden');
      const result = builder(dashboardDetailContext) || {};
      dashboardDetailsTitleEl.textContent = result.title || 'Detalii statistici';
      dashboardDetailsBodyEl.innerHTML = '';
      if(result.body instanceof Node){
        dashboardDetailsBodyEl.appendChild(result.body);
      } else if(Array.isArray(result.body)){
        result.body.forEach(item => {
          if(item instanceof Node){
            dashboardDetailsBodyEl.appendChild(item);
          } else if(typeof item === 'string'){
            dashboardDetailsBodyEl.appendChild(createDetailEmpty(item));
          }
        });
      } else if(typeof result.body === 'string'){
        dashboardDetailsBodyEl.appendChild(createDetailEmpty(result.body));
      } else {
        dashboardDetailsBodyEl.appendChild(createDetailEmpty('Nu există informații de afișat.'));
      }
      updateDashboardCardSelection();
    }

    function setDashboardDetail(key, context, options = {}){
      stopDashboardAnimationCycle();
      dashboardDetailKey = key || null;
      if(context) dashboardDetailContext = context;
      updateDashboardDetailContent();
      if(options.fullscreen && dashboardDetailKey){
        enterDashboardDetailFullscreen();
      }
    }

    function enterDashboardDetailFullscreen(){
      document.body.classList.remove(DASHBOARD_TASKS_CLASS);
      if(dashboardDetailFullscreen) return;
      dashboardDetailFullscreen = true;
      document.body.classList.add(DASHBOARD_DETAIL_FULL_CLASS);
      if(dashboardBackButton){
        dashboardBackButton.hidden = false;
        dashboardBackButton.setAttribute('aria-hidden', 'false');
      }
      requestAnimationFrame(()=>{
        window.scrollTo(0, 0);
        if(dashboardBackButton){
          try { dashboardBackButton.focus(); } catch(err){}
        }
      });
    }

    function exitDashboardDetailFullscreen(){
      if(!dashboardDetailFullscreen) return;
      dashboardDetailFullscreen = false;
      document.body.classList.remove(DASHBOARD_DETAIL_FULL_CLASS);
      if(dashboardBackButton){
        dashboardBackButton.hidden = true;
        dashboardBackButton.setAttribute('aria-hidden', 'true');
      }
      dashboardDetailKey = null;
      updateDashboardDetailContent();
      if(pendingStatsAnimation && (document.body.classList.contains('landing-mode') || activeView === 'dashboard')){
        startDashboardAnimationCycle();
      }
      window.scrollTo(0, 0);
    }

    // ======= Gestionare roluri =======
    function renderRoleManager(){
      const wrap = document.getElementById('roleList'); if(!wrap) return; wrap.innerHTML='';
      roles = uniqueRoles(roles);
      roles.forEach(r=>{
        const chip = document.createElement('div'); chip.style.display='inline-flex'; chip.style.alignItems='center'; chip.style.gap='6px'; chip.style.border='1px solid var(--line)'; chip.style.borderRadius='999px'; chip.style.padding='4px 8px'; chip.style.background='#fff';
        const name = document.createElement('span'); name.textContent=r; name.style.fontSize='12px';
        const editBtn = document.createElement('button'); editBtn.type='button'; editBtn.className='ghost'; editBtn.textContent='✏️'; editBtn.title='Editează rol';
        const delBtn = document.createElement('button'); delBtn.type='button'; delBtn.className='ghost'; delBtn.textContent='🗑️'; delBtn.title='Șterge rol';
        editBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); startEditRole(r, chip, name); });
        delBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); deleteRole(r); });
        chip.appendChild(name); chip.appendChild(editBtn); chip.appendChild(delBtn);
        wrap.appendChild(chip);
      });
    }
    function startEditRole(oldName, chipEl){
      const input = document.createElement('input'); input.value=oldName; input.style.padding='4px 6px'; input.style.border='1px solid var(--line)'; input.style.borderRadius='8px'; input.size=Math.max(6, oldName.length); input.style.flex='1'; input.style.minWidth='80px'; input.style.marginRight='6px'; input.style.width=Math.max(80, oldName.length * 9)+'px';
      const save = document.createElement('button'); save.type='button'; save.className='primary'; save.textContent='Salvează';
      chipEl.innerHTML=''; chipEl.appendChild(input); chipEl.appendChild(save);
      input.addEventListener('click', (ev)=> ev.stopPropagation());
      chipEl.addEventListener('click', (ev)=> ev.stopPropagation());
      save.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        const newName=(input.value||'').trim(); if(!newName) return;
        if(newName===oldName){
          render();
          return;
        }
        const carryColor = roleColors.get(oldName);
        roles = uniqueRoles(roles.map(r=> r===oldName? newName : r));
        people.forEach(p=>{ if(p && p.role===oldName) p.role=newName; });
        if(carryColor && !roleColors.has(newName)){
          roleColors.set(newName, carryColor);
        }
        roleColors.delete(oldName);
        render();
        markDirty();
      });
      input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); save.click(); } });
      input.focus();
    }
    function deleteRole(roleName){
      if(!confirm(`Ștergi rolul "${roleName}"? Persoanele care îl au vor deveni fără rol.`)) return;
      roles = roles.filter(r=>r!==roleName);
      people.forEach(p=>{ if(p && p.role===roleName) p.role='—'; });
      roleColors.delete(roleName);
      render();
      markDirty();
    }

    // ======= Gantt =======
    function toDate(iso){ if(!iso) return null; const d=new Date(iso+'T00:00:00'); return isNaN(d.getTime())?null:d; }
    let selectedZoneIds = null;
    function renderZoneChips(){
      if(!zoneChipsWrap) return;
      zoneChipsWrap.innerHTML = '';
      const zSorted = zones.filter(z=>z && (z.name||'').trim()).sort((a,b)=>a.gridIndex-b.gridIndex);
      if(selectedZoneIds===null){ selectedZoneIds = new Set(zSorted.map(z=>z.id)); }
      zSorted.forEach(z=>{
        const chip = document.createElement('button');
        chip.type='button'; chip.className='ghost'; chip.style.border='1px solid var(--line)'; chip.style.borderRadius='999px'; chip.style.padding='6px 10px';
        const active = selectedZoneIds.has(z.id);
        chip.style.background = active ? '#eef2ff' : '#fff';
        chip.textContent = z.name || z.id;
        chip.addEventListener('click', ()=>{ if(selectedZoneIds.has(z.id)){ selectedZoneIds.delete(z.id); } else { selectedZoneIds.add(z.id); } renderZoneChips(); renderGantt(); });
        zoneChipsWrap.appendChild(chip);
      });
    }
    zonesSelectAllBtn?.addEventListener('click', ()=>{ selectedZoneIds = new Set(zones.filter(z=>z && (z.name||'').trim()).map(z=>z.id)); renderZoneChips(); renderGantt(); });

    function computeTimeline(){
      const valid = zones.filter(z=>z && (z.startDate||z.endDate));
      let min = toDate(workDate.value)||new Date();
      let max = new Date(min.getTime()+7*24*3600*1000);
      valid.forEach(z=>{ const s = toDate(z.startDate); const e = toDate(z.endDate); if(s && s < min) min = s; if(e && e > max) max = e; });
      if(max<=min) max = new Date(min.getTime()+24*3600*1000);
      return {min,max};
    }

    function renderGantt(){
      const {min,max} = computeTimeline();
      const container = document.querySelector('#tab-chart .chartWrap');
      const zonesAll = zones.filter(z=>z && (z.name||'').trim());
      const zonesToShow = zonesAll.filter(z=> !selectedZoneIds || selectedZoneIds.has(z.id));
      const dailyTotals = computeDailyTotals(min, max, zonesToShow);

      const width = Math.max(560, container.clientWidth - 28);
      const totalsRowH = 26;
      const height = Math.max(260, Math.min(120 + zonesToShow.length*40 + totalsRowH, window.innerHeight - 160));
      ganttChart.setAttribute('viewBox', `0 0 ${width} ${height}`);
      ganttChart.innerHTML='';
      const W=width, padL=120, padR=10, padT=50, rowH=28, gap=10;
      const innerW=W-padL-padR;
      const msRange = (max - min) || 1;
      const xForDate = d => padL + innerW * ((d - min)/msRange);

      const axisTop = document.createElementNS('http://www.w3.org/2000/svg','line');
      axisTop.setAttribute('x1', padL); axisTop.setAttribute('y1', padT-20); axisTop.setAttribute('x2', W-padR); axisTop.setAttribute('y2', padT-20); axisTop.setAttribute('stroke', '#9ca3af'); ganttChart.appendChild(axisTop);
      const dayMs = 24*3600*1000; const days = Math.max(1, Math.round(msRange/dayMs));
      const tickEvery = Math.ceil(days / 14);
      for(let i=0;i<=days;i+=tickEvery){
        const d = new Date(min.getTime() + i*dayMs);
        const x = xForDate(d);
        const tick = document.createElementNS('http://www.w3.org/2000/svg','line');
        tick.setAttribute('x1', x); tick.setAttribute('y1', padT-24); tick.setAttribute('x2', x); tick.setAttribute('y2', height-padT); tick.setAttribute('stroke', '#e5e7eb'); ganttChart.appendChild(tick);
        const lbl = document.createElementNS('http://www.w3.org/2000/svg','text'); lbl.setAttribute('x', x+2); lbl.setAttribute('y', padT-26); lbl.setAttribute('fill', '#6b7280'); lbl.setAttribute('font-size', '10'); lbl.textContent = `${d.getDate()}/${d.getMonth()+1}`; ganttChart.appendChild(lbl);
      }

      zonesToShow.forEach((z, idx)=>{
        const y = padT + idx * (rowH + gap);
        const s = toDate(z.startDate) || min;
        const e = toDate(z.endDate) || s;
        const x1 = xForDate(s);
        const x2 = xForDate(e);
        const bar = document.createElementNS('http://www.w3.org/2000/svg','rect');
        bar.setAttribute('x', x1); bar.setAttribute('y', y); bar.setAttribute('width', Math.max(2, x2-x1)); bar.setAttribute('height', rowH);
        bar.setAttribute('fill', '#bfdbfe'); bar.setAttribute('stroke', '#60a5fa'); ganttChart.appendChild(bar);
        const text = document.createElementNS('http://www.w3.org/2000/svg','text');
        text.setAttribute('x', x1+4); text.setAttribute('y', y+rowH/2+4); text.setAttribute('fill', '#0f172a'); text.setAttribute('font-size', '12');
        const count = people.filter(p=>p.zoneId===z.id && isDirect(p) && isActive(p)).length;
        text.textContent = count>0? String(count) : '';
        ganttChart.appendChild(text);
      });

      // Totals row
      const totalsY = padT + zonesToShow.length * (rowH + gap);
      const totalsLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
      totalsLabel.setAttribute('x', 10); totalsLabel.setAttribute('y', totalsY + 14); totalsLabel.setAttribute('font-size','12'); totalsLabel.textContent = 'Total Directi'; ganttChart.appendChild(totalsLabel);
      dailyTotals.forEach((d, idx)=>{
        const x = xForDate(d.date);
        const bar = document.createElementNS('http://www.w3.org/2000/svg','rect');
        const nextX = idx<dailyTotals.length-1 ? xForDate(dailyTotals[idx+1].date) : xForDate(new Date(d.date.getTime()+dayMs));
        bar.setAttribute('x', x); bar.setAttribute('y', totalsY); bar.setAttribute('width', Math.max(2, nextX-x)); bar.setAttribute('height', totalsRowH);
        bar.setAttribute('fill', '#e0f2fe'); bar.setAttribute('stroke', '#38bdf8'); ganttChart.appendChild(bar);
        const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
        txt.setAttribute('x', x+4); txt.setAttribute('y', totalsY + totalsRowH/2 + 4); txt.setAttribute('font-size','12'); txt.textContent = d.count>0? String(d.count) : ''; ganttChart.appendChild(txt);
      });
    }

    function computeDailyTotals(min, max, zonesSubset){
      const results = [];
      const dayMs = 24*3600*1000;
      for(let t=min.getTime(); t<=max.getTime(); t+=dayMs){
        const d = new Date(t);
        const total = zonesSubset.reduce((acc,z)=>{
          const s = toDate(z.startDate)||min; const e = toDate(z.endDate)||s;
          const active = d.getTime()>=s.getTime() && d.getTime()<=e.getTime();
          if(!active) return acc;
          const c = people.filter(p=> p && p.zoneId===z.id && isDirect(p) && isActive(p)).length;
          return acc + c;
        },0);
        results.push({date:d, count: total});
      }
      return results;
    }

    // ======= Import / Export JSON + PDF =======
    function saveJsonToFile(){
      const payload = getStateSnapshot();
      const blob=new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
      const baseName = 'santier-fronturi.json';
      const folderSlug = formatFolderForFile(databaseFolder);
      const fileName = folderSlug ? `${folderSlug}-${baseName}` : baseName;
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fileName; a.click(); URL.revokeObjectURL(a.href);
      dirty = false; if(unsavedBanner) unsavedBanner.style.display='none';
    }
    document.getElementById('exportBtn').addEventListener('click', saveJsonToFile);
    saveBtn?.addEventListener('click', saveJsonToFile);
    setInterval(()=>{ if(dirty) saveJsonToFile(); }, 60*60*1000);
    document.getElementById('importBtn').addEventListener('click',()=>document.getElementById('importFile').click());
    document.getElementById('importFile').addEventListener('change', (e)=>{
      const file=e.target.files[0]; if(!file) return; const reader=new FileReader();
      reader.onload=()=>{
        try{
          const data=JSON.parse(reader.result);
          if(Array.isArray(data.zones) && Array.isArray(data.people)){
            zones=data.zones; people=data.people; selected=null; if(data.roles) roles=normalizeRoles(data.roles);
            tasks = Array.isArray(data.tasks)? data.tasks.map(mapImportedTask) : [];
            tasksArchive = Array.isArray(data.tasksArchive)? data.tasksArchive.map(mapImportedTask) : [];
            reportEntries = Array.isArray(data.reports)? data.reports.map(mapImportedReportEntry) : [];
            normalizeReportEntriesAfterLoad();
            savedReports = Array.isArray(data.savedReports)? data.savedReports.map(mapImportedSavedReport) : [];
            if(typeof data.reportCompany === 'string'){
              reportCompany = data.reportCompany.trim();
            } else if(data.settings && typeof data.settings.reportCompany === 'string'){
              reportCompany = data.settings.reportCompany.trim();
            } else {
              reportCompany = '';
            }
            setCurrentReportEditing(null);
            if(data.reportSequence !== undefined){
              const seq = Number(data.reportSequence);
              if(Number.isFinite(seq) && seq > 0){
                reportSequence = seq;
              }
            }
            recalculateReportSequence();
            if(data.date){ workDate.value=data.date; dateLabel.textContent=niceDate(data.date);} render(); markDirty();
            if(validateDuplicates(false).size>0) showDupAlert('Fișierul importat conține nume duplicate.');
          } else alert('Fișier invalid. Aștept { zones:[], people:[] }');
        } catch(err){ alert('Nu am putut citi JSON-ul.'); }
      };
      reader.readAsText(file);
    });

    // ------- PDF -------
    document.getElementById('exportPdfBtn')?.addEventListener('click', exportPDF);
    function buildReportHTML(){
      const esc = s=> String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;');
      const dateStr = niceDate(workDate?.value || todayStr());
      const currentYear = new Date().getFullYear();

      const totalDirectiOnZonesActive = people.filter(p=> isDirect(p) && isActive(p) && p.zoneId).length;
      const totalAllActive = people.filter(p=> isActive(p) && p.zoneId).length;

      const listInactiveCO = people.filter(isInactiveCO);
      const listInactiveCM = people.filter(isInactiveCM);
      const omTxt = (n)=> n===1 ? 'om' : 'oameni';

      let zonesSectionHtml = '';
      if(pdfShowZones){
        const zonesNonEmpty = zones.filter(z=> (z.name||'').trim()).sort((a,b)=>a.gridIndex-b.gridIndex);
        const zoneSections = zonesNonEmpty.map(z=>{
          const list = people.filter(p=>p.zoneId===z.id && isActive(p));
          if(!list.length) return '';
          const count = list.length;
          const items = `<ul>${list.map(p=>{
            const roleHtml = hideRoles ? '' : ` <span class="role">${esc(p.role||'—')}</span>`;
            return `<li>${esc(getDisplayName(p))}${roleHtml}</li>`;
          }).join('')}</ul>`;
          const helmet = /tesa/i.test(z.name||'') ? '⚪⛑️' : '🔵⛑️';
          return `<section class="zone" data-helmet="${helmet}"><h3>${esc(z.name)} — ${count} ${omTxt(count)}</h3>${items}</section>`;
        }).filter(Boolean);
        zonesSectionHtml = zoneSections.length
          ? `<h2>Zone</h2><div class="grid">${zoneSections.join('')}</div>`
          : `<h2>Zone</h2><div class="muted">(nicio zonă cu personal activ)</div>`;
      }

      let roleStatsSectionHtml = '';
      if(pdfShowRoleStats){
        const roleTotalsActive = (()=>{ const m={}; people.filter(p=> isActive(p) && p.zoneId).forEach(p=>{ const r=p.role||'—'; m[r]=(m[r]||0)+1; }); return m; })();
        const roleRows = Object.keys(roleTotalsActive).sort().map(r=>`<tr><td>${esc(r)}</td><td style="text-align:right">${roleTotalsActive[r]}</td></tr>`).join('');
        const bodyHtml = roleRows || '<tr><td colspan="2" style="text-align:center;color:#6b7280;padding:10px">Fără date active</td></tr>';
        roleStatsSectionHtml = `
          <h2>Statistici pe roluri (doar activi)</h2>
          <table>
            <thead><tr><th>Rol</th><th>Total</th></tr></thead>
            <tbody>${bodyHtml}</tbody>
          </table>
        `;
      }

      let summarySectionHtml = '';
      if(pdfShowSummary){
        summarySectionHtml = `
          <h2>Sumar</h2>
          <div><strong>Total Directi:</strong> ${totalDirectiOnZonesActive}</div>
          <div><strong>Total oameni (inclusiv TESA):</strong> ${totalAllActive}</div>
        `;
      }

      let inactiveSectionHtml = '';
      if(pdfShowInactive){
        const formatInactive = (p,label)=>{
          const sameDay = p.inactiveFrom && p.inactiveTo && p.inactiveFrom === p.inactiveTo;
          let period = '';
          if(p.inactiveFrom){
            const start = niceDate(p.inactiveFrom);
            const end = p.inactiveTo && !sameDay ? '–'+niceDate(p.inactiveTo) : '';
            period = ` ${start}${end}`;
          }
          const roleText = hideRoles ? '' : ` — ${esc(p.role||'—')}`;
          return `<li>${esc(getDisplayName(p))}${roleText} [${label}${period}]</li>`;
        };
        const coHtml = listInactiveCO.length ? `<ul>${listInactiveCO.map(p=>formatInactive(p,'CO')).join('')}</ul>` : '<div class="muted">(niciun om în CO)</div>';
        const cmHtml = listInactiveCM.length ? `<ul>${listInactiveCM.map(p=>formatInactive(p,'CM')).join('')}</ul>` : '<div class="muted">(niciun om în CM)</div>';
        inactiveSectionHtml = `
          <h2>Oameni inactivi</h2>
          <h3>CO (${listInactiveCO.length})</h3>
          ${coHtml}
          <h3>CM (${listInactiveCM.length})</h3>
          ${cmHtml}
        `;
      }

      const sections = [zonesSectionHtml, roleStatsSectionHtml, summarySectionHtml, inactiveSectionHtml].filter(Boolean);
      const bodyContent = sections.length ? sections.join('') : '<div class="muted">Nicio secțiune selectată pentru raport.</div>';

      const copyrightText = `© ${currentYear} — Aplicație șantier Ticlete Gabriel`;
      return `<!DOCTYPE html><html><head><meta charset="utf-8" />
          <title>Raport zone & statistici</title>
          <style>
            :root{--accent:#2563eb;--accent-light:#dbeafe}
            body{font-family:system-ui,-apple-system,Segoe UI,Roboto; color:#0f172a; margin:24px;background:#f8fafc;padding-bottom:60px}
            h1{font-size:20px;margin:0 0 6px 0;color:var(--accent)}
          h2{font-size:16px;margin:16px 0 8px;color:#1e3a8a}
          h3{font-size:14px;margin:12px 0 4px;color:#1e3a8a}
          .muted{color:#6b7280}
          .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
          ul{list-style:none;margin:0;padding-left:0}
          .role{font-size:11px;border:1px solid #c7d2fe;border-radius:999px;padding:2px 6px;margin-left:6px;background:var(--accent-light)}
          section.zone{position:relative;break-inside:avoid;border:1px solid #c7d2fe;border-radius:8px;padding:8px;background:var(--accent-light)}
          section.zone::before{content:attr(data-helmet);position:absolute;top:4px;right:8px;font-size:18px;opacity:.8}
          table{width:100%;border-collapse:collapse}
          th,td{border:1px solid #e5e7eb;padding:6px 8px;font-size:12px}
          th{text-align:left;background:#dbeafe;color:#1e3a8a}
            footer.pageFooter{position:fixed;left:0;right:0;bottom:12px;text-align:center;font-size:11px;color:#6b7280}
            @page { size: A4; margin: 14mm; }
            @media print {
              .no-print{display:none;}
              footer.pageFooter{bottom:10mm;}
            }
          </style>
        </head><body>
          <div class="no-print" style="margin-bottom:8px;color:#6b7280">Hint: Ctrl/Cmd+P pentru a salva PDF</div>
          <h1>Raport fronturi de lucru</h1>
          <div class="muted">Data raportului: ${esc(dateStr)}</div>
        ${bodyContent}
        <footer class="pageFooter">${esc(copyrightText)}</footer>
      </body></html>`;
    }
    function exportPDF(){
      const html = buildReportHTML();
      const w = window.open('', '_blank');
      if(!w){ alert('Popup blocat. Permite deschiderea de ferestre pentru export PDF.'); return; }
      w.document.open();
      w.document.write(html);
      w.document.close();
      setTimeout(()=>{ w.focus(); w.print(); }, 300);
    }

    // ======= Data & Tabs =======
    workDate.addEventListener('change', ()=>{
      localStorage.setItem('workDate', workDate.value);
      dateLabel.textContent = niceDate(workDate.value);
      renderGantt();
      markDirty();
    });

    function activateTab(tab){
      if(!tab) tab = 'panel';
      document.querySelectorAll('.tab').forEach(btn=>{
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });
      document.querySelectorAll('.tabPanel').forEach(panel=>{
        panel.classList.toggle('active', panel.id === 'tab-'+tab);
      });
      const appEl = document.querySelector('.app');
      if(!appEl) return;
      if(tab==='chart'){
        appEl.classList.add('chart-mode');
        appEl.classList.remove('tasks-mode');
        appEl.classList.remove('reports-mode');
        renderGantt();
      } else if(tab==='tasks'){
        appEl.classList.add('tasks-mode');
        appEl.classList.remove('chart-mode');
        appEl.classList.remove('reports-mode');
        renderTasks();
      } else if(tab==='reports'){
        appEl.classList.add('reports-mode');
        appEl.classList.remove('chart-mode');
        appEl.classList.remove('tasks-mode');
        renderReports();
      } else {
        appEl.classList.remove('chart-mode');
        appEl.classList.remove('tasks-mode');
        appEl.classList.remove('reports-mode');
      }
      activeView = tab;
      const preservePending = tab === 'dashboard';
      stopDashboardAnimationCycle({ resetPending: !preservePending });
      if(tab !== 'dashboard'){
        pendingStatsAnimation = false;
      }
      if(tab === 'dashboard' && pendingStatsAnimation){
        startDashboardAnimationCycle();
      }
      scheduleInactivityMonitors();
    }

    document.querySelectorAll('.tab[data-tab]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const tab = btn.dataset.tab;
        if(!tab) return;
        if(tab === 'dashboard'){
          showLanding();
          return;
        }
        activateTab(tab);
      });
    });

    function openFullApp(targetTab){
      exitAutoFullscreen();
      stopDashboardAnimationCycle();
      pendingStatsAnimation = false;
      if(document.body.classList.contains('landing-mode')){
        document.body.classList.remove('landing-mode');
      }
      if(landingView){
        landingView.setAttribute('aria-hidden', 'true');
        landingView.setAttribute('hidden', '');
      }
      if(appShell){
        appShell.removeAttribute('aria-hidden');
        appShell.removeAttribute('hidden');
      }
      const tabToActivate = targetTab || 'panel';
      try {
        const targetHash = '#tab-' + tabToActivate;
        if(window.location.hash !== targetHash){
          history.replaceState(null, '', targetHash);
        }
      } catch(err){
        // dacă replaceState nu este disponibil, ignorăm
      }
      requestAnimationFrame(()=> activateTab(tabToActivate));
    }

    function showLanding(){
      document.body.classList.add('landing-mode');
      if(landingView){
        landingView.removeAttribute('aria-hidden');
        landingView.removeAttribute('hidden');
      }
      if(appShell){
        appShell.setAttribute('aria-hidden', 'true');
        appShell.setAttribute('hidden', '');
      }
      activateTab('dashboard');
      try {
        if(window.location.hash !== '#dashboard'){
          history.replaceState(null, '', '#dashboard');
        }
      } catch(err){
        // ignorăm erorile istoricului
      }
      renderDashboard();
      scheduleInactivityMonitors();
    }

    if(document.body.classList.contains('landing-mode')){
      showLanding();
    }

    function bindOpenAppTriggers(root = document){
      if(!root) return;
      root.querySelectorAll('[data-open-app]').forEach(btn=>{
        btn.addEventListener('click', (ev)=>{
          ev.preventDefault();
          const tab = btn.dataset.targetTab || 'panel';
          openFullApp(tab);
        });
      });
    }
    bindOpenAppTriggers();

    if(versionButton){
      versionButton.textContent = APP_VERSION;
      versionButton.title = 'Istoric versiuni și cerințe implementate';
      versionButton.addEventListener('click', (event)=>{
        event.preventDefault();
        openVersionModal();
      });
    }
    versionCloseBtn?.addEventListener('click', (event)=>{
      event.preventDefault();
      closeVersionModal();
    });
    versionModal?.addEventListener('click', (event)=>{
      if(event.target === versionModal){
        closeVersionModal();
      }
    });
    document.addEventListener('keydown', (event)=>{
      if(event.key !== 'Escape') return;
      if(versionModal && versionModal.classList.contains('show')){
        event.preventDefault();
        closeVersionModal();
        return;
      }
      if(dashboardDetailFullscreen){
        event.preventDefault();
        exitDashboardDetailFullscreen();
      }
    });

    startLandingClock();

    const passiveActivityEvents = ['mousemove','keydown','touchstart','wheel'];
    passiveActivityEvents.forEach(eventName => {
      document.addEventListener(eventName, handlePassiveActivity, { passive: true });
    });
    document.addEventListener('click', handleUserClick, false);

    document.addEventListener('fullscreenchange', ()=>{
      if(document.fullscreenElement === document.documentElement){
        autoFullscreenActive = true;
        document.body.classList.add('landing-fullscreen');
      } else if(!document.fullscreenElement){
        autoFullscreenActive = false;
        fullscreenPending = false;
        document.body.classList.remove('landing-fullscreen');
      }
    });

    function handleHashNavigation(hash){
      if(!hash) return;
      const normalized = hash.replace(/^#/, '');
      if(normalized === 'dashboard'){
        showLanding();
        return;
      }
      if(normalized === 'open-app'){
        openFullApp('panel');
        return;
      }
      if(normalized.startsWith('tab-')){
        openFullApp(normalized.slice(4));
      }
    }
    handleHashNavigation(window.location.hash);
    window.addEventListener('hashchange', ()=> handleHashNavigation(window.location.hash));

    window.addEventListener('resize', ()=>{ if(document.querySelector('.app').classList.contains('chart-mode')) renderGantt(); });

    // ======= Securitate (parolă) =======
    (function(){
      const overlay = document.getElementById('authOverlay');
      const pwdInput = document.getElementById('authPwd');
      const enterBtn = document.getElementById('authEnter');
      const cancelBtn = document.getElementById('authCancel');
      const setPwdBtn = document.getElementById('setPwdBtn');

      const DEFAULT_PWD = 'santier'; // nu e afișată în UI
      let inactivityTimer = null;

      async function sha256Hex(str){
        const enc = new TextEncoder().encode(str);
        const buf = await crypto.subtle.digest('SHA-256', enc);
        return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
      }
      async function getSavedHash(){
        let h = localStorage.getItem('appPwdHash');
        if(!h){ h = await sha256Hex(DEFAULT_PWD); localStorage.setItem('appPwdHash', h); }
        return h;
      }
      async function checkAuth(pass){
        const saved = await getSavedHash();
        const inputH = await sha256Hex(pass||'');
        return inputH === saved;
      }
      function clearInactivityTimer(){
        if(inactivityTimer){
          clearTimeout(inactivityTimer);
          inactivityTimer = null;
        }
      }
      function scheduleInactivityTimer(){
        clearInactivityTimer();
        const delay = ensurePositiveMs(passwordInactivityDelay, DEFAULT_PASSWORD_DELAY);
        if(!Number.isFinite(delay) || delay <= 0) return;
        inactivityTimer = setTimeout(()=>{
          sessionStorage.removeItem('authOK');
          pwdInput.value = '';
          showGate(true);
        }, delay);
      }
      function registerActivity(){
        if(overlay.style.display !== 'none') return;
        scheduleInactivityTimer();
      }
      function bindInactivityListeners(){
        const events = ['click','keydown','mousemove','touchstart','wheel'];
        events.forEach(type=> document.addEventListener(type, registerActivity, { passive: true }));
        window.addEventListener('focus', registerActivity);
        document.addEventListener('visibilitychange', ()=>{
          if(document.visibilityState === 'visible'){
            registerActivity();
          }
        });
      }
      function showGate(show){
        overlay.style.display = show? 'flex':'none';
        document.body.classList.toggle('locked', show);
        if(show){
          clearInactivityTimer();
          setTimeout(()=>pwdInput?.focus(), 50);
        } else {
          scheduleInactivityTimer();
        }
      }

      reschedulePasswordTimeout = ()=>{
        if(!overlay || overlay.style.display !== 'none'){
          clearInactivityTimer();
          return;
        }
        scheduleInactivityTimer();
      };
      async function ensureAuth(){
        if(sessionStorage.getItem('authOK')==='1'){ showGate(false); return; }
        showGate(true);
      }
      enterBtn?.addEventListener('click', async ()=>{
        const ok = await checkAuth(pwdInput.value);
        if(ok){ sessionStorage.setItem('authOK','1'); showGate(false); }
        else { alert('Parolă greșită.'); pwdInput.focus(); }
      });
      cancelBtn?.addEventListener('click', ()=>{ pwdInput.value=''; pwdInput.focus(); });
      pwdInput?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); enterBtn.click(); } });

      setPwdBtn?.addEventListener('click', async ()=>{
        const cur = prompt('Introdu parola curentă pentru a seta una nouă:');
        if(cur==null) return;
        const ok = await checkAuth(cur);
        if(!ok){ alert('Parola curentă nu este corectă.'); return; }
        const n1 = prompt('Noua parolă:'); if(n1==null || !n1.trim()){ alert('Parolă invalidă.'); return; }
        const n2 = prompt('Repetă noua parolă:'); if(n2!==n1){ alert('Parolele nu coincid.'); return; }
        const h = await sha256Hex(n1);
        localStorage.setItem('appPwdHash', h);
        alert('Parola a fost actualizată.');
      });

      window.addEventListener('load', ()=>{
        bindInactivityListeners();
        ensureAuth();
      });
    })();

    // ======= Before unload =======
    window.addEventListener('beforeunload', function(e){
      if(dirty){ e.preventDefault(); e.returnValue='Ai modificări nesalvate. Exportă baza de date JSON înainte de a închide pagina.'; }
    });

    // ======= Init =======
    function initDateAndRender(){
      initDate();
      render();
      persistStateToLocalStorage();
    }
    initDateAndRender();

    // footer anul curent
    document.addEventListener('DOMContentLoaded', ()=>{
      const year = new Date().getFullYear();
      [document.getElementById('cyYear'), document.getElementById('landingYear')].forEach(el=>{
        if(el) el.textContent = year;
      });
    });
  </script>

  <footer id="copyrightFooter">© <span id="cyYear"></span> — Aplicație șantier Ticlete Gabriel</footer>
</body>
</html>